name: Review Comments to Issue

on:
  pull_request:
    types: [closed]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Check if merged
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Merged: ${{ github.event.pull_request.merged }}"
          
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "PR was not merged. Exiting."
            exit 0
          fi
          
          echo "PR was merged. Continuing..."

      - name: Get PR Comments
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          echo "Fetching comments for PR #$PR_NUM"
          
          COMMENTS=$(gh pr view $PR_NUM \
            --repo ${{ github.repository }} \
            --json comments \
            -q '.comments[] | select(.authorAssociation != "OWNER") | "- @\(.author.login): \(.body | split("\n")[0])"' 2>/dev/null || echo "")
          
          echo "comments<<EOF" >> $GITHUB_ENV
          echo "$COMMENTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          COUNT=$(echo "$COMMENTS" | grep -c "@" || echo "0")
          echo "count=$COUNT" >> $GITHUB_ENV
          echo "Found $COUNT comments"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Existing Issue
        if: env.count > 0
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          EXISTING=$(gh issue list \
            --repo ${{ github.repository }} \
            --search "PR #$PR_NUM" \
            --json number \
            -q '.[0].number' 2>/dev/null || echo "")
          
          echo "existing=$EXISTING" >> $GITHUB_ENV
          if [ -n "$EXISTING" ]; then
            echo "Issue #$EXISTING already exists"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue
        if: env.count > 0 && env.existing == ''
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          
          PR_DATA=$(gh pr view $PR_NUM \
            --repo ${{ github.repository }} \
            --json title,author,mergedAt \
            -q '{t: .title, a: .author.login, m: .mergedAt}')
          
          TITLE=$(echo "$PR_DATA" | jq -r '.t')
          AUTHOR=$(echo "$PR_DATA" | jq -r '.a')
          MERGED=$(echo "$PR_DATA" | jq -r '.m // "N/A"')
          
          BODY="## PR Review Summary

**PR**: #$PR_NUM - $TITLE
**Merged**: $MERGED
**Author**: @$AUTHOR

---

### Review Comments

${{ env.comments }}
"
          
          gh issue create \
            --repo ${{ github.repository }} \
            --title "[Review] PR #$PR_NUM: $TITLE" \
            --body "$BODY" \
            --label "review,automated"
          
          echo "âœ“ Issue created successfully!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip - Already Exists
        if: env.existing != ''
        run: echo "Issue already exists for this PR"

      - name: Skip - No Comments
        if: env.count == 0
        run: echo "No review comments to process"
