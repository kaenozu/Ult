name: PR Review to Issue Processor

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: true
        type: string

jobs:
  process:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Get PR Number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch and Process PR
        run: |
          PR_NUM="${{ steps.pr.outputs.number }}"
          echo "Processing PR #$PR_NUM"
          
          # Get PR info
          PR_DATA=$(gh pr view $PR_NUM --repo ${{ github.repository }} --json number,title,author,mergedAt,comments)
          echo "PR Data received"
          
          # Extract comments from non-owners
          COMMENTS=$(echo "$PR_DATA" | gh pr view $PR_NUM --repo ${{ github.repository }} --json comments -q '.comments[] | select(.authorAssociation != "OWNER") | "- @\(.author.login): \(.body | split("\n")[0])"' 2>/dev/null || echo "")
          
          COMMENT_COUNT=$(echo "$COMMENTS" | grep -c "@" || echo "0")
          echo "Found $COMMENT_COUNT review comments"
          
          if [ "$COMMENT_COUNT" -gt "0" ]; then
            # Get PR details
            PR_TITLE=$(echo "$PR_DATA" | gh pr view $PR_NUM --repo ${{ github.repository }} --json title -q '.title')
            PR_AUTHOR=$(echo "$PR_DATA" | gh pr view $PR_NUM --repo ${{ github.repository }} --json author -q '.author.login')
            
            # Create issue
            ISSUE_BODY="## PR Review Summary

**PR**: #$PR_NUM - $PR_TITLE
**Author**: @$PR_AUTHOR

### Review Comments

$COMMENTS
"
            
            gh issue create \
              --repo ${{ github.repository }} \
              --title "[Review] PR #$PR_NUM: $PR_TITLE" \
              --body "$ISSUE_BODY" \
              --label "review,automated"
            
            echo "âœ“ Issue created successfully"
          else
            echo "No review comments to process"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
