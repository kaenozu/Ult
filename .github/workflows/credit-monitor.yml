name: Code Review Credit Monitor

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  credit-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Check for Low Credit Issues
        id: check-issues
        run: |
          # Check if there's already an open issue about credits
          EXISTING_ISSUE=$(gh issue list \
            --repo ${{ github.repository }} \
            --state open \
            --search "code review credit in:title" \
            --json number \
            --jq '.[0].number' || echo "")
          
          echo "existing_issue=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Weekly Credit Reminder
        if: steps.check-issues.outputs.existing_issue == ''
        run: |
          TODAY=$(date +%Y-%m-%d)
          
          # Create a reminder to check credit status
          cat > /tmp/credit_reminder.md << 'EOF'
## ğŸ“Š Weekly Code Review Credit Status Check

**Date**: $TODAY

### Action Items

- [ ] Check `chatgpt-codex-connector` credit balance
- [ ] Verify low-credit alerts are configured
- [ ] Review last week's credit consumption
- [ ] Confirm automated reviews are functioning

### Quick Check Steps

1. **Access Settings**
   - Go to [Repository Settings](https://github.com/${{ github.repository }}/settings)
   - Navigate to: Code security and analysis â†’ Third-party apps

2. **Review Credit Status**
   - Current balance: _____ credits
   - Last week's usage: _____ credits
   - Projected end date: _____

3. **Verify Alerts**
   - Low credit warnings enabled: [ ]
   - Alert threshold set to 20%: [ ]
   - Notification emails configured: [ ]

### Recommended Actions

If credits are below 100:
1. Add more credits immediately
2. See [CODE_REVIEW_SETUP.md](.github/CODE_REVIEW_SETUP.md)
3. Consider implementing credit optimization strategies

If credits are healthy:
- âœ… No action needed
- Close this issue

### Resources

- [Code Review Setup Guide](.github/CODE_REVIEW_SETUP.md)
- [Admin Action Guide](.github/ADMIN_ACTION_REQUIRED.md)
- [Previous Credit Issue](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+label%3Acode-review-credits)

---

*This is an automated weekly reminder. Close this issue after reviewing.*
*To disable these reminders, disable the `credit-monitor.yml` workflow.*
EOF
          
          # Create the issue
          gh issue create \
            --repo ${{ github.repository }} \
            --title "ğŸ“Š Weekly Code Review Credit Status Check - $TODAY" \
            --body-file /tmp/credit_reminder.md \
            --label "code-review-credits,admin" \
            || echo "Failed to create reminder issue"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Report Status
        run: |
          echo "âœ… Credit monitoring check completed"
          if [ -n "${{ steps.check-issues.outputs.existing_issue }}" ]; then
            echo "â„¹ï¸  Existing credit issue #${{ steps.check-issues.outputs.existing_issue }} is still open"
          else
            echo "ğŸ“Š New weekly reminder created"
          fi
