# Repository Size Check Workflow
name: Repository Size Check

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Mondays
  workflow_dispatch:

jobs:
  check-size:
    name: Check Repository Size
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check repository size
        id: size
        run: |
          GIT_SIZE=$(du -sm .git | cut -f1)
          TOTAL_SIZE=$(du -sm . | cut -f1)
          echo "git_size=${GIT_SIZE}" >> $GITHUB_OUTPUT
          echo "total_size=${TOTAL_SIZE}" >> $GITHUB_OUTPUT
          echo "üì¶ Repository Size"
          echo ".git: ${GIT_SIZE}MB"
          echo "Total: ${TOTAL_SIZE}MB"
          [ "$GIT_SIZE" -gt 500 ] && echo "warning=true" >> $GITHUB_OUTPUT || echo "warning=false" >> $GITHUB_OUTPUT

      - name: Find large files
        if: steps.size.outputs.warning == 'true'
        run: |
          echo "üîç Large files in history:"
          git rev-list --objects --all | \
            git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' | \
            sed -n 's/^blob //p' | sort -rn -k2 | head -20 | \
            while read hash size path; do
              echo "  $((size/1048576))MB - $path"
            done

      - name: Create issue if needed
        if: steps.size.outputs.warning == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'repository-size'
            });
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Repository size exceeds threshold (${{ steps.size.outputs.git_size }}MB)`,
                body: `## Repository Size Alert\n\n- .git directory: ${{ steps.size.outputs.git_size }}MB\n- Total: ${{ steps.size.outputs.total_size }}MB\n- Threshold: 500MB\n\nConsider cleaning up large files from git history.`,
                labels: ['repository-size', 'maintenance', 'automated']
              });
            }
