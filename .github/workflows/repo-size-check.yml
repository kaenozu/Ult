name: Repository Size Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

jobs:
  check-repo-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate size check

      - name: Check repository size
        id: size_check
        run: |
          echo "Checking repository size..."
          
          # Get .git directory size
          GIT_SIZE=$(du -sm .git | cut -f1)
          echo "git_size=${GIT_SIZE}" >> $GITHUB_OUTPUT
          
          # Get total repository size
          TOTAL_SIZE=$(du -sm . | cut -f1)
          echo "total_size=${TOTAL_SIZE}" >> $GITHUB_OUTPUT
          
          echo "ÔøΩÔøΩ Repository Size Report"
          echo "========================="
          echo ".git directory: ${GIT_SIZE}MB"
          echo "Total size: ${TOTAL_SIZE}MB"
          
          # Warning threshold: 500MB for .git
          if [ "$GIT_SIZE" -gt 500 ]; then
            echo "‚ö†Ô∏è WARNING: .git directory is larger than 500MB"
            echo "warning=true" >> $GITHUB_OUTPUT
          else
            echo "‚úì Repository size is within acceptable limits"
            echo "warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Find large files
        if: steps.size_check.outputs.warning == 'true'
        run: |
          echo "üîç Finding large files in repository history..."
          git rev-list --objects --all |
            git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' |
            sed -n 's/^blob //p' |
            sort --numeric-sort --key=2 --reverse |
            head -n 20 |
            while read hash size path; do
              size_mb=$(echo "scale=2; $size / 1048576" | bc)
              echo "  ${size_mb}MB - $path"
            done

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.size_check.outputs.warning == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const gitSize = ${{ steps.size_check.outputs.git_size }};
            const totalSize = ${{ steps.size_check.outputs.total_size }};
            
            const comment = `## ‚ö†Ô∏è Repository Size Warning
            
            The .git directory size is **${gitSize}MB**, which exceeds the recommended 500MB threshold.
            
            **Repository Statistics:**
            - .git directory: ${gitSize}MB
            - Total size: ${totalSize}MB
            
            **Recommendations:**
            1. Review the large files listed in the CI logs
            2. Consider using \`git filter-repo\` to remove large files from history
            3. Ensure .gitignore is properly configured
            4. Use Git LFS for large binary files
            
            See the workflow logs for a list of the largest files in the repository history.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create issue if size exceeds threshold
        if: github.event_name == 'schedule' && steps.size_check.outputs.warning == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const gitSize = ${{ steps.size_check.outputs.git_size }};
            const totalSize = ${{ steps.size_check.outputs.total_size }};
            
            const title = `[Automated] Repository size exceeds threshold (${gitSize}MB)`;
            const body = `## Repository Size Alert
            
            This automated issue was created because the repository size has exceeded the recommended threshold.
            
            **Current Size:**
            - .git directory: ${gitSize}MB
            - Total size: ${totalSize}MB
            - Threshold: 500MB
            
            **Action Required:**
            1. Review the workflow logs to identify large files
            2. Clean up unnecessary large files from git history
            3. Update .gitignore to prevent future issues
            4. Consider implementing Git LFS for large binary files
            
            **Related Issues:**
            - Check for related cleanup issues
            - Review [issue #315](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/315) for more context
            `;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'repository-size'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['repository-size', 'maintenance', 'automated']
              });
            }
