# Database Schema Validation Workflow
name: Database Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'db/**'
      - 'trading-platform/app/lib/api/idb-migrations.ts'
      - '.github/workflows/db-validation.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'db/**'
      - 'trading-platform/app/lib/api/idb-migrations.ts'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  validate:
    name: Validate Migrations
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: trading-platform/package-lock.json

      - name: Install dependencies
        working-directory: ./trading-platform
        run: npm ci

      - name: Validate SQL migrations
        working-directory: ./trading-platform
        run: npm run db:migrate:validate

      - name: Check migration numbering
        run: |
          cd db/migrations
          expected=1
          for file in *.sql; do
            actual=$(echo "$file" | grep -oE '^[0-9]+' | sed 's/^0*//')
            if [ "$actual" != "$expected" ]; then
              echo "❌ Migration numbering error: Expected $expected, found $actual in $file"
              exit 1
            fi
            expected=$((expected + 1))
          done
          echo "✅ All migrations numbered correctly"

      - name: Verify documentation
        run: |
          [ -f db/docs/DATABASE.md ] || (echo "❌ DATABASE.md missing" && exit 1)
          [ -f db/README.md ] || (echo "❌ db/README.md missing" && exit 1)
          echo "✅ Documentation verified"
