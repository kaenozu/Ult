name: Database Schema Validation

on:
  pull_request:
    paths:
      - 'db/**'
      - 'trading-platform/app/lib/api/idb-migrations.ts'
      - '.github/workflows/db-validation.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'db/**'
      - 'trading-platform/app/lib/api/idb-migrations.ts'

jobs:
  validate-migrations:
    name: Validate Database Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: trading-platform/package-lock.json

      - name: Validate SQL migrations
        run: |
          cd trading-platform
          npm run db:migrate:validate

      - name: Check migration numbering
        run: |
          cd db/migrations
          expected=1
          for file in *.sql; do
            actual=$(echo "$file" | grep -oE '^[0-9]+' | sed 's/^0*//')
            if [ "$actual" != "$expected" ]; then
              echo "❌ Migration numbering error: Expected $expected, found $actual in $file"
              exit 1
            fi
            expected=$((expected + 1))
          done
          echo "✅ All migrations are numbered sequentially"

      - name: Validate TypeScript syntax
        run: |
          cd trading-platform
          # Check if files can be parsed
          node -e "
            const fs = require('fs');
            const files = [
              'app/lib/api/idb-migrations.ts',
              'app/lib/api/__tests__/idb-migrations.test.ts'
            ];
            let hasErrors = false;
            files.forEach(file => {
              try {
                const content = fs.readFileSync(file, 'utf-8');
                const open = (content.match(/{/g) || []).length;
                const close = (content.match(/}/g) || []).length;
                if (open !== close) {
                  console.log('❌', file, 'has unbalanced braces');
                  hasErrors = true;
                } else {
                  console.log('✅', file);
                }
              } catch (error) {
                console.log('❌', file, error.message);
                hasErrors = true;
              }
            });
            if (hasErrors) process.exit(1);
          "

      - name: Check schema documentation
        run: |
          if [ ! -f db/docs/DATABASE.md ]; then
            echo "❌ DATABASE.md is missing"
            exit 1
          fi
          
          if [ ! -f db/README.md ]; then
            echo "❌ db/README.md is missing"
            exit 1
          fi
          
          echo "✅ Documentation files exist"

      - name: Validate Prisma schema (if PostgreSQL is configured)
        run: |
          if [ -f db/schema.prisma ]; then
            echo "Prisma schema found, validating..."
            # This would validate Prisma schema in future when Prisma is set up
            echo "✅ Prisma schema exists (validation will be added when Prisma is fully configured)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Database Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Migration validation completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ TypeScript syntax validated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Documentation verified" >> $GITHUB_STEP_SUMMARY
