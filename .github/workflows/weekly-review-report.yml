name: Weekly Review Report

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Generate Report
        run: |
          echo "Generating weekly report..."
          
          # Get open review issues
          OPEN_ISSUES=$(gh issue list --repo ${{ github.repository }} --search "[Review] in:title state:open" --json number,title -q '.[] | "- #\(.number): \(.title)"' 2>/dev/null || echo "None")
          OPEN_COUNT=$(echo "$OPEN_ISSUES" | grep -c "^-" || echo "0")
          
          # Get recently merged PRs (last 7 days)
          SINCE_DATE=$(date -d '7 days ago' +%Y-%m-%d)
          MERGED_PRS=$(gh pr list --repo ${{ github.repository }} --state merged --json number,title,mergedAt -q ".[] | select(.mergedAt >= \"$SINCE_DATE\") | \"- #\(.number): \(.title)\"" 2>/dev/null || echo "None")
          PR_COUNT=$(echo "$MERGED_PRS" | grep -c "^-" || echo "0")
          
          TODAY=$(date +%Y-%m-%d)
          
          # Create report using printf
          printf '## ðŸ“Š Weekly Review Report - %s\n\n' "$TODAY" > /tmp/report_body.md
          printf '### Summary\n' >> /tmp/report_body.md
          printf '* **Open Review Issues**: %s\n' "$OPEN_COUNT" >> /tmp/report_body.md
          printf '* **Recently Merged PRs**: %s\n\n' "$PR_COUNT" >> /tmp/report_body.md
          printf '### Open Review Issues\n%s\n\n' "$OPEN_ISSUES" >> /tmp/report_body.md
          printf '### Recently Merged PRs (Last 7 Days)\n%s\n\n' "$MERGED_PRS" >> /tmp/report_body.md
          printf '---\n*Generated automatically by GitHub Actions*\n' >> /tmp/report_body.md
          
          # Create issue
          gh issue create --repo ${{ github.repository }} --title "ðŸ“Š Weekly Review Report - $TODAY" --body-file /tmp/report_body.md || echo "Issue creation failed"
          echo "âœ… Report creation attempted"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
