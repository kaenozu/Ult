name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  lint:
    name: Lint & Type Check
    uses: ./.github/workflows/lint.yml
    permissions:
      contents: read

  test:
    name: Unit Tests
    uses: ./.github/workflows/test.yml
    permissions:
      contents: read

  build:
    name: Build
    uses: ./.github/workflows/build.yml
    permissions:
      contents: read

  backend-test:
    name: Backend Tests
    uses: ./.github/workflows/backend.yml
    permissions:
      contents: read

  e2e:
    name: E2E Tests
    needs: [lint, test, build]
    uses: ./.github/workflows/e2e.yml
    secrets: inherit
    permissions:
      contents: read

  security:
    name: Security Scan
    uses: ./.github/workflows/security.yml
    secrets: inherit
    permissions:
      contents: read

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test, build, backend-test, e2e, security]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Check all jobs status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Backend Test: ${{ needs.backend-test.result }}"
          echo "E2E: ${{ needs.e2e.result }}"
          echo "Security: ${{ needs.security.result }}"
          
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.backend-test.result }}" != "success" ] || \
             [ "${{ needs.e2e.result }}" != "success" ]; then
            echo "❌ CI failed"
            exit 1
          fi
          
          echo "✅ All CI checks passed"
