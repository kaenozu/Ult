name: PR Review to Issue

on:
  pull_request:
    types: [closed]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - run: echo "PR #${{ github.event.pull_request.number }} closed"
      - run: echo "Merged=${{ github.event.pull_request.merged }}"
      - name: Create issue if has comments
        if: github.event.pull_request.merged == true
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          COMMENTS=$(gh pr view $PR_NUM --repo ${{ github.repository }} --json comments -q '.comments[] | select(.authorAssociation != "OWNER") | "- @\(.author.login): \(.body)"' 2>/dev/null || echo "")
          if [ -n "$COMMENTS" ]; then
            PR_TITLE=$(gh pr view $PR_NUM --repo ${{ github.repository }} --json title -q '.title')
            gh issue create --repo ${{ github.repository }} --title "[Review] PR #$PR_NUM: $PR_TITLE" --body "$COMMENTS" --label "review"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
