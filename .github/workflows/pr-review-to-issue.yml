name: Convert PR Review Comments to Issue

on:
  pull_request:
    types: [closed]

jobs:
  create-issue-from-review:
    # Only run when PR is merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Get PR Number
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "Processing PR #${{ github.event.pull_request.number }}"

      - name: Get PR Review Comments
        id: comments
        run: |
          PR_NUM=${{ steps.pr-info.outputs.pr_number }}
          
          # Get review comments (not just PR body comments)
          # Filter out OWNER and COLLABORATOR (likely the PR author)
          COMMENTS=$(gh pr view $PR_NUM \
            --repo ${{ github.repository }} \
            --json comments \
            -q '.comments[] | select(.authorAssociation != "OWNER" and .authorAssociation != "COLLABORATOR") | "- **@\(.author.login)**: \(.body | split("\n")[0])"' 2>/dev/null || echo "")
          
          COMMENT_COUNT=$(echo "$COMMENTS" | grep -c "@" || echo "0")
          echo "Found $COMMENT_COUNT review comments"
          echo "comment_count=$COMMENT_COUNT" >> $GITHUB_OUTPUT
          
          # Escape for JSON
          COMMENTS_ESCAPED=$(echo "$COMMENTS" | jq -Rs .)
          echo "comments=$COMMENTS_ESCAPED" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Existing Issue
        id: check-issue
        run: |
          PR_NUM=${{ steps.pr-info.outputs.pr_number }}
          
          # Search for existing issue with similar title
          EXISTING=$(gh issue list \
            --repo ${{ github.repository }} \
            --search "PR #$PR_NUM" \
            --limit 1 \
            --json number \
            -q '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "existing_issue=$EXISTING" >> $GITHUB_OUTPUT
            echo "Issue #$EXISTING already exists for this PR"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing issue found"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue
        if: steps.comments.outputs.comment_count > 0 && steps.check-issue.outputs.exists == 'false'
        run: |
          # Get comments (already escaped)
          COMMENTS='${{ steps.comments.outputs.comments }}'
          COMMENTS_UNESCAPED=$(echo "$COMMENTS" | jq -r .)
          PR_NUM=${{ steps.pr-info.outputs.pr_number }}
          
          # Get PR info (use mergedAt instead of merged)
          PR_INFO=$(gh pr view $PR_NUM \
            --repo ${{ github.repository }} \
            --json title,author,mergedAt \
            -q '{title: .title, author: .author.login, mergedAt: .mergedAt}')
          
          PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author')
          PR_MERGED=$(echo "$PR_INFO" | jq -r '.mergedAt // "N/A"')
          
          # Build issue body
          ISSUE_BODY="## PR Review Summary

**PR**: #$PR_NUM - $PR_TITLE
**Merged**: $PR_MERGED
**Author**: @$PR_AUTHOR

---

### Review Comments

$COMMENTS_UNESCAPED
"
          
          # Create issue
          gh issue create \
            --repo ${{ github.repository }} \
            --title "[Review] PR #$PR_NUM: $PR_TITLE" \
            --body "$ISSUE_BODY" \
            --label "review,automated"
          
          echo "✓ Issue created successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issue Already Exists
        if: steps.check-issue.outputs.exists == 'true'
        run: |
          echo "✓ Issue already exists for this PR, skipping creation"

      - name: No Comments Found
        if: steps.comments.outputs.comment_count == 0
        run: echo "No review comments found, skipping issue creation"
