name: Convert PR Review Comments to Issue

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (for manual testing)'
        required: true
        default: '1'
        type: string

jobs:
  create-issue-from-review:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Determine PR Number
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.pr_number }}" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get PR Review Comments
        id: comments
        run: |
          PR_NUM=${{ steps.pr-info.outputs.pr_number }}
          
          # Get review comments (not just PR body comments)
          # Filter out OWNER and COLLABORATOR (likely the PR author)
          COMMENTS=$(gh pr view $PR_NUM \
            --repo ${{ github.repository }} \
            --json comments \
            -q '.comments[] | select(.authorAssociation != "OWNER" and .authorAssociation != "COLLABORATOR") | "- **@\(.author.login)**: \(.body | split("\n")[0])"' 2>/dev/null || echo "")
          
          COMMENT_COUNT=$(echo "$COMMENTS" | grep -c "@" || echo "0")
          echo "comment_count=$COMMENT_COUNT" >> $GITHUB_OUTPUT
          # Escape for JSON
          COMMENTS_ESCAPED=$(echo "$COMMENTS" | jq -Rs .)
          echo "comments=$COMMENTS_ESCAPED" >> $GITHUB_OUTPUT

      - name: Check for Existing Issue
        id: check-issue
        run: |
          PR_NUM=${{ steps.pr-info.outputs.pr_number }}
          
          # Search for existing issue with similar title
          EXISTING=$(gh issue list \
            --repo ${{ github.repository }} \
            --search "PR #$PR_NUM" \
            --limit 1 \
            --json number,title \
            -q '.[0] | {number: .number, title: .title}' 2>/dev/null || echo "null")
          
          if [ "$EXISTING" != "null" ] && [ -n "$EXISTING" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "existing_issue=$EXISTING" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue
        if: steps.comments.outputs.comment_count > 0 && steps.check-issue.outputs.exists == 'false'
        run: |
          # Get comments (already escaped)
          COMMENTS='${{ steps.comments.outputs.comments }}'
          COMMENTS_UNESCAPED=$(echo "$COMMENTS" | jq -r .)
          PR_NUM=${{ steps.pr-info.outputs.pr_number }}
          
          # Get PR info
          PR_INFO=$(gh pr view $PR_NUM \
            --repo ${{ github.repository }} \
            --json title,user,mergedAt \
            -q '{title: .title, author: .user.login, mergedAt: .mergedAt}')
          
          PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author')
          PR_MERGED=$(echo "$PR_INFO" | jq -r '.mergedAt // "N/A"')
          
          # Build issue body
          ISSUE_BODY="## PR Review Summary
          
**PR**: #$PR_NUM - $PR_TITLE
**Merged**: $PR_MERGED
**Author**: @$PR_AUTHOR

---

### Review Comments

$COMMENTS_UNESCAPED
"
          
          # Create issue
          gh issue create \
            --repo ${{ github.repository }} \
            --title "[Review] PR #$PR_NUM: $PR_TITLE" \
            --body "$ISSUE_BODY" \
            --label "review,automated"
          
          echo "Issue created successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issue Already Exists
        if: steps.check-issue.outputs.exists == 'true'
        run: |
          echo "Issue already exists for this PR, skipping creation"

      - name: No Comments Found
        if: steps.comments.outputs.comment_count == 0
        run: echo "No review comments found, skipping issue creation"
