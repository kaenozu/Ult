name: Process All Review Comments

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:

jobs:
  process-comments:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Initialize Summary
        run: |
          echo "processed=0" >> $GITHUB_ENV
          echo "created=0" >> $GITHUB_ENV
          echo "skipped=0" >> $GITHUB_ENV
          echo "errors=0" >> $GITHUB_ENV

      - name: Get Recently Merged PRs
        id: prs
        run: |
          echo "Fetching merged PRs from last 7 days..."
          
          SINCE_DATE=$(date -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)
          
          MERGED_PRS=$(gh pr list \
            --repo ${{ github.repository }} \
            --state merged \
            --limit 100 \
            --json number,mergedAt \
            -q '.[] | select(.mergedAt >= "'$SINCE_DATE'") | .number' 2>/dev/null || echo "")
          
          PR_COUNT=$(echo "$MERGED_PRS" | grep -c . || echo "0")
          echo "Found $PR_COUNT merged PRs"
          
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$MERGED_PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$PR_COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Process Each PR
        run: |
          PROCESSED=0
          CREATED=0
          SKIPPED=0
          ERRORS=0
          
          while IFS= read -r pr_num; do
            [ -z "$pr_num" ] && continue
            
            PROCESSED=$((PROCESSED + 1))
            echo ""
            echo "[$PROCESSED/${{ steps.prs.outputs.count }}] Processing PR #$pr_num..."
            
            # Check if issue already exists (search in body)
            EXISTING=$(gh issue list \
              --repo ${{ github.repository }} \
              --search "PR #$pr_num in:body" \
              --state all \
              --json number \
              -q '.[0].number' 2>/dev/null || echo "")
            
            if [ -n "$EXISTING" ]; then
              echo "  âœ“ Issue #$EXISTING already exists"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi
            
            # Get review comments (exclude owner)
            COMMENTS=$(gh pr view $pr_num \
              --repo ${{ github.repository }} \
              --json comments \
              -q '.comments[] | select(.authorAssociation != "OWNER") | "- @\(.author.login): \(.body | split("\n")[0] | .[0:100])..."' 2>/dev/null || echo "")
            
            COMMENT_COUNT=$(echo "$COMMENTS" | grep -c "@" || echo "0")
            echo "  Found $COMMENT_COUNT review comments"
            
            if [ "$COMMENT_COUNT" -gt "0" ]; then
              # Get PR info
              PR_INFO=$(gh pr view $pr_num \
                --repo ${{ github.repository }} \
                --json title,author,mergedAt \
                -q '{t: .title, a: .author.login, m: .mergedAt}' 2>/dev/null || echo "")
              
              if [ -z "$PR_INFO" ]; then
                echo "  âœ— Failed to get PR info"
                ERRORS=$((ERRORS + 1))
                continue
              fi
              
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.t')
              PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.a')
              PR_MERGED=$(echo "$PR_INFO" | jq -r '.m // "N/A"')
              
              # Create issue
              cat > /tmp/issue_body.txt << EOF
## PR Review Summary

**PR**: #$pr_num - $PR_TITLE
**Merged**: $PR_MERGED
**Author**: @$PR_AUTHOR

---

### Review Comments

$COMMENTS

---

*Automatically created by GitHub Actions*
EOF
              
              if gh issue create \
                --repo ${{ github.repository }} \
                --title "[Review] PR #$pr_num: $PR_TITLE" \
                --body-file /tmp/issue_body.txt 2>/dev/null; then
                echo "  âœ“ Created issue for PR #$pr_num"
                CREATED=$((CREATED + 1))
              else
                echo "  âœ— Failed to create issue"
                ERRORS=$((ERRORS + 1))
              fi
            else
              echo "  - No review comments"
            fi
          done <<< "${{ steps.prs.outputs.prs }}"
          
          echo ""
          echo "========================================"
          echo "Processing Summary"
          echo "========================================"
          echo "Total PRs processed: $PROCESSED"
          echo "Issues created: $CREATED"
          echo "Skipped (already exists): $SKIPPED"
          echo "Errors: $ERRORS"
          echo "========================================"
          
          echo "processed=$PROCESSED" >> $GITHUB_ENV
          echo "created=$CREATED" >> $GITHUB_ENV
          echo "skipped=$SKIPPED" >> $GITHUB_ENV
          echo "errors=$ERRORS" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report Status
        if: always()
        run: |
          echo ""
          echo "ðŸ“Š Workflow Complete"
          echo "   Processed: ${{ env.processed }} PRs"
          echo "   Created: ${{ env.created }} issues"
          echo "   Skipped: ${{ env.skipped }} PRs"
          echo "   Errors: ${{ env.errors }}"
