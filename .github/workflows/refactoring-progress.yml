# Refactoring Progress Tracker
# Manual workflow to track refactoring metrics
name: Refactoring Progress

on:
  workflow_dispatch:

jobs:
  track-metrics:
    name: Track Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'trading-platform/package-lock.json'

      - name: Install dependencies
        working-directory: trading-platform
        run: npm ci

      - name: Collect metrics
        id: metrics
        working-directory: trading-platform
        run: |
          ANY_COUNT=$(grep -r "\bany\b" app/lib/**/*.ts app/components/**/*.tsx 2>/dev/null | grep -v "// @ts-" | wc -l || echo "0")
          AVG_SIZE=$(find app/lib -name "*.ts" -exec wc -l {} \; 2>/dev/null | awk '{sum+=$1; count++} END {if(count>0) print int(sum/count); else print "0"}')
          MAX_COMPONENT=$(find app/components -name "*.tsx" -exec wc -l {} \; 2>/dev/null | awk '{print $1}' | sort -rn | head -1 || echo "0")
          echo "any_count=$ANY_COUNT" >> $GITHUB_OUTPUT
          echo "avg_size=$AVG_SIZE" >> $GITHUB_OUTPUT
          echo "max_component=$MAX_COMPONENT" >> $GITHUB_OUTPUT

      - name: TypeScript check
        id: typecheck
        working-directory: trading-platform
        continue-on-error: true
        run: |
          if npx tsc --noEmit 2>&1 | tee /tmp/tsc.log; then
            echo "status=passing" >> $GITHUB_OUTPUT
          else
            echo "status=failing" >> $GITHUB_OUTPUT
          fi

      - name: Generate report
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # Refactoring Metrics

          | Metric | Value | Target | Status |
          |--------|-------|--------|--------|
          | \'any\' type usage | ${{ steps.metrics.outputs.any_count }} | 0 | ${{ steps.metrics.outputs.any_count == '0' && 'âœ…' || 'ðŸ”´' }} |
          | Avg file size (lib) | ${{ steps.metrics.outputs.avg_size }} lines | â‰¤200 | ${{ steps.metrics.outputs.avg_size <= 200 && 'âœ…' || 'ðŸ”´' }} |
          | Max component size | ${{ steps.metrics.outputs.max_component }} lines | â‰¤300 | ${{ steps.metrics.outputs.max_component <= 300 && 'âœ…' || 'ðŸ”´' }} |
          | TypeScript strict | ${{ steps.typecheck.outputs.status }} | passing | ${{ steps.typecheck.outputs.status == 'passing' && 'âœ…' || 'ðŸ”´' }} |
          EOF
