# リファクタリング統合ロードマップ - 進捗管理

**作成日**: 2026-02-02  
**プロジェクト**: ULT Trading Platform  
**Issue**: kaenozu/Ult#532 [REFACTOR-ROADMAP]

---

## 📊 現状分析（Baseline Metrics）

### コード品質メトリクス

| メトリクス | 現在値 | 目標値 | 状態 |
|-----------|--------|--------|------|
| TypeScript strict mode | ✅ Enabled | ✅ Enabled | ✅ |
| any型使用箇所 | ~114件 | 0件 | 🔴 |
| 平均ファイル行数 (lib) | 374行 | 200行以下 | 🔴 |
| 最大コンポーネントサイズ | 853行 | 300行以下 | 🔴 |
| テストカバレッジ | 推定45% | 80% | 🟡 |

### 問題のあるファイル（リファクタリング優先度順）

#### 超大型コンポーネント（800行以上）
1. **StrategyDashboard.tsx** (853行) - 戦略管理UI
2. **RiskDashboard.tsx** (796行) - リスク管理UI
3. **BacktestResultsDashboard.tsx** (704行) - バックテスト結果表示

#### 大型コンポーネント（600-800行）
4. **TradingPsychologyDashboard.tsx** (671行) - 心理分析UI
5. **DataQualityPanel.tsx** (615行) - データ品質パネル

---

## 🎯 Phase 1: 基盤構築（優先度: High）

### REFACTOR-001: 定数・設定の一元管理

**関連Issue**: kaenozu/Ult#522  
**優先度**: High  
**複雑さ**: Medium  
**推定工数**: 4-6時間

#### タスク

- [x] **1.1 定数ファイル構造の作成**
  - [x] `app/constants/index.ts` - メインエクスポート
  - [x] `app/constants/trading.ts` - 取引関連定数
  - [x] `app/constants/chart.ts` - チャート関連定数
  - [x] `app/constants/technical.ts` - テクニカル指標定数
  - [x] `app/constants/api.ts` - API関連定数
  - [x] `app/constants/ui.ts` - UI関連定数

- [x] **1.2 ハードコードされた値の移行**
  - [x] チャート設定（期間、色、サイズ等）
  - [x] テクニカル指標パラメータ（SMA期間、RSI閾値等）
  - [x] API設定（タイムアウト、リトライ回数等）
  - [x] UIコンポーネント設定
  - [x] すべてのインポートパスを更新（70+ファイル）
  - [x] ドキュメント内の古い参照を更新
  - Note: `app/lib/constants` を `app/constants` に統合しました。

- [ ] **1.3 環境変数の型安全な管理**
  - [ ] `app/config/env.ts` - 環境変数型定義
  - [ ] Zodによるバリデーション追加
  - [ ] 環境変数チェッカーの実装

#### 成功指標
- ✅ 全ての魔法の数値が定数ファイルに集約
- ✅ 環境変数が型安全にアクセス可能
- ✅ ビルド時に設定エラーを検出可能

---

### REFACTOR-002: 型安全性の向上

**関連Issue**: kaenozu/Ult#523  
**優先度**: High  
**複雑さ**: High  
**推定工数**: 8-10時間

#### タスク

- [ ] **2.1 any型の検出と分類**
  - [ ] 全any型使用箇所のリスト作成（~114件）
  - [ ] 優先度付け（Critical/High/Medium/Low）
  - [ ] 置換戦略の決定

- [ ] **2.2 型ガード関数の作成**
  - [ ] `app/lib/typeGuards.ts` - 共通型ガード
  - [ ] API レスポンス型ガード
  - [ ] Chart.js型ガード
  - [ ] イベント型ガード

- [ ] **2.3 Critical箇所の型付け**
  - [ ] APIクライアント（UnifiedApiClient等）
  - [ ] データ処理パイプライン
  - [ ] チャートコンポーネント

- [ ] **2.4 型定義の整理**
  - [ ] 重複型定義の統合
  - [ ] 共通型の `types/shared.ts` への集約
  - [ ] 型エイリアスの適切な使用

#### 成功指標
- ✅ Critical箇所のany型使用が0件
- ✅ 型ガード関数により安全な型絞り込みが可能
- ✅ TypeScript --strict モードでエラーなし

---

### REFACTOR-008: エラーハンドリングの統一

**関連Issue**: kaenozu/Ult#528  
**優先度**: High  
**複雑さ**: Low  
**推定工数**: 3-4時間

#### タスク

- [ ] **8.1 統一エラークラスの作成**
  - [ ] `app/lib/errors/AppError.ts` - ベースエラークラス
  - [ ] `app/lib/errors/ApiError.ts` - API関連エラー
  - [ ] `app/lib/errors/ValidationError.ts` - バリデーションエラー
  - [ ] `app/lib/errors/index.ts` - エクスポート

- [ ] **8.2 エラーハンドリングユーティリティ**
  - [ ] `handleError()` - 統一エラーハンドラ
  - [ ] `wrapAsync()` - 非同期関数ラッパー
  - [ ] `withRetry()` - リトライロジック

- [ ] **8.3 エラー表示コンポーネント**
  - [ ] `ErrorBoundary` の強化
  - [ ] `ErrorToast` コンポーネント
  - [ ] エラーログ収集の実装

- [ ] **8.4 既存コードの移行**
  - [ ] API呼び出し箇所のエラーハンドリング統一
  - [ ] コンポーネントエラーハンドリング統一

#### 成功指標
- ✅ 全API呼び出しが統一エラーハンドリングを使用
- ✅ ユーザーにわかりやすいエラーメッセージ表示
- ✅ エラーログが構造化され収集可能

---

## 🏗️ Phase 2: アーキテクチャ改善

### REFACTOR-005: サービス層の責務分離

**関連Issue**: kaenozu/Ult#525  
**優先度**: High  
**複雑さ**: High  
**推定工数**: 10-12時間

#### タスク

- [ ] **5.1 サービス層の設計**
  - [ ] 依存性注入（DI）パターンの導入
  - [ ] インターフェース定義
  - [ ] サービスファクトリーの作成

- [ ] **5.2 既存サービスのリファクタリング**
  - [ ] MarketDataService の責務分離
  - [ ] TechnicalIndicatorService の最適化
  - [ ] AnalysisService の再構築

- [ ] **5.3 テスタビリティの向上**
  - [ ] モックサービスの作成
  - [ ] テストヘルパーの実装

#### 成功指標
- ✅ 各サービスの責務が明確
- ✅ 依存関係が注入可能
- ✅ 単体テストが容易

---

### REFACTOR-006: データパイプラインの整理

**関連Issue**: kaenozu/Ult#526  
**優先度**: High  
**複雑さ**: Medium  
**推定工数**: 6-8時間

#### タスク

- [ ] **6.1 データフローの可視化**
  - [ ] 現状のデータフロー図作成
  - [ ] ボトルネック特定

- [ ] **6.2 パイプライン最適化**
  - [ ] 不要な中間処理の削除
  - [ ] キャッシュ戦略の見直し
  - [ ] バッチ処理の導入

- [ ] **6.3 並列処理の最適化**
  - [ ] Web Worker活用の拡大
  - [ ] Promise.all の適切な使用

#### 成功指標
- ✅ データ処理時間が30%以上削減
- ✅ メモリ使用量の最適化
- ✅ パイプラインが明確で理解しやすい

---

### REFACTOR-004: 計算ロジックの重複排除

**関連Issue**: kaenozu/Ult#524  
**優先度**: Medium  
**複雑さ**: Medium  
**推定工数**: 5-6時間

#### タスク

- [ ] **4.1 重複コードの検出**
  - [ ] 類似コード検出ツール実行
  - [ ] 重複ロジックのリスト作成

- [ ] **4.2 共通ユーティリティの作成**
  - [ ] 計算ロジックの抽出
  - [ ] ユーティリティ関数の作成

- [ ] **4.3 既存コードの置き換え**
  - [ ] 重複箇所の共通関数への置き換え
  - [ ] テストの追加

#### 成功指標
- ✅ 重複コードが50%以上削減
- ✅ 計算ロジックが一箇所に集約
- ✅ 保守性が向上

---

## 📈 Phase 3: 品質向上

### REFACTOR-007: テスト容易性の向上

**関連Issue**: kaenozu/Ult#527  
**優先度**: Medium  
**複雑さ**: Medium  
**推定工数**: 6-8時間

#### タスク

- [ ] **7.1 テストインフラの強化**
  - [ ] テストユーティリティの作成
  - [ ] モックデータジェネレータ
  - [ ] テストヘルパー関数

- [ ] **7.2 単体テストの追加**
  - [ ] 主要サービスのテスト
  - [ ] ユーティリティ関数のテスト
  - [ ] 型ガード関数のテスト

- [ ] **7.3 統合テストの拡充**
  - [ ] APIテストの追加
  - [ ] データフローテスト

#### 成功指標
- ✅ テストカバレッジ 45% → 70%
- ✅ 主要機能の単体テスト完備
- ✅ CI/CDで自動テスト実行

---

### REFACTOR-009: ファイル構造の再編成

**関連Issue**: kaenozu/Ult#529  
**優先度**: Medium  
**複雑さ**: Low  
**推定工数**: 4-5時間

#### タスク

- [ ] **9.1 大型コンポーネントの分割**
  - [ ] StrategyDashboard.tsx (853行) の分割
  - [ ] RiskDashboard.tsx (796行) の分割
  - [ ] BacktestResultsDashboard.tsx (704行) の分割

- [ ] **9.2 ディレクトリ構造の整理**
  - [ ] 機能別ディレクトリの作成
  - [ ] 共通コンポーネントの整理
  - [ ] インポートパスの最適化

#### 成功指標
- ✅ 全コンポーネントが300行以下
- ✅ ディレクトリ構造が機能別に整理
- ✅ インポートが明確

---

### REFACTOR-011: 設定の型安全性

**関連Issue**: kaenozu/Ult#531  
**優先度**: Medium  
**複雑さ**: Low  
**推定工数**: 3-4時間

#### タスク

- [ ] **11.1 設定スキーマの作成**
  - [ ] Zodスキーマ定義
  - [ ] 設定型の自動生成

- [ ] **11.2 設定バリデーション**
  - [ ] 起動時バリデーション
  - [ ] 設定エラーの適切な報告

#### 成功指標
- ✅ 全設定が型安全
- ✅ 不正な設定でビルドエラー
- ✅ 設定ドキュメントの自動生成

---

## 🔍 Phase 4: 監視・最適化

### REFACTOR-010: パフォーマンス計測の標準化

**関連Issue**: kaenozu/Ult#530  
**優先度**: Medium  
**複雑さ**: Low  
**推定工数**: 3-4時間

#### タスク

- [ ] **10.1 パフォーマンス計測ユーティリティ**
  - [ ] `measurePerformance()` 関数
  - [ ] `usePerformanceMonitor()` フック
  - [ ] パフォーマンスレポート機能

- [ ] **10.2 主要箇所への適用**
  - [ ] データ処理パイプライン
  - [ ] レンダリングパフォーマンス
  - [ ] API呼び出し

- [ ] **10.3 パフォーマンスダッシュボード**
  - [ ] メトリクス可視化
  - [ ] アラート機能

#### 成功指標
- ✅ 主要機能のパフォーマンスが可視化
- ✅ ボトルネックの早期発見
- ✅ 継続的な最適化が可能

---

## 📊 全体進捗管理

### フェーズ別進捗

| Phase | 完了タスク | 総タスク | 進捗率 | 状態 |
|-------|-----------|---------|--------|------|
| Phase 0 | 2 | 4 | 50% | 🟡 進行中 |
| Phase 1 | 0 | 15 | 0% | ⚪ 未着手 |
| Phase 2 | 0 | 15 | 0% | ⚪ 未着手 |
| Phase 3 | 0 | 10 | 0% | ⚪ 未着手 |
| Phase 4 | 0 | 5 | 0% | ⚪ 未着手 |
| **合計** | **2** | **49** | **4%** | 🟡 |

### Issue別進捗

| Issue | タイトル | Phase | 進捗 | 状態 |
|-------|---------|-------|------|------|
| #522 | 定数・設定の一元管理 | 1 | 80% | 🟡 |
| #523 | 型安全性の向上 | 1 | 0% | ⚪ |
| #528 | エラーハンドリングの統一 | 1 | 0% | ⚪ |
| #525 | サービス層の責務分離 | 2 | 0% | ⚪ |
| #526 | データパイプラインの整理 | 2 | 0% | ⚪ |
| #524 | 計算ロジックの重複排除 | 2 | 0% | ⚪ |
| #527 | テスト容易性の向上 | 3 | 0% | ⚪ |
| #529 | ファイル構造の再編成 | 3 | 0% | ⚪ |
| #531 | 設定の型安全性 | 3 | 0% | ⚪ |
| #530 | パフォーマンス計測の標準化 | 4 | 0% | ⚪ |

---

## 🎯 KPI追跡

### コード品質KPI

| KPI | Baseline | 現在値 | 目標値 | 達成率 |
|-----|----------|--------|--------|--------|
| TypeScript strict準拠 | 100% | 100% | 100% | ✅ |
| any型使用率 | 15% | 15% | 0% | 0% |
| テストカバレッジ | 45% | 45% | 80% | 0% |
| 平均ファイル行数 | 374行 | 374行 | 200行 | 0% |
| 最大コンポーネント行数 | 853行 | 853行 | 300行 | 0% |

### 保守性KPI

| KPI | Baseline | 目標値 | 測定方法 |
|-----|----------|--------|----------|
| 新機能追加工数 | 5日 | 2日 | 実績測定 |
| バグ修正工数 | 3時間 | 1時間 | 実績測定 |
| コードレビュー時間 | 2時間 | 1時間 | 実績測定 |

---

## 🔄 更新履歴

| 日付 | 更新内容 | 担当 |
|------|---------|------|
| 2026-02-02 | 初版作成、Phase 0開始 | @copilot |
| TBD | Phase 1開始予定 | TBD |

---

## 📝 注意事項

### リスク管理

1. **リグレッションリスク**
   - 対策: 変更前に必ずテスト追加
   - 対策: Feature Flagによる段階的移行
   - 対策: E2Eテストの強化

2. **工数超過リスク**
   - 対策: Phase単位で区切り、優先度に応じて実施
   - 対策: 最小限の変更で最大の効果を狙う
   - 対策: 自動化ツールの活用

3. **互換性リスク**
   - 対策: 段階的な移行（既存コード維持）
   - 対策: deprecation警告の追加
   - 対策: 移行ガイドの作成

### 推奨アプローチ

- ✅ **小さく始める**: Phase 1から順に実施
- ✅ **継続的統合**: 各タスク完了後に即マージ
- ✅ **ドキュメント更新**: 変更内容を必ず記録
- ✅ **テストファースト**: コード変更前にテスト追加
- ✅ **段階的移行**: 既存機能を壊さない

---

**次回更新予定**: Phase 1完了時
