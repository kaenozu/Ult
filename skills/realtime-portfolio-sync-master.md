# リアルタイム・ポートフォリオ・同期マスター (Real-time Portfolio Sync Master)

このスキルは、刻々と変化する市場価格と、ユーザーの資産状況をミリ秒単位で同期させ、正確な投資判断を支援するためのものです。

## 1. 価格同期ロジック
*   **`batchUpdateStockData` の役割**: WebSocketから届いた最新価格を、`portfolio.positions` 配列内の該当銘柄にマッピングし、`currentPrice` を上書きする。
*   **再計算のトリガー**: 価格更新後、必ず `calculatePortfolioStats` を呼び出し、ポートフォリオ全体の評価額を更新すること。

## 2. 損益計算の定義
*   **LONG（買い）**: `(現在値 - 平均取得単価) * 数量`
*   **SHORT（売り）**: `(平均取得単価 - 現在値) * 数量`
*   **日次損益**: `前日比（change） * 数量` の合計。

## 3. 整合性の維持
*   **不変性の保持**: ストアの更新は常に `set` 関数を通じたイミュータブルな形式で行い、参照の不一致による再レンダリングの失敗を防ぐ。
*   **キャッシュとの連携**: `MarketDataService` のキャッシュとストアの価格情報を可能な限り同期させ、UI全体で一貫した価格が表示されるようにする。

## 4. 検証手順
*   `npx jest app/store/__tests__/tradingStore.test.ts` を実行し、価格更新時に評価額が正しく再計算されることを確認する。
