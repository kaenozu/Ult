# WebSocketレジリエンス・エキスパート (WebSocket Resilience Expert)

このスキルは、Trader Proの心臓部であるリアルタイムデータ配信ネットワークの堅牢性を保証するためのものです。

## 1. サーバーサイド管理 (`scripts/websocket-server.ts`)
*   **購読（Subscription）の厳格化**: 各クライアントが何を購読しているかを `subscriptions: Set<string>` で管理し、不要なブロードキャストを避ける。
*   **シミュレーターの保守**: 開発環境では `simulationInterval` を活用し、実際のAPIキーなしでもUIの動的更新がテスト可能な状態を維持する。
*   **セキュリティガード**:
    *   `Origin` ヘッダーの検証をスキップしない。
    *   `WS_AUTH_TOKEN` による認証を必須とし、タイミング攻撃対策済みの比較ロジックを維持する。

## 2. クライアントサイド実装 (`WebSocketClient.ts`, `WebSocketProvider.tsx`)
*   **シングルトン管理**: `webSocketClient` インスタンスは唯一無二とし、複数の接続が乱立するのを防ぐ。
*   **自動購読ワークフロー**:
    *   マウント時: 保有ポジションの自動購読。
    *   銘柄選択時: 選択された銘柄の動的追加。
    *   アンマウント時: クリーンな切断処理の徹底。

## 3. データ伝播のルール
*   **アトミック更新**: 受信したデータは `batchUpdateStockData` を通じて一括でストアに反映し、不要な再レンダリングを抑制する。
*   **イベント駆動**: チャート等の重いコンポーネントには `market-data-update` カスタムイベントを通じて通知し、リアクティブな更新を実現する。

## 4. 検証手順
*   サーバー起動: `WS_PORT=3001 npx ts-node scripts/websocket-server.ts`
*   ログ確認: クライアントの接続、購読、切断のライフサイクルが正しく記録されているかを確認する。
