---
name: project-stabilizer
description: Post-merge recovery and test stabilization specialist. Resolves inconsistencies after large merges and migrates to modern tech stack (TanStack Query, Zod, React 19).
version: 1.2.0
priority: high
auto_activate: true
---

# Project Stabilizer (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®‰å®šåŒ–ãƒã‚¹ã‚¿ãƒ¼)

å¤§è¦æ¨¡ãªãƒãƒ¼ã‚¸ã‚„æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®åˆ·æ–°å¾Œã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¥å…¨æ€§ã‚’è¿…é€Ÿã«å›å¾©ã—ã€æœ€é«˜æ°´æº–ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°å“è³ªã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®å°‚é–€ã‚¹ã‚­ãƒ«ã€‚

Post-merge recovery and modernization specialist. Rapidly restores project health after large merges or tech stack updates, maintaining the highest engineering quality standards.

## ğŸ¯ ç›®çš„
- ãƒãƒ¼ã‚¸å¾Œã®ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚„å‹ã‚¨ãƒ©ãƒ¼ã®è¿…é€Ÿãªè§£æ¶ˆã€‚
- ãƒ¬ã‚¬ã‚·ãƒ¼ãªçŠ¶æ…‹ç®¡ç†ã‹ã‚‰ãƒ¢ãƒ€ãƒ³ãªéåŒæœŸçŠ¶æ…‹ç®¡ç†ï¼ˆTanStack Queryï¼‰ã¸ã®ç§»è¡Œã€‚
- React 19 ãŠã‚ˆã³ Next.js App Router ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã®å¾¹åº•ã€‚
- å®Ÿè¡Œæ™‚ã®å‹å®‰å…¨æ€§ï¼ˆZodï¼‰ã¨ç’°å¢ƒå¤‰æ•°ã®ä¿è­·ã€‚

## ğŸ›  å°‚é–€çŸ¥è­˜ (Expertise)

### 1. ãƒãƒ¼ã‚¸å¾Œã®ä¸æ•´åˆè§£æ±º (Post-Merge Recovery)
- **ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªDBã®çµ±åˆ**: è¤‡æ•°ã®APIãƒ«ãƒ¼ãƒˆã§ç‹¬ç«‹ã—ã¦ã„ãŸã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹ã‚’ `AuthStore` ç­‰ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã¾ãŸã¯å…±æœ‰ã‚¹ãƒˆã‚¢ã«çµ±åˆã—ã€ãƒ†ã‚¹ãƒˆã®æ•´åˆæ€§ã‚’ä¿ã¤ã€‚
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æœ€é©åŒ–**: äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã®é–¾å€¤åˆ¤å®šãŒå³ã—ã„å ´åˆã€ç¾å®Ÿçš„ãªã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆVå­—å›å¾©ç­‰ï¼‰ã‚’ã‚·ã‚°ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«èª¿æ•´ã™ã‚‹ã€‚
- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®çµ±ä¸€**: `pnpm` ã¨ `npm` ã®æ··åœ¨ã‚’æ¤œçŸ¥ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨™æº–ï¼ˆç¾åœ¨ã¯ `npm`ï¼‰ã«ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¼·åˆ¶çš„ã«ä¸€æœ¬åŒ–ã™ã‚‹ã€‚

### 2. ãƒ¢ãƒ€ãƒ³ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ (Modern Data Fetching)
- **useEffect ã‹ã‚‰ useQuery ã¸ã®ç§»è¡Œ**: æ‰‹å‹•ã® `fetch` + `useState` ã‚’ `TanStack Query` ã«ç½®ãæ›ãˆã€ç«¶åˆçŠ¶æ…‹ã€äºŒé‡ç™ºç«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚’ä¸€å…ƒåŒ–ã™ã‚‹ã€‚
- **Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¯¾ã—ã€TypeScript ã®å‹å®šç¾©ã ã‘ã§ãªãå®Ÿè¡Œæ™‚ã®ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ã‚’è¡Œã„ã€ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãªã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’é˜²ãã€‚

### 3. React 19 æœ€é©åŒ–
- **Side Effect ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: Effect å†…ã§ã®åŒæœŸçš„ãª `setState`ï¼ˆCascading Rendersï¼‰ã‚’æ’é™¤ã—ã€`useTransition` ã‚„ `useMemo`ã€ã¾ãŸã¯ `useQuery` ã®çŠ¶æ…‹ç§»è¡Œã‚’æ´»ç”¨ã™ã‚‹ã€‚
- **Ref ã‚¢ã‚¯ã‚»ã‚¹ã®é©æ­£åŒ–**: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã® `ref.current` ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ã—ã€Effect ã¾ãŸã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ã§ã®ã¿å‡¦ç†ã™ã‚‹ã€‚

### 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é€²åŒ– (DDD)
- **ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ†é›¢**: `app/lib` ã®è‚¥å¤§åŒ–ã‚’é˜²ããŸã‚ã€`app/features/[domain]` æ§‹é€ ã‚’å°å…¥ã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚¹ãƒˆã‚¢ã€ãƒ•ãƒƒã‚¯ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ã€‚

## ğŸ“ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (Workflow)

### Step 1: è¨ºæ–­ (Diagnosis)
`npm test` ã¨ `npm run lint` ã‚’å®Ÿè¡Œã—ã€ãƒãƒ¼ã‚¸å¾Œã®ã€ŒçœŸã®å¤±æ•—æ•°ã€ã‚’æŠŠæ¡ã™ã‚‹ã€‚

**å¿…é ˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œé †åº:**
```bash
cd trading-platform

# 1. ä¾å­˜é–¢ä¿‚ã®çŠ¶æ…‹ç¢ºèª
npm list --depth=0 2>&1 | grep -E "UNMET|missing" || echo "âœ“ Dependencies OK"

# 2. TypeScript å‹ãƒã‚§ãƒƒã‚¯ (æœ€å„ªå…ˆ)
npx tsc --noEmit

# 3. ESLint é™çš„è§£æ
npm run lint

# 4. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test -- --passWithNoTests --coverage

# 5. ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
npm run build
```

**Expected Output - å¥å…¨ãªçŠ¶æ…‹:**
```
âœ“ Dependencies OK
âœ“ TypeScript: 0 errors
âœ“ ESLint: 0 errors, 0 warnings
âœ“ Tests: 247 passed, 0 failed
âœ“ Coverage: 82.5% (above threshold)
âœ“ Build: completed in 45s
```

**Expected Output - å•é¡ŒãŒã‚ã‚‹å ´åˆ:**
```
âœ— TypeScript: 15 errors found
  - app/lib/auth/AuthStore.ts(42,15): Property 'userId' does not exist
  - app/components/Login.tsx(28,3): Type 'string | undefined' is not assignable
  
âœ— ESLint: 23 errors, 47 warnings
  - @typescript-eslint/no-explicit-any: 12 occurrences
  - react-hooks/exhaustive-deps: 11 warnings
  
âœ— Tests: 198 passed, 49 failed
  - FAIL app/lib/__tests__/AuthService.test.ts
    â— AuthService â€º authenticates user
      expect(received).toBe(expected)
      Expected: true
      Received: undefined
      
âœ— Coverage: 67.3% (below 80% threshold)
```

**è¨ºæ–­ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
- [ ] ä¾å­˜é–¢ä¿‚ã®ç«¶åˆãŒãªã„ã‹ç¢ºèª
- [ ] TypeScript ã‚¨ãƒ©ãƒ¼ã®ç®‡æ‰€ã¨ç¨®é¡ã‚’è¨˜éŒ²
- [ ] ESLint ã‚¨ãƒ©ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†é¡
- [ ] å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®å…±é€šåŸå› ã‚’ç‰¹å®š
- [ ] ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°æœ€å„ªå…ˆã§å¯¾å‡¦

#### è¨ºæ–­ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ (Diagnostic Decision Tree)

**ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã”ã¨ã«å…·ä½“çš„ãªå¯¾å‡¦æ‰‹é †ã‚’ç¤ºã—ã¾ã™:**

##### TypeScript ã‚¨ãƒ©ãƒ¼ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```
TypeScript Error ã‚’æ¤œå‡ºã—ãŸã‚‰ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§åˆ†é¡:

1. "Property 'X' does not exist on type 'Y'"
   â”œâ”€ Step 1: è©²å½“ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å®šç¾©ã‚’ç¢ºèª
   â”‚  $ grep -r "interface Y" app/ --include="*.ts"
   â”œâ”€ Step 2: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå®Ÿéš›ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   â”‚  $ grep -A 10 "interface Y" app/lib/types/index.ts
   â””â”€ Step 3: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹ç¢ºèª
      $ grep "import.*Y" <error-file>.ts

2. "Type 'X' is not assignable to type 'Y'"
   â”œâ”€ Step 1: ä¸¡æ–¹ã®å‹å®šç¾©ã‚’è¡¨ç¤º
   â”‚  $ npx tsc --noEmit --explainFiles | grep -A 5 "type X\|type Y"
   â”œâ”€ Step 2: å‹ã®äº’æ›æ€§ã‚’ç¢ºèª
   â”‚  - XãŒéƒ¨åˆ†å‹ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ (extends, implements)
   â””â”€ Step 3: å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯å‹ã‚¬ãƒ¼ãƒ‰è¿½åŠ 
      // Option A: Type assertion (å±é™º)
      const value = unknownValue as ExpectedType;
      
      // Option B: Type guard (å®‰å…¨)
      if (isExpectedType(unknownValue)) {
        // ã“ã“ã§ã¯ unknownValue ã¯ ExpectedType ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
      }

3. "Cannot find module 'X' or its corresponding type declarations"
   â”œâ”€ Step 1: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
   â”‚  $ ls -la node_modules/X
   â”œâ”€ Step 2: package.json ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   â”‚  $ grep "\"X\"" package.json
   â”œâ”€ Step 3: ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®è¨­å®šã‚’ç¢ºèª
   â”‚  $ cat tsconfig.json | grep -A 5 "paths"
   â””â”€ Step 4: å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      $ npm install --save-dev @types/X

4. "Object is possibly 'undefined'"
   â”œâ”€ Step 1: Optional chaining ã‚’ä½¿ç”¨
   â”‚  // Before: data.user.name
   â”‚  // After: data?.user?.name
   â”œâ”€ Step 2: Non-null assertion (ç¢ºå®Ÿãªå ´åˆã®ã¿)
   â”‚  // data!.user.name  // å±é™º: undefinedãªã‚‰å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼
   â””â”€ Step 3: å‹ã‚¬ãƒ¼ãƒ‰ã§ç¢ºèª (æ¨å¥¨)
      if (data && data.user) {
        console.log(data.user.name);
      }
```

**å®Ÿè¡Œä¾‹: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ä¿®æ­£ã¾ã§**
```bash
# ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
$ npx tsc --noEmit
app/components/Dashboard.tsx(42,15): error TS2339: Property 'userId' does not exist on type 'User'

# Step 1: Userå‹ã®å®šç¾©ã‚’ç¢ºèª
$ grep -A 10 "interface User" app/lib/types/user.ts
interface User {
  id: string;        # â† 'userId' ã§ã¯ãªã 'id'
  email: string;
  name: string;
}

# Step 2: Dashboard.tsx ã‚’ä¿®æ­£
# Before: const id = user.userId;
# After:  const id = user.id;

# Step 3: å†ãƒã‚§ãƒƒã‚¯
$ npx tsc --noEmit
# âœ“ No errors found
```

##### ESLint ã‚¨ãƒ©ãƒ¼ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```
ESLint Error ã‚’æ¤œå‡ºã—ãŸã‚‰ã€ãƒ«ãƒ¼ãƒ«åã§åˆ†é¡:

1. "@typescript-eslint/no-explicit-any"
   â”œâ”€ Step 1: any ã®ä½¿ç”¨ç®‡æ‰€ã‚’ç‰¹å®š
   â”‚  $ grep -n "any" <file>.ts
   â”œâ”€ Step 2: é©åˆ‡ãªå‹ã«ç½®ãæ›ãˆ
   â”‚  // Before: data: any
   â”‚  // After:  data: unknown (ã•ã‚‰ã«å‹ã‚¬ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿)
   â””â”€ Step 3: ã©ã†ã—ã¦ã‚‚å‹ãŒä¸æ˜ãªå ´åˆ
      // ç†ç”±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const data: any = unknownSource; // APIä»•æ§˜ãŒä¸æ˜ãªãŸã‚æš«å®šçš„ã«anyä½¿ç”¨

2. "react-hooks/exhaustive-deps"
   â”œâ”€ Step 1: ä¾å­˜é…åˆ—ã‚’ç¢ºèª
   â”‚  $ grep -A 3 "useEffect" <file>.tsx
   â”œâ”€ Step 2: ä¸è¶³ã—ã¦ã„ã‚‹ä¾å­˜ã‚’è¿½åŠ 
   â”‚  useEffect(() => {
   â”‚    fetchData(userId); // â† userId ã‚’ä¾å­˜é…åˆ—ã«è¿½åŠ 
   â”‚  }, [userId]);
   â””â”€ Step 3: æ„å›³çš„ã«ä¾å­˜ã‚’çœç•¥ã™ã‚‹å ´åˆ
      useEffect(() => {
        // ãƒã‚¦ãƒ³ãƒˆæ™‚ã®ã¿å®Ÿè¡Œã—ãŸã„
        initializeApp();
      // eslint-disable-next-line react-hooks/exhaustive-deps
      }, []); // ç©ºé…åˆ—ã¯æ„å›³çš„

3. "no-unused-vars"
   â”œâ”€ Step 1: å®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ãªã„å¤‰æ•°ã‚’å‰Šé™¤
   â”‚  // Before: const [data, setData] = useState(null);
   â”‚  // After:  const [data] = useState(null); // setData ã¯æœªä½¿ç”¨
   â””â”€ Step 2: ä¸€æ™‚çš„ã«ä¿æŒã—ãŸã„å ´åˆ
      // å°†æ¥ã®å®Ÿè£…ã®ãŸã‚ã«ä¿æŒ
      // eslint-disable-next-line no-unused-vars
      const _reservedForFuture = data;
```

**å®Ÿè¡Œä¾‹: è‡ªå‹•ä¿®æ­£ + æ‰‹å‹•ä¿®æ­£**
```bash
# ç¾åœ¨ã®ã‚¨ãƒ©ãƒ¼æ•°ã‚’ç¢ºèª
$ npm run lint
âœ– 47 problems (23 errors, 24 warnings)
  12 errors and 5 warnings potentially fixable with the `--fix` option.

# è‡ªå‹•ä¿®æ­£å¯èƒ½ãªã‚‚ã®ã‚’ä¿®æ­£
$ npm run lint:fix
âœ” Fixed 17 problems

# æ®‹ã‚Šã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
$ npm run lint
âœ– 30 problems (6 errors, 24 warnings)

# ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã‚’è©³ç´°è¡¨ç¤º
$ npx eslint app/components/Dashboard.tsx
app/components/Dashboard.tsx
  42:15  error  Unexpected any  @typescript-eslint/no-explicit-any
  58:3   warn   Missing dependency: 'userId'  react-hooks/exhaustive-deps

# ä¿®æ­£å¾Œã«å†ãƒã‚§ãƒƒã‚¯
$ npm run lint
âœ” No problems found!
```

##### ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```
Test Failure ã‚’æ¤œå‡ºã—ãŸã‚‰ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åˆ†é¡:

1. "expect(received).toBe(expected)"
   â”œâ”€ Step 1: å®Ÿéš›ã®å€¤ã¨æœŸå¾…å€¤ã‚’æ¯”è¼ƒ
   â”‚  Expected: true
   â”‚  Received: undefined
   â”œâ”€ Step 2: undefined ãŒè¿”ã‚‹åŸå› ã‚’ç‰¹å®š
   â”‚  - é–¢æ•°ãŒå€¤ã‚’è¿”ã—ã¦ã„ãªã„?
   â”‚  - éåŒæœŸå‡¦ç†ã‚’å¾…ã£ã¦ã„ãªã„?
   â””â”€ Step 3: ä¿®æ­£æ–¹æ³•ã‚’é¸æŠ
      // Option A: await ã§éåŒæœŸå‡¦ç†ã‚’å¾…ã¤
      const result = await asyncFunction();
      
      // Option B: é–¢æ•°ãŒå€¤ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
      function myFunction() {
        // Before: console.log(value);
        return value; // After: å€¤ã‚’è¿”ã™
      }

2. "Timeout - Async callback was not invoked within the 5000ms"
   â”œâ”€ Step 1: éåŒæœŸå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ãªã„ã‹ç¢ºèª
   â”œâ”€ Step 2: waitFor ã‚’ä½¿ç”¨ã—ã¦å¾…æ©Ÿ
   â”‚  await waitFor(() => {
   â”‚    expect(screen.getByText('Success')).toBeInTheDocument();
   â”‚  }, { timeout: 10000 });
   â””â”€ Step 3: jest.config.js ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·
      module.exports = {
        testTimeout: 10000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5000ã‹ã‚‰10000ã«
      };

3. "Unable to find an element with the text: X"
   â”œâ”€ Step 1: è¦ç´ ãŒå®Ÿéš›ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   â”‚  screen.debug(); // DOMå…¨ä½“ã‚’è¡¨ç¤º
   â”œâ”€ Step 2: ãƒ†ã‚­ã‚¹ãƒˆãŒéåŒæœŸã§è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆ
   â”‚  // Before: screen.getByText('X')
   â”‚  // After:  await screen.findByText('X') // è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
   â””â”€ Step 3: éƒ¨åˆ†ä¸€è‡´ã‚„Roleæ¤œç´¢ã‚’è©¦ã™
      screen.getByText(/X/i); // å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–
      screen.getByRole('button', { name: /X/ });
```

**å®Ÿè¡Œä¾‹: å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ä¿®æ­£**
```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
$ npm test -- AuthService.test.ts
FAIL app/lib/__tests__/AuthService.test.ts
  â— AuthService â€º authenticates user
    expect(received).toBe(expected)
    Expected: true
    Received: undefined
    at Object.<anonymous> (AuthService.test.ts:42:23)

# Step 1: ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
$ cat app/lib/__tests__/AuthService.test.ts | grep -A 5 "authenticates user"
test('authenticates user', () => {
  const result = authService.authenticate('test@example.com', 'password');
  expect(result).toBe(true); // â† undefined ã‚’å—ã‘å–ã£ã¦ã„ã‚‹
});

# Step 2: AuthService ã®å®Ÿè£…ã‚’ç¢ºèª
$ cat app/lib/AuthService.ts | grep -A 10 "authenticate"
authenticate(email: string, password: string) {
  const user = this.users.get(email);
  if (user && user.password === password) {
    this.currentUser = user;
    // â† return æ–‡ãŒãªã„ï¼
  }
}

# Step 3: ä¿®æ­£
# After: return user; ã‚’è¿½åŠ 
authenticate(email: string, password: string): User | null {
  const user = this.users.get(email);
  if (user && user.password === password) {
    this.currentUser = user;
    return user; // â† è¿½åŠ 
  }
  return null;
}

# Step 4: å†ãƒ†ã‚¹ãƒˆ
$ npm test -- AuthService.test.ts
PASS app/lib/__tests__/AuthService.test.ts
  âœ“ authenticates user (5 ms)
```

### Step 2: åŸºç›¤ä¿®å¾© (Base Fix)
èªè¨¼ã‚„ç’°å¢ƒå¤‰æ•°ãªã©ã€ã‚·ã‚¹ãƒ†ãƒ ã®æ ¹å¹¹ã«é–¢ã‚ã‚‹ä¸æ•´åˆã‚’ `AuthStore` ã‚„ `env.ts` ã®å°å…¥ã«ã‚ˆã‚Šæœ€å„ªå…ˆã§ä¿®æ­£ã™ã‚‹ã€‚

**ã‚·ãƒŠãƒªã‚ª 1: åˆ†æ•£ã—ãŸèªè¨¼çŠ¶æ…‹ã®çµ±åˆ**

**Before: Scattered authentication state**
```typescript
// âŒ Problem: 3ç®‡æ‰€ã§ç‹¬ç«‹ã—ãŸçŠ¶æ…‹ç®¡ç†
// app/api/auth/route.ts
let currentUser: User | null = null; // APIç”¨ã®çŠ¶æ…‹

// app/components/Login.tsx
const [user, setUser] = useState<User | null>(null); // UIç”¨ã®çŠ¶æ…‹

// app/lib/websocket/WebSocketService.ts
private authenticatedUser?: User; // WebSocketç”¨ã®çŠ¶æ…‹
```

**Issue:** ãƒ†ã‚¹ãƒˆã§èªè¨¼ã™ã‚‹ã¨ã€APIã¯èªè¨¼æ¸ˆã¿ã ãŒUIã¯æœªèªè¨¼ã®ã¾ã¾ã€‚ä¸æ•´åˆã«ã‚ˆã‚Šãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã€‚

**After: Centralized AuthStore**
```typescript
// âœ… Solution: ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§çŠ¶æ…‹ã‚’ä¸€å…ƒç®¡ç†
// app/lib/auth/AuthStore.ts
export class AuthStore {
  private static instance: AuthStore;
  private users = new Map<string, User>();
  private currentUser: User | null = null;
  
  static getInstance(): AuthStore {
    if (!AuthStore.instance) {
      AuthStore.instance = new AuthStore();
    }
    return AuthStore.instance;
  }
  
  register(user: User): void {
    this.users.set(user.email, user);
  }
  
  authenticate(email: string, password: string): User | null {
    const user = this.users.get(email);
    if (user && user.password === password) {
      this.currentUser = user;
      return user;
    }
    return null;
  }
  
  getCurrentUser(): User | null {
    return this.currentUser;
  }
  
  logout(): void {
    this.currentUser = null;
  }
  
  // ãƒ†ã‚¹ãƒˆç”¨: å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
  reset(): void {
    this.users.clear();
    this.currentUser = null;
  }
}

// app/lib/auth/index.ts
export const authStore = AuthStore.getInstance();
```

**Migration Steps:**
```bash
# 1. AuthStore ã‚’ä½œæˆ
touch app/lib/auth/AuthStore.ts

# 2. æ—¢å­˜ã®APIãƒ«ãƒ¼ãƒˆã‚’æ›´æ–°
# app/api/auth/route.ts ã‚’ authStore ã‚’ä½¿ã†ã‚ˆã†ã«æ›¸ãæ›ãˆ

# 3. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ›´æ–°
# useAuthStore() ãƒ•ãƒƒã‚¯ã‚’ä½œæˆã—ã¦Zustandã§è³¼èª­

# 4. ãƒ†ã‚¹ãƒˆã§ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’è¿½åŠ 
# beforeEach(() => authStore.reset())

# 5. æ¤œè¨¼
npm test -- AuthStore.test.ts
npm test -- Login.test.tsx
npm test -- auth
```

**ã‚·ãƒŠãƒªã‚ª 2: ç’°å¢ƒå¤‰æ•°ã®å®Ÿè¡Œæ™‚æ¤œè¨¼**

**Before: Runtime errors from missing env vars**
```typescript
// âŒ Problem: å®Ÿè¡Œæ™‚ã¾ã§ç’°å¢ƒå¤‰æ•°ã®ä¸è¶³ã«æ°—ã¥ã‹ãªã„
// app/lib/api/AlphaVantageClient.ts
const API_KEY = process.env.ALPHA_VANTAGE_API_KEY; // undefined ã§ã‚‚ç¶šè¡Œ
const response = await fetch(`https://api.alphavantage.co/query?apikey=${API_KEY}`);
// æœ¬ç•ªã§ "undefined" ãŒé€ä¿¡ã•ã‚Œã¦å¤±æ•—
```

**After: Type-safe environment validation**
```typescript
// âœ… Solution: èµ·å‹•æ™‚ã« Zod ã§æ¤œè¨¼
// app/lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  ALPHA_VANTAGE_API_KEY: z.string().min(1, 'Alpha Vantage API key is required'),
  NEXT_PUBLIC_WS_URL: z.string().url('WebSocket URL must be valid'),
  NODE_ENV: z.enum(['development', 'test', 'production']),
});

export const env = envSchema.parse({
  ALPHA_VANTAGE_API_KEY: process.env.ALPHA_VANTAGE_API_KEY,
  NEXT_PUBLIC_WS_URL: process.env.NEXT_PUBLIC_WS_URL,
  NODE_ENV: process.env.NODE_ENV,
});

// app/lib/api/AlphaVantageClient.ts
import { env } from '@/lib/env';

const response = await fetch(
  `https://api.alphavantage.co/query?apikey=${env.ALPHA_VANTAGE_API_KEY}`
);
// å‹å®‰å…¨ + èµ·å‹•æ™‚æ¤œè¨¼ã€‚undefined ã¯çµ¶å¯¾ã«æ¥ãªã„
```

**Verification:**
```bash
# ç’°å¢ƒå¤‰æ•°ãªã—ã§èµ·å‹•ã™ã‚‹ã¨å³åº§ã«ã‚¨ãƒ©ãƒ¼
$ npm run dev

ZodError: [
  {
    "code": "too_small",
    "minimum": 1,
    "path": ["ALPHA_VANTAGE_API_KEY"],
    "message": "Alpha Vantage API key is required"
  }
]

# .env.local ã‚’è¨­å®šå¾Œ
$ npm run dev
âœ“ Ready on http://localhost:3000
```

### Step 3: UI/ãƒ­ã‚¸ãƒƒã‚¯ã®å®‰å®šåŒ–
å£Šã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’ã€æœ€æ–°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆRTLç­‰ï¼‰ã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦ä¿®æ­£ã™ã‚‹ã€‚

**ã‚·ãƒŠãƒªã‚ª 1: React 19 äº’æ›ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³**

**Before: Using old testing patterns**
```typescript
// âŒ Problem: React 18 ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒ React 19 ã§è­¦å‘Š
import { render } from '@testing-library/react';

test('renders component', () => {
  const { getByText } = render(<MyComponent />);
  expect(getByText('Hello')).toBeInTheDocument();
  // Warning: ReactDOM.render is no longer supported in React 19
});
```

**After: React 19 compatible patterns**
```typescript
// âœ… Solution: screen ã‚’ä½¿ã„ã€async/await ã§å®‰å®šåŒ–
import { render, screen, waitFor } from '@testing-library/react';
import { expect, test } from '@jest/globals';

test('renders component with modern patterns', async () => {
  render(<MyComponent />);
  
  // findBy* ã¯è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
  const element = await screen.findByText('Hello');
  expect(element).toBeDefined();
  expect(element).toBeVisible();
});

test('handles async state updates', async () => {
  render(<MyComponent />);
  
  const button = screen.getByRole('button', { name: /click me/i });
  await userEvent.click(button);
  
  // çŠ¶æ…‹æ›´æ–°ã‚’å¾…æ©Ÿ
  await waitFor(() => {
    expect(screen.getByText('Clicked!')).toBeInTheDocument();
  });
});
```

**ã‚·ãƒŠãƒªã‚ª 2: ãƒ¢ãƒƒã‚¯ã®æœ€å°åŒ–**

**Before: Over-mocked tests**
```typescript
// âŒ Problem: å®Ÿè£…ã®è©³ç´°ã‚’ãƒ¢ãƒƒã‚¯ã€‚ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§å£Šã‚Œã‚‹
jest.mock('@/lib/MarketDataService', () => ({
  MarketDataService: {
    getInstance: jest.fn(() => ({
      fetchStockData: jest.fn(() => Promise.resolve(mockData)),
      getCachedData: jest.fn(() => mockData),
      invalidateCache: jest.fn(),
    })),
  },
}));

test('displays stock price', async () => {
  render(<StockCard symbol="AAPL" />);
  await screen.findByText('$150.00');
  // ãƒ†ã‚¹ãƒˆã¯ãƒ‘ã‚¹ã™ã‚‹ãŒã€å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã®çµ±åˆã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ãªã„
});
```

**After: Integration-focused tests**
```typescript
// âœ… Solution: ãƒ¢ãƒƒã‚¯ã¯å¤–éƒ¨ä¾å­˜ã®ã¿ã€‚å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã¯å®Ÿéš›ã«å®Ÿè¡Œ
import { MarketDataService } from '@/lib/MarketDataService';

// å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®ã¿ãƒ¢ãƒƒã‚¯
jest.mock('@/lib/api/AlphaVantageClient', () => ({
  fetchFromAPI: jest.fn(() => Promise.resolve({
    '01. symbol': 'AAPL',
    '05. price': 150.00,
  })),
}));

test('displays stock price from real service', async () => {
  // å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨
  const service = MarketDataService.getInstance();
  
  render(<StockCard symbol="AAPL" />);
  
  // ã‚µãƒ¼ãƒ“ã‚¹ã®å…¨ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€å¤‰æ›ç­‰ï¼‰ã‚’å®Ÿè¡Œ
  await waitFor(() => {
    expect(screen.getByText('$150.00')).toBeInTheDocument();
  });
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å®Ÿéš›ã«æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
  render(<StockCard symbol="AAPL" />);
  await screen.findByText('$150.00'); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
});
```

**ã‚·ãƒŠãƒªã‚ª 3: useEffect ã®ä¾å­˜é…åˆ—å•é¡Œ**

**Before: Infinite render loops**
```typescript
// âŒ Problem: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¾å­˜é…åˆ—ã«å…¥ã‚Œã‚‹ã¨ç„¡é™ãƒ«ãƒ¼ãƒ—
function useStockData(config: StockConfig) {
  const [data, setData] = useState(null);
  
  useEffect(() => {
    fetchData(config).then(setData);
  }, [config]); // config ã¯æ¯å›æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ ç„¡é™ãƒ«ãƒ¼ãƒ—
  
  return data;
}

// å‘¼ã³å‡ºã—å´
<StockChart config={{ symbol: 'AAPL', interval: '1D' }} />
```

**After: Stable dependencies or TanStack Query**
```typescript
// âœ… Solution 1: ä¾å­˜é…åˆ—ã‚’å®‰å®šåŒ–
function useStockData(symbol: string, interval: string) {
  const [data, setData] = useState(null);
  
  useEffect(() => {
    fetchData({ symbol, interval }).then(setData);
  }, [symbol, interval]); // ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å€¤ã®ã¿
  
  return data;
}

// å‘¼ã³å‡ºã—å´
<StockChart symbol="AAPL" interval="1D" />

// âœ… Solution 2: TanStack Query ã§ useEffect ä¸è¦
function useStockData(symbol: string, interval: string) {
  return useQuery({
    queryKey: ['stock', symbol, interval],
    queryFn: () => fetchData({ symbol, interval }),
    staleTime: 60000, // 1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  });
}

// è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€å†å–å¾—ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†
const { data, isLoading, error } = useStockData('AAPL', '1D');
```

**Verification Steps:**
```bash
# 1. å€‹åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
npm test -- StockCard.test.tsx

# 2. çµ±åˆãƒ†ã‚¹ãƒˆ
npm test -- integration/

# 3. ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
npm test -- --coverage --collectCoverageFrom="app/components/**/*.tsx"

# 4. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
npm run dev
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000/test-components
```

### Step 4: ãƒ¢ãƒ€ãƒ³åŒ– (Modernization)
ä¿®æ­£ã—ãŸç®‡æ‰€ã‚’é †æ¬¡ TanStack Query ã‚„ Zod ã‚’ç”¨ã„ãŸãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚³ãƒ¼ãƒ‰ã«æ˜‡è¯ã•ã›ã‚‹ã€‚

**Complete Migration Example: Manual fetch â†’ TanStack Query + Zod**

**Before: Manual fetch with useEffect (å•é¡ŒãŒå¤šã„)**
```typescript
// âŒ Problems:
// 1. ç«¶åˆçŠ¶æ…‹: é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã§å¤ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸Šæ›¸ã
// 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—: åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½•åº¦ã‚‚å–å¾—
// 3. ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒä¸å®Œå…¨
// 4. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†ãŒè¤‡é›‘
// 5. å‹å®‰å…¨æ€§ãªã—: APIå¤‰æ›´ã«æ°—ã¥ã‹ãªã„

// app/components/StockDashboard.tsx
const [data, setData] = useState<any>(null); // any å‹
const [loading, setLoading] = useState(true);
const [error, setError] = useState<Error | null>(null);

useEffect(() => {
  let cancelled = false;
  
  setLoading(true);
  setError(null);
  
  fetch('/api/stocks?symbol=AAPL')
    .then(res => res.json())
    .then(json => {
      if (!cancelled) {
        setData(json); // å‹ãƒã‚§ãƒƒã‚¯ãªã—
        setLoading(false);
      }
    })
    .catch(err => {
      if (!cancelled) {
        setError(err);
        setLoading(false);
      }
    });
  
  return () => { cancelled = true; };
}, []);

if (loading) return <div>Loading...</div>;
if (error) return <div>Error: {error.message}</div>;
if (!data) return null;

return <div>{data.price}</div>; // data.price ãŒ undefined ã§ã‚‚ã‚¨ãƒ©ãƒ¼ãªã—
```

**After: TanStack Query with Zod validation (ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)**

**Step 1: Define Zod schema**
```typescript
// app/lib/schemas/stock.ts
import { z } from 'zod';

export const StockDataSchema = z.object({
  symbol: z.string().min(1).max(10),
  price: z.number().positive(),
  change: z.number(),
  changePercent: z.number(),
  volume: z.number().int().nonnegative(),
  lastUpdated: z.string().datetime(),
});

export type StockData = z.infer<typeof StockDataSchema>;
```

**Step 2: Create type-safe API client**
```typescript
// app/lib/api/stockClient.ts
import { StockDataSchema, type StockData } from '@/lib/schemas/stock';

export async function fetchStockData(symbol: string): Promise<StockData> {
  const response = await fetch(`/api/stocks?symbol=${encodeURIComponent(symbol)}`);
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  
  const json = await response.json();
  
  // å®Ÿè¡Œæ™‚ã«å‹ã‚’æ¤œè¨¼ã€‚APIå¤‰æ›´ãŒã‚ã‚Œã°ã“ã“ã§å³åº§ã«ã‚¨ãƒ©ãƒ¼
  try {
    return StockDataSchema.parse(json);
  } catch (error) {
    if (error instanceof z.ZodError) {
      console.error('API response validation failed:', error.errors);
      console.error('Received data:', json);
      throw new Error(`Invalid API response: ${error.errors[0].message}`);
    }
    throw error;
  }
}
```

**Step 3: Create custom hook with TanStack Query**
```typescript
// app/hooks/useStockData.ts
import { useQuery } from '@tanstack/react-query';
import { fetchStockData } from '@/lib/api/stockClient';
import type { StockData } from '@/lib/schemas/stock';

interface UseStockDataOptions {
  symbol: string;
  refetchInterval?: number;
  enabled?: boolean;
}

export function useStockData({ 
  symbol, 
  refetchInterval = 60000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1åˆ†
  enabled = true 
}: UseStockDataOptions) {
  return useQuery({
    queryKey: ['stock', symbol],
    queryFn: () => fetchStockData(symbol),
    staleTime: 30000, // 30ç§’é–“ã¯æ–°é®®
    refetchInterval,
    enabled,
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}
```

**Step 4: Use in component**
```typescript
// app/components/StockDashboard.tsx
import { useStockData } from '@/hooks/useStockData';

export function StockDashboard({ symbol }: { symbol: string }) {
  const { data, isLoading, error, refetch } = useStockData({ 
    symbol,
    refetchInterval: 60000 
  });
  
  // âœ… Benefits:
  // - è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥: åŒã˜ã‚·ãƒ³ãƒœãƒ«ã¯å†åˆ©ç”¨
  // - è‡ªå‹•å†è©¦è¡Œ: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã§3å›ãƒªãƒˆãƒ©ã‚¤
  // - ç«¶åˆçŠ¶æ…‹ãªã—: æœ€æ–°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿é©ç”¨
  // - å®Œå…¨ãªå‹å®‰å…¨æ€§: data ã¯ StockData å‹
  // - è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥: 1åˆ†ã”ã¨ã«æ›´æ–°
  
  if (isLoading) {
    return <div className="animate-pulse">Loading {symbol}...</div>;
  }
  
  if (error) {
    return (
      <div className="error">
        <p>Failed to load {symbol}: {error.message}</p>
        <button onClick={() => refetch()}>Retry</button>
      </div>
    );
  }
  
  // data ã¯å¿…ãš StockData å‹ã€‚undefined ãƒã‚§ãƒƒã‚¯ä¸è¦
  return (
    <div>
      <h2>{data.symbol}</h2>
      <p className="price">${data.price.toFixed(2)}</p>
      <p className={data.change >= 0 ? 'positive' : 'negative'}>
        {data.change >= 0 ? '+' : ''}{data.changePercent.toFixed(2)}%
      </p>
      <p className="volume">Volume: {data.volume.toLocaleString()}</p>
      <p className="updated">Updated: {new Date(data.lastUpdated).toLocaleString()}</p>
    </div>
  );
}
```

**Step 5: Setup QueryClient provider**
```typescript
// app/layout.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState } from 'react';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60000,
        retry: 2,
      },
    },
  }));
  
  return (
    <html lang="ja">
      <body>
        <QueryClientProvider client={queryClient}>
          {children}
          {process.env.NODE_ENV === 'development' && <ReactQueryDevtools />}
        </QueryClientProvider>
      </body>
    </html>
  );
}
```

**Testing the modernized code:**
```typescript
// app/hooks/__tests__/useStockData.test.tsx
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useStockData } from '../useStockData';
import * as stockClient from '@/lib/api/stockClient';

jest.mock('@/lib/api/stockClient');

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
    },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}

test('fetches and caches stock data', async () => {
  const mockData = {
    symbol: 'AAPL',
    price: 150.00,
    change: 2.50,
    changePercent: 1.69,
    volume: 50000000,
    lastUpdated: '2024-01-01T12:00:00Z',
  };
  
  jest.spyOn(stockClient, 'fetchStockData').mockResolvedValue(mockData);
  
  const { result } = renderHook(() => useStockData({ symbol: 'AAPL' }), {
    wrapper: createWrapper(),
  });
  
  expect(result.current.isLoading).toBe(true);
  
  await waitFor(() => expect(result.current.isSuccess).toBe(true));
  
  expect(result.current.data).toEqual(mockData);
  expect(stockClient.fetchStockData).toHaveBeenCalledTimes(1);
});
```

#### å®Ÿéš›ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»è¡Œã‚¬ã‚¤ãƒ‰ (Step-by-Step Component Migration)

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å®Ÿéš›ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ useEffect+fetch ã‹ã‚‰ TanStack Query ã«ç§»è¡Œã™ã‚‹å…·ä½“çš„ãªæ‰‹é †ã‚’ç¤ºã—ã¾ã™ã€‚

**å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: StockDashboard.tsx**

**Step 1: ç¾åœ¨ã®å®Ÿè£…ã‚’åˆ†æ**

```typescript
// app/components/StockDashboard.tsx (Before)
'use client';

import { useState, useEffect } from 'react';

interface StockData {
  symbol: string;
  price: number;
  change: number;
  volume: number;
}

export function StockDashboard({ symbol }: { symbol: string }) {
  const [data, setData] = useState<StockData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  
  useEffect(() => {
    let cancelled = false;
    
    setLoading(true);
    setError(null);
    
    fetch(`/api/stocks?symbol=${symbol}`)
      .then(res => res.json())
      .then(json => {
        if (!cancelled) {
          setData(json);
          setLoading(false);
        }
      })
      .catch(err => {
        if (!cancelled) {
          setError(err);
          setLoading(false);
        }
      });
    
    return () => { cancelled = true; };
  }, [symbol]);
  
  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  if (!data) return null;
  
  return (
    <div className="stock-card">
      <h2>{data.symbol}</h2>
      <p className="price">${data.price}</p>
      <p className={data.change >= 0 ? 'positive' : 'negative'}>
        {data.change >= 0 ? '+' : ''}{data.change}
      </p>
      <p className="volume">Vol: {data.volume.toLocaleString()}</p>
    </div>
  );
}
```

**å•é¡Œç‚¹:**
- âŒ ç«¶åˆçŠ¶æ…‹: symbol ãŒå¤‰ã‚ã‚‹ã¨å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çµæœã§ä¸Šæ›¸ãã•ã‚Œã‚‹å¯èƒ½æ€§
- âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—: åŒã˜ã‚·ãƒ³ãƒœãƒ«ã‚’ä½•åº¦ã‚‚å–å¾—
- âŒ ã‚¨ãƒ©ãƒ¼å†è©¦è¡Œãªã—: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã§å³åº§ã«å¤±æ•—
- âŒ å‹å®‰å…¨æ€§ãªã—: APIå¤‰æ›´ã«æ°—ã¥ã‹ãªã„

---

**Step 2: Zodã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆ**

```bash
# ã‚¹ã‚­ãƒ¼ãƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
$ mkdir -p app/lib/schemas
$ touch app/lib/schemas/stock.ts
```

```typescript
// app/lib/schemas/stock.ts
import { z } from 'zod';

export const StockDataSchema = z.object({
  symbol: z.string().min(1).max(10),
  price: z.number().positive(),
  change: z.number(),
  changePercent: z.number(),
  volume: z.number().int().nonnegative(),
  lastUpdated: z.string().datetime(),
});

export type StockData = z.infer<typeof StockDataSchema>;
```

**ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ :**
```typescript
// app/lib/schemas/__tests__/stock.test.ts
import { StockDataSchema } from '../stock';

describe('StockDataSchema', () => {
  test('validates correct stock data', () => {
    const validData = {
      symbol: 'AAPL',
      price: 150.00,
      change: 2.50,
      changePercent: 1.69,
      volume: 50000000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    expect(() => StockDataSchema.parse(validData)).not.toThrow();
  });
  
  test('rejects negative price', () => {
    const invalidData = {
      symbol: 'AAPL',
      price: -150.00, // âŒ è² ã®ä¾¡æ ¼
      change: 0,
      changePercent: 0,
      volume: 0,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    expect(() => StockDataSchema.parse(invalidData)).toThrow();
  });
});
```

```bash
# ã‚¹ã‚­ãƒ¼ãƒã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
$ npm test -- stock.test.ts
PASS app/lib/schemas/__tests__/stock.test.ts
```

---

**Step 3: å‹å®‰å…¨ãªAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ**

```bash
$ mkdir -p app/lib/api
$ touch app/lib/api/stockClient.ts
```

```typescript
// app/lib/api/stockClient.ts
import { StockDataSchema, type StockData } from '@/lib/schemas/stock';

export async function fetchStockData(symbol: string): Promise<StockData> {
  const response = await fetch(`/api/stocks?symbol=${encodeURIComponent(symbol)}`);
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  
  const json = await response.json();
  
  // å®Ÿè¡Œæ™‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  try {
    return StockDataSchema.parse(json);
  } catch (error) {
    if (error instanceof z.ZodError) {
      console.error('API validation failed:', error.errors);
      console.error('Received:', json);
      throw new Error(`Invalid API response: ${error.errors[0].message}`);
    }
    throw error;
  }
}
```

**APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ:**
```typescript
// app/lib/api/__tests__/stockClient.test.ts
import { fetchStockData } from '../stockClient';

global.fetch = jest.fn();

describe('fetchStockData', () => {
  afterEach(() => {
    jest.resetAllMocks();
  });
  
  test('fetches and validates stock data', async () => {
    const mockData = {
      symbol: 'AAPL',
      price: 150.00,
      change: 2.50,
      changePercent: 1.69,
      volume: 50000000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    (global.fetch as jest.Mock).mockResolvedValue({
      ok: true,
      json: async () => mockData,
    });
    
    const result = await fetchStockData('AAPL');
    expect(result).toEqual(mockData);
  });
  
  test('throws on invalid API response', async () => {
    (global.fetch as jest.Mock).mockResolvedValue({
      ok: true,
      json: async () => ({ price: 'not-a-number' }), // âŒ ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿
    });
    
    await expect(fetchStockData('AAPL')).rejects.toThrow('Invalid API response');
  });
});
```

```bash
$ npm test -- stockClient.test.ts
PASS app/lib/api/__tests__/stockClient.test.ts
```

---

**Step 4: ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œæˆ**

```bash
$ mkdir -p app/hooks
$ touch app/hooks/useStockData.ts
```

```typescript
// app/hooks/useStockData.ts
import { useQuery } from '@tanstack/react-query';
import { fetchStockData } from '@/lib/api/stockClient';
import type { StockData } from '@/lib/schemas/stock';

interface UseStockDataOptions {
  symbol: string;
  refetchInterval?: number;
  enabled?: boolean;
}

export function useStockData({ 
  symbol, 
  refetchInterval = 60000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1åˆ†
  enabled = true 
}: UseStockDataOptions) {
  return useQuery<StockData, Error>({
    queryKey: ['stock', symbol],
    queryFn: () => fetchStockData(symbol),
    staleTime: 30000, // 30ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    refetchInterval,
    enabled,
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
}
```

**ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ:**
```typescript
// app/hooks/__tests__/useStockData.test.tsx
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useStockData } from '../useStockData';
import * as stockClient from '@/lib/api/stockClient';

jest.mock('@/lib/api/stockClient');

function createWrapper() {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}

test('fetches stock data successfully', async () => {
  const mockData = {
    symbol: 'AAPL',
    price: 150.00,
    change: 2.50,
    changePercent: 1.69,
    volume: 50000000,
    lastUpdated: '2024-01-01T12:00:00Z',
  };
  
  jest.spyOn(stockClient, 'fetchStockData').mockResolvedValue(mockData);
  
  const { result } = renderHook(() => useStockData({ symbol: 'AAPL' }), {
    wrapper: createWrapper(),
  });
  
  expect(result.current.isLoading).toBe(true);
  
  await waitFor(() => expect(result.current.isSuccess).toBe(true));
  
  expect(result.current.data).toEqual(mockData);
});
```

```bash
$ npm test -- useStockData.test.tsx
PASS app/hooks/__tests__/useStockData.test.tsx
```

---

**Step 5: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**

```typescript
// app/components/StockDashboard.tsx (After)
'use client';

import { useStockData } from '@/hooks/useStockData';

export function StockDashboard({ symbol }: { symbol: string }) {
  const { data, isLoading, error, refetch } = useStockData({ 
    symbol,
    refetchInterval: 60000 
  });
  
  if (isLoading) {
    return (
      <div className="stock-card">
        <div className="animate-pulse">Loading {symbol}...</div>
      </div>
    );
  }
  
  if (error) {
    return (
      <div className="stock-card error">
        <p>Failed to load {symbol}</p>
        <p className="error-message">{error.message}</p>
        <button onClick={() => refetch()} className="retry-button">
          Retry
        </button>
      </div>
    );
  }
  
  // data ã¯å¿…ãš StockData å‹ï¼ˆundefined ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼‰
  return (
    <div className="stock-card">
      <h2>{data.symbol}</h2>
      <p className="price">${data.price.toFixed(2)}</p>
      <p className={data.change >= 0 ? 'positive' : 'negative'}>
        {data.change >= 0 ? '+' : ''}{data.change.toFixed(2)}
      </p>
      <p className="volume">Vol: {data.volume.toLocaleString()}</p>
      <p className="timestamp">
        {new Date(data.lastUpdated).toLocaleTimeString()}
      </p>
    </div>
  );
}
```

**å¤‰æ›´ç‚¹ã®æ¯”è¼ƒ:**
```diff
- import { useState, useEffect } from 'react';
+ import { useStockData } from '@/hooks/useStockData';

- const [data, setData] = useState<StockData | null>(null);
- const [loading, setLoading] = useState(true);
- const [error, setError] = useState<Error | null>(null);
+ const { data, isLoading, error, refetch } = useStockData({ symbol });

- useEffect(() => { /* 20è¡Œã®è¤‡é›‘ãªã‚³ãƒ¼ãƒ‰ */ }, [symbol]);
+ // useEffect ä¸è¦ï¼

- if (loading) return <div>Loading...</div>;
+ if (isLoading) return <div>Loading...</div>;

- if (!data) return null;
+ // data ã¯ undefined ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼ˆisLoading ãŒ false ãªã‚‰å¿…ãšå­˜åœ¨ï¼‰
```

---

**Step 6: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’æ›´æ–°**

```typescript
// app/components/__tests__/StockDashboard.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { StockDashboard } from '../StockDashboard';
import * as stockClient from '@/lib/api/stockClient';

jest.mock('@/lib/api/stockClient');

function renderWithQuery(ui: React.ReactElement) {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } },
  });
  return render(
    <QueryClientProvider client={queryClient}>
      {ui}
    </QueryClientProvider>
  );
}

test('displays stock data after loading', async () => {
  const mockData = {
    symbol: 'AAPL',
    price: 150.00,
    change: 2.50,
    changePercent: 1.69,
    volume: 50000000,
    lastUpdated: '2024-01-01T12:00:00Z',
  };
  
  jest.spyOn(stockClient, 'fetchStockData').mockResolvedValue(mockData);
  
  renderWithQuery(<StockDashboard symbol="AAPL" />);
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç¢ºèª
  expect(screen.getByText(/Loading AAPL/i)).toBeInTheDocument();
  
  // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚’å¾…æ©Ÿ
  await waitFor(() => {
    expect(screen.getByText('AAPL')).toBeInTheDocument();
  });
  
  expect(screen.getByText('$150.00')).toBeInTheDocument();
  expect(screen.getByText('+2.50')).toBeInTheDocument();
});

test('shows error state with retry button', async () => {
  jest.spyOn(stockClient, 'fetchStockData').mockRejectedValue(
    new Error('Network error')
  );
  
  renderWithQuery(<StockDashboard symbol="AAPL" />);
  
  await waitFor(() => {
    expect(screen.getByText(/Failed to load AAPL/i)).toBeInTheDocument();
  });
  
  expect(screen.getByText('Network error')).toBeInTheDocument();
  expect(screen.getByRole('button', { name: /Retry/i })).toBeInTheDocument();
});
```

```bash
$ npm test -- StockDashboard.test.tsx
PASS app/components/__tests__/StockDashboard.test.tsx
```

---

**Step 7: QueryClient ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

```typescript
// app/layout.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState } from 'react';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60000, // 1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        retry: 2,
      },
    },
  }));
  
  return (
    <html lang="ja">
      <body>
        <QueryClientProvider client={queryClient}>
          {children}
          {process.env.NODE_ENV === 'development' && <ReactQueryDevtools />}
        </QueryClientProvider>
      </body>
    </html>
  );
}
```

---

**Step 8: æ¤œè¨¼ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**

```bash
# 1. ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
$ npm test
PASS app/lib/schemas/__tests__/stock.test.ts
PASS app/lib/api/__tests__/stockClient.test.ts
PASS app/hooks/__tests__/useStockData.test.tsx
PASS app/components/__tests__/StockDashboard.test.tsx

Test Suites: 4 passed, 4 total
Tests:       12 passed, 12 total

# 2. å‹ãƒã‚§ãƒƒã‚¯
$ npx tsc --noEmit
âœ“ No errors found

# 3. Lint
$ npm run lint
âœ“ No problems

# 4. ãƒ“ãƒ«ãƒ‰
$ npm run build
âœ“ Compiled successfully

# 5. ä¸è¦ãªã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
$ git rm app/components/StockDashboard.old.tsx

# 6. ã‚³ãƒŸãƒƒãƒˆ
$ git add .
$ git commit -m "refactor: migrate StockDashboard to TanStack Query + Zod"
```

---

**ç§»è¡Œå¾Œã®æ”¹å–„ç‚¹:**

| é …ç›® | Before | After | æ”¹å–„ |
|------|--------|-------|------|
| ã‚³ãƒ¼ãƒ‰è¡Œæ•° | 45è¡Œ | 28è¡Œ | -38% |
| useState/useEffect | 3 + 1 | 0 | å®Œå…¨å‰Šé™¤ |
| ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | æ‰‹å‹• | è‡ªå‹• | è‡ªå‹•å†è©¦è¡Œ |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ãªã— | ã‚ã‚Š | é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰Šæ¸› |
| å‹å®‰å…¨æ€§ | anyå‹ | Zodæ¤œè¨¼ | å®Ÿè¡Œæ™‚ä¿è¨¼ |
| ãƒ†ã‚¹ãƒˆã®è¤‡é›‘ã• | é«˜ | ä½ | ãƒ¢ãƒƒã‚¯ç°¡å˜ |

**Migration Checklist:**
```bash
# 1. Install dependencies
npm install @tanstack/react-query @tanstack/react-query-devtools zod

# 2. Create schemas
mkdir -p app/lib/schemas
touch app/lib/schemas/stock.ts

# 3. Update API clients
# Add Zod validation to all API clients

# 4. Create custom hooks
mkdir -p app/hooks
touch app/hooks/useStockData.ts

# 5. Setup QueryClient
# Update app/layout.tsx

# 6. Migrate components one by one
# Start with leaf components, work up to parents

# 7. Run tests
npm test -- useStockData.test.tsx
npm test -- StockDashboard.test.tsx

# 8. Verify no regressions
npm test
npm run build
```

**Performance Impact:**
```
Before (manual fetch):
- Initial load: 850ms
- Re-renders: 12
- Network requests: 8 (no cache)
- Bundle size: +0KB

After (TanStack Query + Zod):
- Initial load: 720ms (-15%)
- Re-renders: 3 (-75%)
- Network requests: 1 (cached)
- Bundle size: +45KB (query: 38KB, zod: 7KB)

ROI: Improved UX, better DX, fewer bugs
```

### Step 5: ä¸€æ‹¬çµ±åˆ (Orchestration)
è¤‡æ•°ã®PRã‚„ç«¶åˆãƒ–ãƒ©ãƒ³ãƒã‚’ã€ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãªãŒã‚‰é †æ¬¡ `main` ã¸çµ±åˆã—ã€æœ€çµ‚çš„ãªå¥å…¨æ€§ã‚’å…¨ä»¶ãƒ†ã‚¹ãƒˆã§è¨¼æ˜ã™ã‚‹ã€‚

**Complete Integration Workflow**

**Phase 1: Pre-Integration Preparation**
```bash
# 1. ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã®çŠ¶æ…‹ç¢ºèª
git checkout feature/my-branch
git status

# 2. æœ€æ–°ã® main ã‚’å–å¾—
git fetch origin main

# 3. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆï¼ˆã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
git merge --no-commit --no-ff origin/main

# 4. ç«¶åˆãŒã‚ã‚Œã°è§£æ±º
git diff --name-only --diff-filter=U
# å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ç«¶åˆè§£æ±º

# 5. çµ±åˆå¾Œã®ãƒ†ã‚¹ãƒˆ
npm install  # ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°
npm test
npm run lint
npm run build

# 6. å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã‚’ã‚³ãƒŸãƒƒãƒˆ
git commit -m "chore: merge main into feature/my-branch"
```

#### å…·ä½“çš„ãªãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºä¾‹ (Concrete Merge Conflict Resolution)

**ã‚·ãƒŠãƒªã‚ª 1: åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç•°ãªã‚‹ç®‡æ‰€ã‚’ç·¨é›†ï¼ˆç°¡å˜ï¼‰**

```bash
# ãƒãƒ¼ã‚¸å®Ÿè¡Œ
$ git merge origin/main
Auto-merging app/lib/MarketDataService.ts
CONFLICT (content): Merge conflict in app/lib/MarketDataService.ts
Automatic merge failed; fix conflicts and then commit the result.

# ç«¶åˆç®‡æ‰€ã‚’ç¢ºèª
$ cat app/lib/MarketDataService.ts
```

```typescript
// app/lib/MarketDataService.ts
export class MarketDataService {
  private cache = new Map<string, StockData>();
  
<<<<<<< HEAD (feature/my-branch)
  async fetchStockData(symbol: string): Promise<StockData> {
    // è‡ªåˆ†ã®ãƒ–ãƒ©ãƒ³ãƒ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
    const cached = this.cache.get(symbol);
    if (cached && Date.now() - cached.timestamp < 60000) {
      return cached;
    }
=======
  async fetchStockData(symbol: string): Promise<StockData> {
    // main ãƒ–ãƒ©ãƒ³ãƒ: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
    try {
      const response = await fetch(`/api/stocks?symbol=${symbol}`);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response.json();
    } catch (error) {
      console.error('Failed to fetch stock data:', error);
      throw error;
    }
>>>>>>> origin/main
  }
}
```

**è§£æ±ºæ‰‹é †:**
```bash
# Step 1: ä¸¡æ–¹ã®å¤‰æ›´ã‚’çµ±åˆï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç·¨é›†ï¼‰
# ç·¨é›†å¾Œã® app/lib/MarketDataService.ts:
```

```typescript
export class MarketDataService {
  private cache = new Map<string, StockData>();
  
  async fetchStockData(symbol: string): Promise<StockData> {
    // ä¸¡æ–¹ã®æ©Ÿèƒ½ã‚’çµ±åˆ
    const cached = this.cache.get(symbol);
    if (cached && Date.now() - cached.timestamp < 60000) {
      return cached; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§ãƒ•ã‚§ãƒƒãƒ
    try {
      const response = await fetch(`/api/stocks?symbol=${symbol}`);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();
      this.cache.set(symbol, { ...data, timestamp: Date.now() });
      return data;
    } catch (error) {
      console.error('Failed to fetch stock data:', error);
      throw error;
    }
  }
}
```

```bash
# Step 2: ç«¶åˆè§£æ±ºã‚’ãƒãƒ¼ã‚¯
$ git add app/lib/MarketDataService.ts

# Step 3: ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼
$ npm test -- MarketDataService.test.ts
PASS app/lib/__tests__/MarketDataService.test.ts
  âœ“ fetchStockData returns cached data (12 ms)
  âœ“ fetchStockData handles errors (8 ms)

# Step 4: ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆ
$ git commit -m "chore: merge main - integrate cache and error handling"
```

---

**ã‚·ãƒŠãƒªã‚ª 2: åŒã˜é–¢æ•°ã‚’ç•°ãªã‚‹æ–¹æ³•ã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆè¤‡é›‘ï¼‰**

```bash
$ git merge origin/main
CONFLICT (content): Merge conflict in app/lib/technicalAnalysis/RSICalculator.ts
```

```typescript
// app/lib/technicalAnalysis/RSICalculator.ts
<<<<<<< HEAD (feature/optimize-rsi)
// è‡ªåˆ†ã®ãƒ–ãƒ©ãƒ³ãƒ: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
export function calculateRSI(prices: number[], period = 14): number[] {
  // O(n) å®Ÿè£…: ç§»å‹•å¹³å‡ã‚’åŠ¹ç‡çš„ã«è¨ˆç®—
  const gains: number[] = [];
  const losses: number[] = [];
  
  for (let i = 1; i < prices.length; i++) {
    const diff = prices[i] - prices[i - 1];
    gains.push(diff > 0 ? diff : 0);
    losses.push(diff < 0 ? -diff : 0);
  }
  
  // ç§»å‹•å¹³å‡ã‚’1ãƒ‘ã‚¹ã§è¨ˆç®—
  let avgGain = gains.slice(0, period).reduce((a, b) => a + b) / period;
  let avgLoss = losses.slice(0, period).reduce((a, b) => a + b) / period;
  
  // ... ç¶šã
}
=======
// main ãƒ–ãƒ©ãƒ³ãƒ: å‹å®‰å…¨æ€§ã‚’å‘ä¸Š
export function calculateRSI(
  prices: readonly number[], 
  period: number = 14
): { values: number[]; period: number; error?: string } {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
  if (prices.length < period + 1) {
    return { values: [], period, error: 'Insufficient data' };
  }
  
  if (prices.some(p => p < 0)) {
    return { values: [], period, error: 'Negative prices not allowed' };
  }
  
  // æ—¢å­˜ã®å®Ÿè£…ï¼ˆO(n^2) ã ãŒå®‰å…¨ï¼‰
  const rsi: number[] = [];
  for (let i = period; i < prices.length; i++) {
    const gains = [];
    const losses = [];
    for (let j = i - period; j < i; j++) {
      const change = prices[j + 1] - prices[j];
      if (change > 0) gains.push(change);
      else losses.push(-change);
    }
    // ... ç¶šã
  }
  
  return { values: rsi, period };
}
>>>>>>> origin/main
```

**è§£æ±ºæ‰‹é †:**
```bash
# Step 1: ä¸¡æ–¹ã®ãƒ–ãƒ©ãƒ³ãƒã®å®Œå…¨ãªå®Ÿè£…ã‚’ç¢ºèª
$ git show HEAD:app/lib/technicalAnalysis/RSICalculator.ts > /tmp/my-version.ts
$ git show origin/main:app/lib/technicalAnalysis/RSICalculator.ts > /tmp/main-version.ts

# Step 2: å·®åˆ†ã‚’æ¯”è¼ƒ
$ diff -u /tmp/my-version.ts /tmp/main-version.ts
# - è‡ªåˆ†ã®ãƒ–ãƒ©ãƒ³ãƒ: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼ˆO(n)ï¼‰
# - main: å‹å®‰å…¨æ€§ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

# Step 3: ä¸¡æ–¹ã®åˆ©ç‚¹ã‚’çµ±åˆï¼ˆãƒ™ã‚¹ãƒˆã‚ªãƒ–ãƒœã‚¹ï¼‰
# ç·¨é›†å¾Œã® app/lib/technicalAnalysis/RSICalculator.ts:
```

```typescript
/**
 * RSIã‚’è¨ˆç®—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– + å‹å®‰å…¨ï¼‰
 * @param prices - ä¾¡æ ¼é…åˆ—ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
 * @param period - RSIæœŸé–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ14ï¼‰
 * @returns RSIå€¤ã€æœŸé–“ã€ã‚¨ãƒ©ãƒ¼æƒ…å ±
 */
export function calculateRSI(
  prices: readonly number[],
  period: number = 14
): { values: number[]; period: number; error?: string } {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ï¼‰
  if (prices.length < period + 1) {
    return { values: [], period, error: 'Insufficient data' };
  }
  
  if (prices.some(p => p < 0)) {
    return { values: [], period, error: 'Negative prices not allowed' };
  }
  
  // O(n) å®Ÿè£…ï¼ˆfeature/optimize-rsi ã‹ã‚‰ï¼‰
  const gains: number[] = [];
  const losses: number[] = [];
  
  for (let i = 1; i < prices.length; i++) {
    const diff = prices[i] - prices[i - 1];
    gains.push(diff > 0 ? diff : 0);
    losses.push(diff < 0 ? -diff : 0);
  }
  
  const rsiValues: number[] = [];
  let avgGain = gains.slice(0, period).reduce((a, b) => a + b) / period;
  let avgLoss = losses.slice(0, period).reduce((a, b) => a + b) / period;
  
  for (let i = period; i < prices.length; i++) {
    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    rsiValues.push(rsi);
    
    // Wilder's smoothing
    avgGain = (avgGain * (period - 1) + gains[i]) / period;
    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
  }
  
  return { values: rsiValues, period };
}
```

```bash
# Step 4: ãƒ†ã‚¹ãƒˆã§ä¸¡æ–¹ã®è¦ä»¶ã‚’æ¤œè¨¼
$ npm test -- RSICalculator.test.ts

# âœ“ å‹å®‰å…¨æ€§ã®ãƒ†ã‚¹ãƒˆ
test('rejects negative prices', () => {
  const result = calculateRSI([-10, 20, 30], 2);
  expect(result.error).toBe('Negative prices not allowed');
});

# âœ“ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
test('calculates 1000 data points efficiently', () => {
  const prices = Array.from({ length: 1000 }, (_, i) => 100 + Math.random() * 10);
  const start = performance.now();
  calculateRSI(prices, 14);
  const duration = performance.now() - start;
  expect(duration).toBeLessThan(10); // 10ms ä»¥å†…
});

# Step 5: ç«¶åˆè§£æ±ºã‚’å®Œäº†
$ git add app/lib/technicalAnalysis/RSICalculator.ts
$ git commit -m "chore: merge main - combine O(n) optimization with type safety"
```

---

**ã‚·ãƒŠãƒªã‚ª 3: ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã¨ç·¨é›†ã®ç«¶åˆï¼ˆãƒ‡ãƒªã‚±ãƒ¼ãƒˆï¼‰**

```bash
$ git merge origin/main
CONFLICT (modify/delete): app/lib/LegacyService.ts deleted in origin/main and modified in HEAD.
```

**çŠ¶æ³åˆ†æ:**
- **main ãƒ–ãƒ©ãƒ³ãƒ**: `LegacyService.ts` ã‚’å‰Šé™¤ï¼ˆæ–°ã—ã„ `ModernService.ts` ã«ç§»è¡Œæ¸ˆã¿ï¼‰
- **è‡ªåˆ†ã®ãƒ–ãƒ©ãƒ³ãƒ**: `LegacyService.ts` ã«ãƒã‚°ä¿®æ­£ã‚’è¿½åŠ 

**è§£æ±ºæ‰‹é †:**
```bash
# Step 1: å‰Šé™¤ã®ç†ç”±ã‚’ç¢ºèª
$ git log origin/main --oneline --all -- app/lib/LegacyService.ts
a1b2c3d refactor: replace LegacyService with ModernService

$ git show a1b2c3d
# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ ModernService ã¸ã®ç§»è¡Œã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

# Step 2: è‡ªåˆ†ã®å¤‰æ›´ã‚’ ModernService ã«ç§»æ¤
$ git show HEAD:app/lib/LegacyService.ts > /tmp/my-changes.ts
$ vimdiff /tmp/my-changes.ts app/lib/ModernService.ts

# è‡ªåˆ†ã®ãƒã‚°ä¿®æ­£ã‚’ ModernService ã«é©ç”¨
# ä¾‹: null ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ 
# Before (LegacyService.ts):
#   if (data) { return data.value; }
# After (ModernService.ts ã«é©ç”¨):
#   if (data && data.value !== undefined) { return data.value; }

# Step 3: å‰Šé™¤ã‚’å—ã‘å…¥ã‚Œã‚‹
$ git rm app/lib/LegacyService.ts

# Step 4: ModernService ã«å¤‰æ›´ã‚’è¿½åŠ 
$ git add app/lib/ModernService.ts

# Step 5: ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼
$ npm test -- ModernService.test.ts
PASS app/lib/__tests__/ModernService.test.ts
  âœ“ handles null data gracefully (5 ms)

# Step 6: ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆ
$ git commit -m "chore: merge main - migrate bug fix from LegacyService to ModernService"
```

---

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”» (Rollback Strategy)**

ãƒãƒ¼ã‚¸å¾Œã«å•é¡ŒãŒç™ºè¦šã—ãŸå ´åˆã®å¾©æ—§æ‰‹é †:

```bash
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 1: ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’å–ã‚Šæ¶ˆã—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰
$ git reset --hard HEAD~1  # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã«æˆ»ã‚‹
# æ³¨æ„: push å‰ã®ã¿ä½¿ç”¨å¯èƒ½

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 2: ãƒãƒ¼ã‚¸ã‚’æ‰“ã¡æ¶ˆã™æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆï¼ˆpush å¾Œï¼‰
$ git revert -m 1 HEAD
# -m 1: æœ€åˆã®è¦ªï¼ˆmainï¼‰ã«æˆ»ã‚‹
# æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã€å±¥æ­´ã¯æ®‹ã‚‹

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 3: ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’æˆ»ã™
$ git checkout HEAD~1 -- app/lib/ProblematicFile.ts
$ git commit -m "revert: rollback ProblematicFile.ts to previous version"

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 4: ç·Šæ€¥ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹
# å•é¡Œã®ã‚ã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ main ã‚’é€²ã‚ã‚‹
$ git checkout -b hotfix/emergency-fix main~1  # å•é¡Œã®å‰ã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰åˆ†å²
$ # ä¿®æ­£ã‚’é©ç”¨
$ git checkout main
$ git reset --hard hotfix/emergency-fix
$ git push --force-with-lease origin main  # æ…é‡ã«ï¼
```

**Phase 2: Dependency-Ordered Integration**

**Scenario: 3ã¤ã®ãƒ–ãƒ©ãƒ³ãƒã‚’çµ±åˆ**
- `feature/auth-store` - èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- `feature/data-fetching` - TanStack Query ã¸ã®ç§»è¡Œï¼ˆauth-store ã«ä¾å­˜ï¼‰
- `feature/ui-improvements` - UIæ”¹å–„ï¼ˆdata-fetching ã«ä¾å­˜ï¼‰

**Step-by-Step Integration:**
```bash
# 1. æœ€ã‚‚åŸºç›¤ã¨ãªã‚‹ auth-store ã‹ã‚‰é–‹å§‹
git checkout main
git pull origin main

git checkout feature/auth-store
git rebase main  # æœ€æ–°ã® main ä¸Šã«ãƒªãƒ™ãƒ¼ã‚¹

# ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼
npm install
npm test && npm run lint && npm run build

# å•é¡Œãªã‘ã‚Œã° main ã«ãƒãƒ¼ã‚¸
git checkout main
git merge --no-ff feature/auth-store -m "feat: implement centralized AuthStore"

# CI ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ push
git push origin main

# 2. æ¬¡ã®ä¾å­˜ãƒ–ãƒ©ãƒ³ãƒ data-fetching
git checkout feature/data-fetching
git rebase main  # auth-store ã‚’å«ã‚€æœ€æ–° main ã‚’å–å¾—

# çµ±åˆãƒ†ã‚¹ãƒˆ: auth + data-fetching
npm install
npm test -- --coverage
npm run test:e2e  # E2Eãƒ†ã‚¹ãƒˆã§çµ±åˆã‚’æ¤œè¨¼

# å•é¡Œãªã‘ã‚Œã° main ã«ãƒãƒ¼ã‚¸
git checkout main
git merge --no-ff feature/data-fetching -m "feat: migrate to TanStack Query"
git push origin main

# 3. æœ€çµ‚ãƒ–ãƒ©ãƒ³ãƒ ui-improvements
git checkout feature/ui-improvements
git rebase main

# å…¨ä½“çµ±åˆãƒ†ã‚¹ãƒˆ
npm install
npm test
npm run test:e2e
npm run build

# Performance regression check
npm run test:performance  # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

git checkout main
git merge --no-ff feature/ui-improvements -m "feat: enhance UI with modern patterns"
git push origin main
```

**Phase 3: Post-Integration Validation**

**Complete System Check:**
```bash
# 1. Clean environment
rm -rf node_modules package-lock.json
npm install

# 2. Type safety
npx tsc --noEmit
# Expected: 0 errors

# 3. Linting
npm run lint
# Expected: 0 errors, 0 warnings

# 4. Unit tests
npm test -- --coverage
# Expected: All pass, coverage â‰¥ 80%

# 5. Integration tests
npm run test:integration
# Expected: All pass

# 6. E2E tests
npm run test:e2e
# Expected: All pass

# 7. Build verification
npm run build
# Expected: Build successful

# 8. Visual regression (optional)
npm run test:visual
# Expected: No unexpected UI changes

# 9. Performance check
npm run test:performance
# Expected: No significant regressions
```

**Rollback Plan:**
```bash
# If integration fails and can't be fixed quickly:

# 1. Identify the problematic merge
git log --oneline --graph --all | head -20

# 2. Revert the merge commit (preserves history)
git revert -m 1 <merge-commit-hash>

# 3. Push revert
git push origin main

# 4. Create hotfix branch to address issues
git checkout -b hotfix/integration-issues
# Fix the problems
# Re-test thoroughly
# Create new PR for review
```

**Integration Health Dashboard:**
```bash
# Create a script to check integration health
# scripts/integration-health.sh

#!/bin/bash
set -e  # ã‚¨ãƒ©ãƒ¼ã§åœæ­¢

echo "=== Integration Health Check ==="
echo "Started: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

FAILED=0

# 1. Dependencies
echo "ğŸ“¦ Dependencies"
if npm list --depth=0 2>&1 | grep -E "UNMET|missing" > /dev/null; then
  echo "âŒ FAIL - Missing dependencies detected"
  npm list --depth=0 2>&1 | grep -E "UNMET|missing"
  FAILED=$((FAILED + 1))
else
  TOTAL=$(npm list --depth=0 2>&1 | grep -c "â”œâ”€â”€\|â””â”€â”€" || echo "0")
  echo "âœ… PASS - All $TOTAL dependencies resolved"
fi
echo ""

# 2. TypeScript
echo "ğŸ” TypeScript"
TS_OUTPUT=$(npx tsc --noEmit 2>&1)
if [ $? -eq 0 ]; then
  echo "âœ… PASS - 0 errors found"
else
  ERROR_COUNT=$(echo "$TS_OUTPUT" | grep -c "error TS" || echo "0")
  echo "âŒ FAIL - $ERROR_COUNT errors found"
  echo "$TS_OUTPUT" | head -20  # æœ€åˆã®20è¡Œã‚’è¡¨ç¤º
  FAILED=$((FAILED + 1))
fi
echo ""

# 3. ESLint
echo "ğŸ“ ESLint"
LINT_OUTPUT=$(npm run lint 2>&1)
if [ $? -eq 0 ]; then
  echo "âœ… PASS - No linting errors"
else
  ERROR_COUNT=$(echo "$LINT_OUTPUT" | grep -oP "\d+ error" | grep -oP "\d+" || echo "0")
  WARN_COUNT=$(echo "$LINT_OUTPUT" | grep -oP "\d+ warning" | grep -oP "\d+" || echo "0")
  echo "âŒ FAIL - $ERROR_COUNT errors, $WARN_COUNT warnings"
  echo "$LINT_OUTPUT" | grep "error\|warning" | head -10
  FAILED=$((FAILED + 1))
fi
echo ""

# 4. Unit Tests
echo "ğŸ§ª Unit Tests"
TEST_OUTPUT=$(npm test -- --passWithNoTests --silent --coverage 2>&1)
if [ $? -eq 0 ]; then
  PASSED=$(echo "$TEST_OUTPUT" | grep -oP "\d+ passed" | grep -oP "\d+" || echo "0")
  COVERAGE=$(echo "$TEST_OUTPUT" | grep "All files" | awk '{print $10}' || echo "N/A")
  echo "âœ… PASS - $PASSED tests passed, Coverage: $COVERAGE"
else
  FAILED_TESTS=$(echo "$TEST_OUTPUT" | grep -oP "\d+ failed" | grep -oP "\d+" || echo "0")
  echo "âŒ FAIL - $FAILED_TESTS tests failed"
  echo "$TEST_OUTPUT" | grep "FAIL" | head -5
  FAILED=$((FAILED + 1))
fi
echo ""

# 5. Build
echo "ğŸ—ï¸ Build"
BUILD_START=$(date +%s)
if npm run build > /dev/null 2>&1; then
  BUILD_END=$(date +%s)
  BUILD_TIME=$((BUILD_END - BUILD_START))
  BUILD_SIZE=$(du -sh .next 2>/dev/null | cut -f1 || echo "N/A")
  echo "âœ… PASS - Built in ${BUILD_TIME}s, Size: $BUILD_SIZE"
else
  echo "âŒ FAIL - Build failed"
  npm run build 2>&1 | tail -20
  FAILED=$((FAILED + 1))
fi
echo ""

# 6. E2E Tests (optional)
if command -v playwright &> /dev/null; then
  echo "ğŸ¯ E2E Tests"
  if npm run test:e2e > /dev/null 2>&1; then
    E2E_PASSED=$(npm run test:e2e 2>&1 | grep -oP "\d+ passed" | grep -oP "\d+" || echo "0")
    echo "âœ… PASS - $E2E_PASSED E2E tests passed"
  else
    echo "âŒ FAIL - E2E tests failed"
    FAILED=$((FAILED + 1))
  fi
  echo ""
fi

# Summary
echo "==================================="
echo "Completed: $(date '+%Y-%m-%d %H:%M:%S')"
if [ $FAILED -eq 0 ]; then
  echo "ğŸ‰ All checks passed!"
  exit 0
else
  echo "âš ï¸  $FAILED check(s) failed"
  exit 1
fi
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ› (æˆåŠŸæ™‚):**
```
=== Integration Health Check ===
Started: 2024-01-15 14:30:00

ğŸ“¦ Dependencies
âœ… PASS - All 127 dependencies resolved

ğŸ” TypeScript
âœ… PASS - 0 errors found

ğŸ“ ESLint
âœ… PASS - No linting errors

ğŸ§ª Unit Tests
âœ… PASS - 247 tests passed, Coverage: 82.5%

ğŸ—ï¸ Build
âœ… PASS - Built in 45s, Size: 192M

ğŸ¯ E2E Tests
âœ… PASS - 18 E2E tests passed

===================================
Completed: 2024-01-15 14:32:15
ğŸ‰ All checks passed!
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ› (å¤±æ•—æ™‚):**
```
=== Integration Health Check ===
Started: 2024-01-15 14:30:00

ğŸ“¦ Dependencies
âœ… PASS - All 127 dependencies resolved

ğŸ” TypeScript
âŒ FAIL - 15 errors found
app/lib/MarketDataService.ts(42,15): error TS2339: Property 'userId' does not exist
app/components/Dashboard.tsx(28,3): error TS2322: Type 'string | undefined' is not assignable
app/lib/auth/AuthStore.ts(55,10): error TS2304: Cannot find name 'UserData'
...

ğŸ“ ESLint
âŒ FAIL - 23 errors, 47 warnings
app/components/StockCard.tsx:12:5 - error - Unexpected any @typescript-eslint/no-explicit-any
app/lib/utils.ts:45:3 - warning - React Hook useEffect has a missing dependency
...

ğŸ§ª Unit Tests
âŒ FAIL - 49 tests failed
FAIL app/lib/__tests__/AuthService.test.ts
FAIL app/components/__tests__/Login.test.tsx
FAIL app/lib/__tests__/MarketData.test.ts
...

ğŸ—ï¸ Build
âŒ FAIL - Build failed
Error: app/lib/MarketDataService.ts(42,15): error TS2339
Build failed. Fix errors and try again.

===================================
Completed: 2024-01-15 14:31:45
âš ï¸  4 check(s) failed
```

**ä½¿ç”¨æ–¹æ³•:**
```bash
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹
$ chmod +x scripts/integration-health.sh

# å®Ÿè¡Œ
$ ./scripts/integration-health.sh

# CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã‚€
# .github/workflows/integration.yml:
# - name: Run Integration Health Check
#   run: ./scripts/integration-health.sh
```

**Integration Checklist:**
- [ ] ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒãŒæœ€æ–°ã® main ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã‚‹
- [ ] ä¾å­˜é–¢ä¿‚ã®é †åºã§çµ±åˆã—ã¦ã„ã‚‹
- [ ] å„ãƒãƒ¼ã‚¸å¾Œã«å®Œå…¨ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
- [ ] CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒã™ã¹ã¦ãƒ‘ã‚¹ã—ã¦ã„ã‚‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ãŒãªã„
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«çµ±åˆå®Œäº†ã‚’é€šçŸ¥æ¸ˆã¿

## âš ï¸ ç¦æ­¢äº‹é …
- `any` å‹ã®æ”¾ç½®ã€‚
- è­¦å‘Šï¼ˆWarningï¼‰ã‚’ç„¡è¦–ã—ãŸãƒãƒ¼ã‚¸ã€‚
- ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¢ƒç•Œã‚’æ„è­˜ã—ãªã„ `'use client'` ã®æ¿«ç”¨ã€‚

## âœ… Verification Checklist (æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®‰å®šåŒ–ä½œæ¥­ã‚’å®Œäº†ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã‚’**é †ç•ªã«**ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### Phase 1: åŸºæœ¬æ¤œè¨¼ (Basic Validation)
ã“ã‚Œã‚‰ã¯ã™ã¹ã¦ **MUST PASS** ã§ã™ã€‚1ã¤ã§ã‚‚å¤±æ•—ã—ãŸã‚‰æ¬¡ã«é€²ã¾ãªã„ã§ãã ã•ã„ã€‚

```bash
# å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
cd trading-platform
./scripts/basic-validation.sh
```

- [ ] **ä¾å­˜é–¢ä¿‚ã®æ•´åˆæ€§**
  ```bash
  npm install
  npm list --depth=0 2>&1 | grep -E "UNMET|missing"
  ```
  **Expected:** å‡ºåŠ›ãªã—ï¼ˆã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒè§£æ±ºæ¸ˆã¿ï¼‰
  
  **If fails:**
  ```bash
  # Step 1: å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦è¡Œ
  $ npm install
  
  # Step 2: ãã‚Œã§ã‚‚å¤±æ•—ã™ã‚‹å ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  $ rm -rf node_modules package-lock.json
  $ npm cache clean --force
  $ npm install
  
  # Step 3: ç‰¹å®šã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
  $ npm install <missing-package> --save
  # ã¾ãŸã¯
  $ npm install <missing-package> --save-dev
  
  # Step 4: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç«¶åˆãŒã‚ã‚‹å ´åˆ
  $ npm ls <package-name>  # ä¾å­˜é–¢ä¿‚ãƒ„ãƒªãƒ¼ã‚’ç¢ºèª
  $ npm update <package-name>  # æœ€æ–°ã®äº’æ›ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°
  
  # Step 5: ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆã€package.json ã‚’ç¢ºèª
  $ cat package.json | jq '.dependencies, .devDependencies'
  # ä¸è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  ```

- [ ] **TypeScript å‹ãƒã‚§ãƒƒã‚¯**
  ```bash
  npx tsc --noEmit
  ```
  **Expected:** `Found 0 errors.`
  
  **If fails:**
  ```bash
  # Step 1: ã‚¨ãƒ©ãƒ¼ã®æ•°ã¨ç®‡æ‰€ã‚’ç¢ºèª
  $ npx tsc --noEmit | grep "error TS" | wc -l
  # ä¾‹: 15 errors found
  
  # Step 2: ã‚¨ãƒ©ãƒ¼ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  $ npx tsc --noEmit 2>&1 | grep "error TS" | cut -d':' -f1 | sort | uniq -c
  # ä¾‹:
  #   8 app/lib/MarketDataService.ts
  #   5 app/components/Dashboard.tsx
  #   2 app/types/index.ts
  
  # Step 3: æœ€ã‚‚å¤šãã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¿®æ­£
  $ npx tsc --noEmit | grep "MarketDataService.ts"
  
  # Step 4: ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ä¿®æ­£æ–¹æ³•
  # - "Property 'X' does not exist" â†’ å‹å®šç¾©ã‚’ç¢ºèª
  # - "Type 'X' is not assignable" â†’ å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯å‹ã‚¬ãƒ¼ãƒ‰
  # - "Cannot find module" â†’ ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šã‚’ç¢ºèª
  
  # Step 5: æ®µéšçš„ã«æ¤œè¨¼
  $ npx tsc --noEmit --incremental  # ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ“ãƒ«ãƒ‰
  
  # Step 6: tsconfig.json ã®è¨­å®šã‚’ä¸€æ™‚çš„ã«ç·©å’Œï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰
  # "skipLibCheck": true ã‚’è¿½åŠ ï¼ˆæ¨å¥¨ã—ãªã„ï¼‰
  ```

- [ ] **ESLint ãƒã‚§ãƒƒã‚¯**
  ```bash
  npm run lint
  ```
  **Expected:** `âœ“ No ESLint errors or warnings`
  
  **If fails:**
  ```bash
  # Step 1: è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œ
  $ npm run lint:fix
  âœ” Fixed 17 problems
  
  # Step 2: æ®‹ã‚Šã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
  $ npm run lint
  âœ– 30 problems (6 errors, 24 warnings)
  
  # Step 3: ã‚¨ãƒ©ãƒ¼ã‚’ãƒ«ãƒ¼ãƒ«åˆ¥ã«é›†è¨ˆ
  $ npm run lint -- --format json | jq '.[].messages[].ruleId' | sort | uniq -c
  # ä¾‹:
  #  12 @typescript-eslint/no-explicit-any
  #   8 react-hooks/exhaustive-deps
  #   6 no-unused-vars
  #   4 @typescript-eslint/no-non-null-assertion
  
  # Step 4: æœ€ã‚‚å¤šã„ãƒ«ãƒ¼ãƒ«é•åã‹ã‚‰ä¿®æ­£
  # a) no-explicit-any ã®ä¿®æ­£
  $ grep -rn ": any" app/ --include="*.ts" --include="*.tsx"
  # å„ç®‡æ‰€ã§ any â†’ unknown ã¾ãŸã¯å…·ä½“çš„ãªå‹ã«å¤‰æ›´
  
  # b) react-hooks/exhaustive-deps ã®ä¿®æ­£
  $ grep -A 3 "useEffect" app/components/ --include="*.tsx" | grep "\[\]"
  # ä¾å­˜é…åˆ—ã«å¿…è¦ãªå¤‰æ•°ã‚’è¿½åŠ 
  
  # c) no-unused-vars ã®ä¿®æ­£
  $ npm run lint -- --format compact | grep "no-unused-vars"
  # æœªä½¿ç”¨ã®å¤‰æ•°ã‚’å‰Šé™¤
  
  # Step 5: ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
  $ npx eslint app/components/Dashboard.tsx
  
  # Step 6: ä¸€æ™‚çš„ã«ç‰¹å®šã®ãƒ«ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ï¼ˆéæ¨å¥¨ï¼‰
  # /* eslint-disable-next-line rule-name */ ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§è¿½åŠ 
  ```

- [ ] **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ**
  ```bash
  npm test -- --passWithNoTests --coverage
  ```
  **Expected:** 
  - `Tests: X passed, 0 failed`
  - `Coverage: â‰¥ 80% statements, branches, functions, lines`
  
  **If fails:**
  ```bash
  # Step 1: å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ç‰¹å®š
  $ npm test 2>&1 | grep "FAIL"
  # ä¾‹: FAIL app/lib/__tests__/AuthService.test.ts
  
  # Step 2: ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
  $ npm test -- AuthService.test.ts
  
  # Step 3: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
  $ npm test -- --verbose --no-coverage AuthService.test.ts
  
  # Step 4: å¤±æ•—ã®ç¨®é¡åˆ¥ã®å¯¾å‡¦
  # a) "Timeout" ã‚¨ãƒ©ãƒ¼
  $ npm test -- --testTimeout=10000 AuthService.test.ts
  
  # b) "Cannot find element" ã‚¨ãƒ©ãƒ¼
  # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã« screen.debug() ã‚’è¿½åŠ ã—ã¦DOMã‚’ç¢ºèª
  
  # c) "expect(received).toBe(expected)" ã‚¨ãƒ©ãƒ¼
  # å®Ÿéš›ã®å€¤ã‚’ãƒ­ã‚°å‡ºåŠ›
  console.log('Received:', received);
  
  # Step 5: ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ
  $ npm test -- --coverage --collectCoverageFrom="app/lib/**/*.ts"
  $ open coverage/lcov-report/index.html  # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã
  
  # ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
  $ grep -A 1 "Lines.*:" coverage/lcov-report/index.html | grep -E "[0-9]+\.[0-9]+%" | sort -n
  
  # 80%æœªæº€ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
  $ touch app/lib/__tests__/UncoveredService.test.ts
  
  # Step 6: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®æ›´æ–°ãŒå¿…è¦ãªå ´åˆ
  $ npm test -- -u  # ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’æ›´æ–°
  ```

- [ ] **ãƒ“ãƒ«ãƒ‰ã®æˆåŠŸ**
  ```bash
  npm run build
  ```
  **Expected:** `Build completed successfully`
  
  **If fails:**
  ```bash
  # Step 1: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
  $ npm run build 2>&1 | tee build-error.log
  
  # Step 2: ä¸€èˆ¬çš„ãªãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦
  # a) "Module not found" ã‚¨ãƒ©ãƒ¼
  $ grep "Module not found" build-error.log
  # â†’ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‚’ä¿®æ­£ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã®åŒºåˆ¥ã«æ³¨æ„ï¼‰
  
  # b) "Type error" ã‚¨ãƒ©ãƒ¼
  $ npm run build 2>&1 | grep "Type error"
  # â†’ npx tsc --noEmit ã§å‹ã‚¨ãƒ©ãƒ¼ã‚’å…ˆã«ä¿®æ­£
  
  # c) "Out of memory" ã‚¨ãƒ©ãƒ¼
  $ NODE_OPTIONS="--max-old-space-size=4096" npm run build
  
  # d) "ENOSPC: System limit for number of file watchers reached"
  $ echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
  $ sudo sysctl -p
  
  # Step 3: ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ã‚’è©¦è¡Œ
  $ rm -rf .next
  $ npm run build
  
  # Step 4: æ®µéšçš„ã«ãƒ“ãƒ«ãƒ‰
  $ npm run build -- --profile  # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å‡ºåŠ›
  $ npm run build -- --debug     # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
  
  # Step 5: ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã®ã¿ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆNext.jsï¼‰
  # next.config.js ã« experimental.outputFileTracingIncludes ã‚’è¨­å®š
  ```

### Phase 2: ãƒãƒ¼ã‚¸å¾Œã®å“è³ªãƒã‚§ãƒƒã‚¯ (Post-Merge Quality)

- [ ] **æ©Ÿèƒ½ã®ãƒ‡ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒãªã„**
  ```bash
  # ä¸»è¦æ©Ÿèƒ½ã®æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
  npm run dev
  # ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã‚’ç¢ºèª:
  # 1. ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  # 2. æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º
  # 3. ãƒãƒ£ãƒ¼ãƒˆã®æç”»
  # 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  ```
  **Checklist:**
  - [ ] æ—¢å­˜ã®ç”»é¢ãŒã™ã¹ã¦è¡¨ç¤ºã•ã‚Œã‚‹
  - [ ] æ—¢å­˜ã®æ©Ÿèƒ½ãŒã™ã¹ã¦å‹•ä½œã™ã‚‹
  - [ ] ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ãŒãªã„
  - [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£å¸¸

- [ ] **æ–°ã—ã„è­¦å‘ŠãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„**
  ```bash
  # ãƒãƒ¼ã‚¸å‰ã®è­¦å‘Šæ•°ã‚’è¨˜éŒ²
  git checkout main
  npm run lint 2>&1 | grep "warning" | wc -l
  
  # ãƒãƒ¼ã‚¸å¾Œã®è­¦å‘Šæ•°ã‚’ç¢ºèª
  git checkout feature/my-branch
  npm run lint 2>&1 | grep "warning" | wc -l
  ```
  **Expected:** è­¦å‘Šæ•°ãŒå¢—åŠ ã—ã¦ã„ãªã„ï¼ˆæ¸›å°‘ã¯æ­“è¿ï¼‰

- [ ] **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç¶­æŒã¾ãŸã¯æ”¹å–„**
  ```bash
  npm test -- --coverage --silent
  grep "Statements" coverage/coverage-summary.json
  ```
  **Expected:** ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå‰å›ã‚ˆã‚Šä½ä¸‹ã—ã¦ã„ãªã„

- [ ] **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®çµ±ä¸€**
  ```bash
  # npm ã®ã¿ã‚’ä½¿ç”¨ï¼ˆpnpm-lock.yaml ã‚„ yarn.lock ãŒã‚ã£ã¦ã¯ã„ã‘ãªã„ï¼‰
  ls -la | grep -E "pnpm-lock|yarn.lock"
  ```
  **Expected:** ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„
  **If fails:** `rm pnpm-lock.yaml yarn.lock && npm install`

### Phase 3: ãƒ¢ãƒ€ãƒ³åŒ–ã®ç¢ºèª (Modernization Validation)

- [ ] **TanStack Query ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹**ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
  ```bash
  # useQuery/useMutation ã®ä½¿ç”¨ç®‡æ‰€ã‚’ç¢ºèª
  grep -r "useQuery\|useMutation" app/ --include="*.tsx" --include="*.ts"
  
  # å¤ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆuseEffect + fetchï¼‰ãŒæ®‹ã£ã¦ã„ãªã„ã‹
  grep -r "useEffect.*fetch" app/components/ --include="*.tsx"
  ```
  **Expected:** 
  - ãƒ‡ãƒ¼ã‚¿å–å¾—ã« `useQuery` ã‚’ä½¿ç”¨
  - ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã« `useMutation` ã‚’ä½¿ç”¨
  - `useEffect` ã§ã®æ‰‹å‹• fetch ãŒå­˜åœ¨ã—ãªã„

- [ ] **Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹**ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
  ```bash
  # Zod ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©ã‚’ç¢ºèª
  find app/lib/schemas -name "*.ts" -type f
  
  # API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®ä½¿ç”¨ã‚’ç¢ºèª
  grep -r "\.parse\|\.safeParse" app/lib/api/ --include="*.ts"
  ```
  **Expected:**
  - ã™ã¹ã¦ã®å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã« Zod ã‚¹ã‚­ãƒ¼ãƒãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
  - API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ `.parse()` ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹

- [ ] **React 19 ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æº–æ‹ **
  ```bash
  # use client ã®ä½¿ç”¨ç®‡æ‰€ã‚’ç¢ºèª
  grep -r "'use client'" app/ --include="*.tsx" --include="*.ts"
  
  # useEffect ã®ä¾å­˜é…åˆ—ã‚’ç¢ºèª
  grep -A 2 "useEffect" app/components/ --include="*.tsx" | grep -E "\[\]|\.current"
  ```
  **Expected:**
  - `'use client'` ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ©Ÿèƒ½ã‚’ä½¿ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿
  - useEffect ã®ä¾å­˜é…åˆ—ã« `ref.current` ãŒãªã„
  - ä¸è¦ãª useEffect ãŒå­˜åœ¨ã—ãªã„

- [ ] **ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¢ƒç•ŒãŒé©åˆ‡**
  ```bash
  # ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå°‚ç”¨æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ãªã„ã‹
  grep -r "useState\|useEffect\|useContext" app/ --include="*.tsx" | grep -v "use client"
  ```
  **Expected:** å‡ºåŠ›ãªã—ï¼ˆã™ã¹ã¦ã®ãƒ•ãƒƒã‚¯ãŒ 'use client' ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ï¼‰

### Phase 4: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (Documentation)

- [ ] **é‡è¦ãªå¤‰æ›´ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹**
  ```bash
  # è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
  git diff main -- app/lib/ | grep -E "^\+.*\/\/"
  ```
  **Checklist:**
  - [ ] è¤‡é›‘ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆ
  - [ ] å›é¿ç­–ï¼ˆworkaroundï¼‰ã«ç†ç”±ã®ã‚³ãƒ¡ãƒ³ãƒˆ
  - [ ] ãƒ‘ãƒ–ãƒªãƒƒã‚¯APIã« JSDoc ã‚³ãƒ¡ãƒ³ãƒˆ

- [ ] **ç ´å£Šçš„å¤‰æ›´ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**
  ```bash
  # ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ã‚’ç¢ºèª
  git diff main -- .env.example
  
  # README ã®æ›´æ–°ã‚’ç¢ºèª
  git diff main -- README.md
  ```
  **Required updates if:**
  - API ã®ç ´å£Šçš„å¤‰æ›´ â†’ `docs/API.md` æ›´æ–°
  - ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ /å‰Šé™¤ â†’ `.env.example` æ›´æ–°
  - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã®å¤‰æ›´ â†’ `README.md` æ›´æ–°

- [ ] **ç’°å¢ƒå¤‰æ•°ã®åŒæœŸ**
  ```bash
  # .env.example ã«å¿…è¦ãªå¤‰æ•°ãŒã™ã¹ã¦ã‚ã‚‹ã‹
  grep -o "process\.env\.[A-Z_]*" app/ -r --include="*.ts" --include="*.tsx" | \
    sed 's/process\.env\.//' | sort -u
  
  # .env.example ã®å†…å®¹ã¨æ¯”è¼ƒ
  grep "^[A-Z_]*=" .env.example | cut -d= -f1 | sort
  ```
  **Expected:** ä¸¡æ–¹ã®ãƒªã‚¹ãƒˆãŒä¸€è‡´ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã®å¤‰æ•°ã‚’é™¤ãï¼‰

### Phase 5: æœ€çµ‚æ¤œè¨¼ (Final Verification)

- [ ] **E2E ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ**
  ```bash
  npm run test:e2e
  ```
  **Expected:** ã™ã¹ã¦ã® E2E ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹
  **If fails:** ãƒ†ã‚¹ãƒˆãŒç’°å¢ƒä¾å­˜ã®å ´åˆã€CI ãƒ­ã‚°ã§ç¢ºèª

- [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ãªã—**
  ```bash
  # ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®ç¢ºèª
  npm run build
  ls -lh .next/static/chunks/pages/ | awk '{print $5, $9}' | sort -h
  
  # Lighthouse ã‚¹ã‚³ã‚¢ã®ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  npm run lighthouse
  ```
  **Expected:**
  - ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒå¤§å¹…ã«å¢—åŠ ã—ã¦ã„ãªã„ï¼ˆ+10% ä»¥å†…ï¼‰
  - Lighthouse ã‚¹ã‚³ã‚¢ â‰¥ 90 (Performance, Accessibility, Best Practices)

- [ ] **CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç¢ºèª**
  ```bash
  # ãƒ­ãƒ¼ã‚«ãƒ«ã§ CI ã¨åŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
  npm run ci:check  # package.json ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  
  # ã¾ãŸã¯æ‰‹å‹•ã§
  npm install && npm test && npm run lint && npm run build
  ```
  **Expected:** ã™ã¹ã¦ã®ã‚³ãƒãƒ³ãƒ‰ãŒæˆåŠŸ

- [ ] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**
  ```bash
  npm audit
  npm audit --production
  ```
  **Expected:** 
  - `0 vulnerabilities` ã¾ãŸã¯
  - æ—¢çŸ¥ã® false positive ã®ã¿
  **If fails:** `npm audit fix` ã§ä¿®æ­£å¯èƒ½ãªã‚‚ã®ã‚’ä¿®æ­£

### æ¤œè¨¼å®Œäº†å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Post-Verification Actions)

ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹ã—ãŸã‚‰:

1. **å¤‰æ›´ã‚’ main ã«ãƒãƒ¼ã‚¸**
   ```bash
   git checkout main
   git merge --no-ff feature/my-branch -m "feat: description of changes"
   git push origin main
   ```

2. **ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹**ï¼ˆãƒ¡ã‚¸ãƒ£ãƒ¼ãªå¤‰æ›´ã®å ´åˆï¼‰
   ```bash
   git tag -a v1.2.0 -m "Release v1.2.0: Project stabilization"
   git push origin v1.2.0
   ```

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°**
   - CHANGELOG.md ã«å¤‰æ›´å†…å®¹ã‚’è¨˜éŒ²
   - PR ã«æ¤œè¨¼çµæœã‚’æ·»ä»˜
   - Slack/Teams ã§ãƒãƒ¼ãƒ ã«é€šçŸ¥

4. **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   ```bash
   # ãƒãƒ¼ã‚¸æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤
   git branch -d feature/my-branch
   git push origin --delete feature/my-branch
   ```

### ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã™ã¹ã¦ã®æ¤œè¨¼ã‚’ä¸€åº¦ã«å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:

```bash
#!/bin/bash
# scripts/verify-all.sh

set -e  # ã‚¨ãƒ©ãƒ¼ã§åœæ­¢

echo "ğŸ” Phase 1: Basic Validation"
npm install
npx tsc --noEmit
npm run lint
npm test -- --coverage
npm run build

echo "âœ… Phase 1 passed"

echo "ğŸ” Phase 2: Post-Merge Quality"
# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
COVERAGE=$(npm test -- --coverage --silent | grep "All files" | awk '{print $10}' | sed 's/%//')
if [ "$COVERAGE" -lt 80 ]; then
  echo "âŒ Coverage too low: $COVERAGE%"
  exit 1
fi

echo "âœ… Phase 2 passed"

echo "ğŸ” Phase 3: Modernization"
# å¤ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ãªã„ã‹
OLD_PATTERNS=$(grep -r "useEffect.*fetch" app/components/ --include="*.tsx" | wc -l)
if [ "$OLD_PATTERNS" -gt 0 ]; then
  echo "âš ï¸  Warning: $OLD_PATTERNS old useEffect+fetch patterns found"
fi

echo "âœ… Phase 3 passed"

echo "ğŸ” Phase 4: Documentation"
# .env.example ãŒæœ€æ–°ã‹
git diff --quiet .env.example || echo "âš ï¸  .env.example has uncommitted changes"

echo "âœ… Phase 4 passed"

echo "ğŸ” Phase 5: Final Verification"
npm run test:e2e
npm audit --production

echo "âœ… All phases passed! Ready to merge."
```

## ğŸ”§ Common Troubleshooting (ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–)

### Issue 1: ãƒ†ã‚¹ãƒˆãŒç„¡é™ãƒ«ãƒ¼ãƒ—ã™ã‚‹
**ç—‡çŠ¶:**
```bash
$ npm test
Tests are running... (never completes)
CPU usage: 100%
```

**åŸå› :** 
- useEffect ã®ä¾å­˜é…åˆ—ãŒä¸é©åˆ‡
- TanStack Query ã®è¨­å®šãƒŸã‚¹ï¼ˆrefetchInterval ãŒ 0ï¼‰
- ãƒ¢ãƒƒã‚¯ãŒç„¡é™ã« Promise ã‚’è¿”ã™

**è¨ºæ–­:**
```typescript
// Bad: Missing dependencies
useEffect(() => {
  fetchData(userId);
}, []); // userId ã®å¤‰æ›´ãŒæ¤œçŸ¥ã•ã‚Œãªã„

// Bad: Object in dependency array
useEffect(() => {
  fetchData(config);
}, [config]); // config ã¯æ¯å›æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ ç„¡é™ãƒ«ãƒ¼ãƒ—
```

**Solution:**
```typescript
// Good: Proper primitive dependencies
useEffect(() => {
  fetchData(userId);
}, [userId]);

// Better: Use TanStack Query (no useEffect needed)
const { data } = useQuery({
  queryKey: ['user', userId],
  queryFn: () => fetchUser(userId),
  staleTime: 30000, // 30ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
});
```

**Verification:**
```bash
# ãƒ†ã‚¹ãƒˆã‚’ --detectOpenHandles ã§å®Ÿè¡Œ
npm test -- --detectOpenHandles

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦å¼·åˆ¶çµ‚äº†
npm test -- --testTimeout=5000
```

#### ç„¡é™ãƒ«ãƒ¼ãƒ—ã®é«˜åº¦ãªãƒ‡ãƒãƒƒã‚°æ‰‹æ³• (Advanced Infinite Loop Debugging)

**æ–¹æ³• 1: React DevTools Profiler ã§åŸå› ã‚’ç‰¹å®š**

```bash
# 1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
$ npm run dev

# 2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ React DevTools ã‚’é–‹ã
# Chrome DevTools â†’ Components/Profiler ã‚¿ãƒ–

# 3. Profiler ã§ã€ŒRecordã€ã‚’é–‹å§‹
# 4. å•é¡Œã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ“ä½œ
# 5. æ•°ç§’å¾Œã«ã€ŒStopã€
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**
```
Profiler Results:
- StockDashboard: 47 renders in 2s (âŒ ç•°å¸¸ã«å¤šã„)
- useEffect fired: 47 times
- Reason: props.config changed 47 times
```

**è§£æ±ºç­–:**
```typescript
// Before: config ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¯å›æ–°ã—ã„å‚ç…§
<StockDashboard config={{ symbol: 'AAPL', interval: '1D' }} />

// After: useMemo ã§å‚ç…§ã‚’å®‰å®šåŒ–
const config = useMemo(
  () => ({ symbol: 'AAPL', interval: '1D' }),
  [] // ä¾å­˜ãªã— = åˆå›ã®ã¿ä½œæˆ
);
<StockDashboard config={config} />
```

---

**æ–¹æ³• 2: Console.log ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¿½è·¡**

```typescript
// ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export function StockDashboard({ symbol }: { symbol: string }) {
  const renderCount = useRef(0);
  
  useEffect(() => {
    renderCount.current += 1;
    console.log(`ğŸ”„ Render #${renderCount.current}`, {
      symbol,
      timestamp: new Date().toISOString(),
      stack: new Error().stack, // å‘¼ã³å‡ºã—å…ƒã‚’è¿½è·¡
    });
  });
  
  // é€šå¸¸ã®ãƒ­ã‚¸ãƒƒã‚¯
  const { data } = useStockData({ symbol });
  // ...
}
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ› (æ­£å¸¸):**
```
ğŸ”„ Render #1 { symbol: 'AAPL', timestamp: '2024-01-01T12:00:00.000Z' }
ğŸ”„ Render #2 { symbol: 'AAPL', timestamp: '2024-01-01T12:00:01.500Z' } // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†
```

**ç•°å¸¸ãªå‡ºåŠ› (ç„¡é™ãƒ«ãƒ¼ãƒ—):**
```
ğŸ”„ Render #1 { symbol: 'AAPL', timestamp: '2024-01-01T12:00:00.000Z' }
ğŸ”„ Render #2 { symbol: 'AAPL', timestamp: '2024-01-01T12:00:00.050Z' }
ğŸ”„ Render #3 { symbol: 'AAPL', timestamp: '2024-01-01T12:00:00.100Z' }
ğŸ”„ Render #4 { symbol: 'AAPL', timestamp: '2024-01-01T12:00:00.150Z' }
... (continues)
```

---

**æ–¹æ³• 3: Why-Did-You-Render ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨**

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ npm install --save-dev @welldone-software/why-did-you-render
```

```typescript
// app/lib/wdyr.ts (é–‹ç™ºç’°å¢ƒã®ã¿)
if (process.env.NODE_ENV === 'development') {
  const React = require('react');
  const whyDidYouRender = require('@welldone-software/why-did-you-render');
  
  whyDidYouRender(React, {
    trackAllPureComponents: true,
    logOnDifferentValues: true,
    collapseGroups: true,
  });
}

// app/layout.tsx (æœ€ä¸Šéƒ¨)
import './lib/wdyr'; // ãƒ‡ãƒãƒƒã‚°æ™‚ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
```

```typescript
// ãƒ‡ãƒãƒƒã‚°å¯¾è±¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export function StockDashboard({ symbol }: { symbol: string }) {
  // ...
}

// Why-Did-You-Render ã‚’æœ‰åŠ¹åŒ–
StockDashboard.whyDidYouRender = true;
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:**
```
[why-did-you-render] StockDashboard
  Re-rendered because of props changes:
    config: { symbol: 'AAPL', interval: '1D' } â†’ { symbol: 'AAPL', interval: '1D' }
    (same values, different references) âŒ
```

---

**æ–¹æ³• 4: TanStack Query Devtools ã§çŠ¶æ…‹ã‚’ç›£è¦–**

```typescript
// app/layout.tsx
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

**DevTools ã§ç¢ºèªã™ã‚‹é …ç›®:**
- **Fetches**: ãƒ‡ãƒ¼ã‚¿å–å¾—ã®é »åº¦ï¼ˆ1ç§’ã«ä½•å›ã‚‚å–å¾—ã—ã¦ã„ãªã„ã‹ï¼‰
- **Query Status**: `fetching` â†’ `success` ã®ã‚µã‚¤ã‚¯ãƒ«ãŒæ­£å¸¸ã‹
- **Refetch Interval**: è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã®è¨­å®šãŒé©åˆ‡ã‹

**æ­£å¸¸ãªçŠ¶æ…‹:**
```
Query: ['stock', 'AAPL']
Status: success
Data Age: 15s
Refetch Interval: 60s
Last Fetched: 12:00:00
```

**ç•°å¸¸ãªçŠ¶æ…‹ (ç„¡é™ãƒ«ãƒ¼ãƒ—):**
```
Query: ['stock', 'AAPL']
Status: fetching (constantly)
Data Age: 0s
Refetch Interval: 0s âŒ (should be > 0)
Fetch Count: 247 in 5s âŒ
```

**ä¿®æ­£:**
```typescript
// Before: refetchInterval ãŒ 0 ã¾ãŸã¯ undefined
const { data } = useQuery({
  queryKey: ['stock', symbol],
  queryFn: fetchStockData,
  refetchInterval: 0, // âŒ ç„¡é™ãƒ«ãƒ¼ãƒ—ã®åŸå› 
});

// After: é©åˆ‡ãªé–“éš”ã‚’è¨­å®š
const { data } = useQuery({
  queryKey: ['stock', symbol],
  queryFn: fetchStockData,
  refetchInterval: 60000, // âœ… 1åˆ†ã”ã¨
  staleTime: 30000, // 30ç§’é–“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
});
```

---

**æ–¹æ³• 5: Node.js ã® --inspect ã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‡ãƒãƒƒã‚°**

```bash
# Chrome DevTools ã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‡ãƒãƒƒã‚°
$ node --inspect-brk ./node_modules/.bin/jest --runInBand

# åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§
$ node --inspect ./node_modules/.bin/jest --runInBand

# Chrome ã§ chrome://inspect ã‚’é–‹ã
# "Inspect" ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ DevTools ã‚’èµ·å‹•
```

**DevToolsã§ã®æ‰‹é †:**
1. **Sources** ã‚¿ãƒ–ã‚’é–‹ã
2. å•é¡Œã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
3. useEffect ã®ä¸­ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ
4. **Step Over (F10)** ã§1è¡Œãšã¤å®Ÿè¡Œ
5. **Watch** ã§ä¾å­˜é…åˆ—ã®å€¤ã‚’ç›£è¦–

**ç›£è¦–ã™ã‚‹å¤‰æ•°:**
```javascript
// Watch expressions in Chrome DevTools
config                  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã‹
JSON.stringify(config)  // å€¤ã¯åŒã˜ã‹
renderCount.current     // ä½•å›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸã‹
```

---

**æ–¹æ³• 6: Performance API ã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®š**

```typescript
// app/hooks/useStockData.ts
import { useQuery } from '@tanstack/react-query';

export function useStockData({ symbol }: { symbol: string }) {
  const startTime = performance.now();
  
  const result = useQuery({
    queryKey: ['stock', symbol],
    queryFn: async () => {
      const fetchStart = performance.now();
      const data = await fetchStockData(symbol);
      const fetchEnd = performance.now();
      
      console.log(`ğŸ“Š Fetch time: ${(fetchEnd - fetchStart).toFixed(2)}ms`);
      return data;
    },
  });
  
  useEffect(() => {
    const endTime = performance.now();
    console.log(`â±ï¸ Hook execution: ${(endTime - startTime).toFixed(2)}ms`);
  }, [result.dataUpdatedAt]);
  
  return result;
}
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ› (æ­£å¸¸):**
```
ğŸ“Š Fetch time: 125.45ms
â±ï¸ Hook execution: 128.30ms
(1å›ã®ã¿å‡ºåŠ›ã€ãã®å¾Œ60ç§’é–“éš”)
```

**ç•°å¸¸ãªå‡ºåŠ› (ç„¡é™ãƒ«ãƒ¼ãƒ—):**
```
ğŸ“Š Fetch time: 125.45ms
â±ï¸ Hook execution: 128.30ms
ğŸ“Š Fetch time: 126.12ms
â±ï¸ Hook execution: 129.01ms
ğŸ“Š Fetch time: 124.89ms
â±ï¸ Hook execution: 127.78ms
... (continues every 100-200ms)
```

---

**ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ (ç„¡é™ãƒ«ãƒ¼ãƒ—è¨ºæ–­):**

```bash
#!/bin/bash
# scripts/diagnose-infinite-loop.sh

echo "ğŸ” Infinite Loop Diagnostic Tool"
echo "================================="

# 1. useEffect ã®ä¾å­˜é…åˆ—ã‚’ãƒã‚§ãƒƒã‚¯
echo "1. Checking useEffect dependencies..."
grep -rn "useEffect" app/components/ --include="*.tsx" | \
  grep -E "\[.*\{.*\}\]" && \
  echo "âŒ Found object in dependency array" || \
  echo "âœ… No objects in dependency arrays"

# 2. TanStack Query ã®è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
echo "2. Checking TanStack Query config..."
grep -rn "refetchInterval.*0" app/ --include="*.ts" --include="*.tsx" && \
  echo "âŒ Found refetchInterval: 0" || \
  echo "âœ… No invalid refetchInterval"

# 3. ç„¡é™å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å…†å€™ã‚’ãƒã‚§ãƒƒã‚¯
echo "3. Checking for render loops..."
npm test -- --testTimeout=3000 --silent 2>&1 | \
  grep -i "timeout\|exceeded" && \
  echo "âŒ Test timeout detected (possible infinite loop)" || \
  echo "âœ… No test timeouts"

# 4. CPUä½¿ç”¨ç‡ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
echo "4. Monitoring CPU usage during dev server..."
npm run dev &
DEV_PID=$!
sleep 5
CPU=$(ps -p $DEV_PID -o %cpu | tail -n 1)
kill $DEV_PID

if (( $(echo "$CPU > 80" | bc -l) )); then
  echo "âŒ High CPU usage: ${CPU}% (possible infinite loop)"
else
  echo "âœ… Normal CPU usage: ${CPU}%"
fi

echo "================================="
echo "Diagnostic complete. Review output above."
```

```bash
# å®Ÿè¡Œ
$ chmod +x scripts/diagnose-infinite-loop.sh
$ ./scripts/diagnose-infinite-loop.sh
```

---

### Issue 2: Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒæœ¬ç•ªã§ç™ºç”Ÿ
**ç—‡çŠ¶:**
```
ZodError: [
  {
    "code": "invalid_type",
    "expected": "number",
    "received": "string",
    "path": ["price"]
  }
]
```

**åŸå› :** 
- API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ãŒç’°å¢ƒã§ç•°ãªã‚‹
- å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹
- API ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸ä¸€è‡´

**è¨ºæ–­:**
```typescript
// API ãŒè¿”ã™å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
try {
  return DataSchema.parse(json);
} catch (error) {
  if (error instanceof z.ZodError) {
    console.error('Validation failed:', error.errors);
    console.error('Received data:', JSON.stringify(json, null, 2));
    console.error('Expected schema:', DataSchema);
  }
  throw error;
}
```

**Solution:**
```typescript
// 1. ã‚¹ã‚­ãƒ¼ãƒã‚’å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã‚‹
const DataSchema = z.object({
  price: z.union([z.number(), z.string()]).transform(val => 
    typeof val === 'string' ? parseFloat(val) : val
  ),
});

// 2. strict ãƒ¢ãƒ¼ãƒ‰ã§æœªçŸ¥ã®ã‚­ãƒ¼ã‚’æ‹’å¦
const DataSchema = z.object({
  id: z.string(),
  value: z.number(),
}).strict(); // å®šç¾©å¤–ã®ã‚­ãƒ¼ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼

// 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
const DataSchema = z.object({
  price: z.number().default(0),
  change: z.number().optional(),
});

// 4. è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
const DataSchema = z.object({
  price: z.number({
    required_error: "Price is required",
    invalid_type_error: "Price must be a number",
  }),
});
```

**Verification:**
```bash
# ã‚¹ã‚­ãƒ¼ãƒã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
npm test -- schemas/stock.test.ts

# å®Ÿéš›ã® API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒ†ã‚¹ãƒˆ
curl https://api.example.com/stocks/AAPL | jq . > test-data.json
node -e "const schema = require('./app/lib/schemas/stock').StockDataSchema; \
         const data = require('./test-data.json'); \
         console.log(schema.parse(data));"
```

---

#### Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŒ…æ‹¬ãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰ (Comprehensive Zod Testing Guide)

Zodã‚¹ã‚­ãƒ¼ãƒã®å“è³ªã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¿…ãšå®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ:**
```bash
app/lib/schemas/
â”œâ”€â”€ stock.ts                    # ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”œâ”€â”€ __tests__/
â”‚   â”œâ”€â”€ stock.test.ts           # ã‚¹ã‚­ãƒ¼ãƒã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ stock.integration.test.ts # APIã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ
```

---

**ãƒ‘ã‚¿ãƒ¼ãƒ³ 1: åŸºæœ¬çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ**

```typescript
// app/lib/schemas/__tests__/stock.test.ts
import { describe, test, expect } from '@jest/globals';
import { StockDataSchema } from '../stock';

describe('StockDataSchema', () => {
  test('accepts valid stock data', () => {
    const validData = {
      symbol: 'AAPL',
      price: 150.00,
      change: 2.50,
      changePercent: 1.69,
      volume: 50000000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    const result = StockDataSchema.parse(validData);
    expect(result).toEqual(validData);
  });
  
  test('rejects data with missing required fields', () => {
    const invalidData = {
      symbol: 'AAPL',
      // price ãŒæ¬ è½
      change: 2.50,
    };
    
    expect(() => StockDataSchema.parse(invalidData)).toThrow();
  });
  
  test('rejects negative price', () => {
    const invalidData = {
      symbol: 'AAPL',
      price: -150.00, // âŒ è² ã®ä¾¡æ ¼
      change: 0,
      changePercent: 0,
      volume: 0,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    expect(() => StockDataSchema.parse(invalidData)).toThrow('positive');
  });
  
  test('rejects negative volume', () => {
    const invalidData = {
      symbol: 'AAPL',
      price: 150.00,
      change: 0,
      changePercent: 0,
      volume: -1000, // âŒ è² ã®å‡ºæ¥é«˜
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    expect(() => StockDataSchema.parse(invalidData)).toThrow('nonnegative');
  });
  
  test('rejects invalid datetime format', () => {
    const invalidData = {
      symbol: 'AAPL',
      price: 150.00,
      change: 0,
      changePercent: 0,
      volume: 0,
      lastUpdated: 'not-a-datetime', // âŒ ä¸æ­£ãªæ—¥æ™‚
    };
    
    expect(() => StockDataSchema.parse(invalidData)).toThrow('datetime');
  });
  
  test('rejects symbol with special characters', () => {
    const invalidData = {
      symbol: 'A@PL', // âŒ ç‰¹æ®Šæ–‡å­—
      price: 150.00,
      change: 0,
      changePercent: 0,
      volume: 0,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    // ã‚·ãƒ³ãƒœãƒ«ã«è‹±æ•°å­—ã®ã¿ã‚’è¨±å¯ã™ã‚‹å ´åˆ
    expect(() => StockDataSchema.parse(invalidData)).toThrow();
  });
});
```

---

**ãƒ‘ã‚¿ãƒ¼ãƒ³ 2: å¤‰æ›ã¨æ­£è¦åŒ–ã®ãƒ†ã‚¹ãƒˆ**

```typescript
// app/lib/schemas/stock.ts (å¤‰æ›ã‚’å«ã‚€ã‚¹ã‚­ãƒ¼ãƒ)
import { z } from 'zod';

export const StockDataSchema = z.object({
  symbol: z.string().min(1).max(10).transform(s => s.toUpperCase()),
  price: z.union([z.number(), z.string()]).transform(val => 
    typeof val === 'string' ? parseFloat(val) : val
  ),
  volume: z.union([z.number(), z.string()]).transform(val => {
    const num = typeof val === 'string' ? parseInt(val, 10) : val;
    return isNaN(num) ? 0 : num;
  }),
  lastUpdated: z.string().datetime().transform(s => new Date(s)),
});

// app/lib/schemas/__tests__/stock.test.ts (å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ)
describe('StockDataSchema with transformations', () => {
  test('transforms symbol to uppercase', () => {
    const data = {
      symbol: 'aapl', // å°æ–‡å­—
      price: 150.00,
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    const result = StockDataSchema.parse(data);
    expect(result.symbol).toBe('AAPL'); // å¤§æ–‡å­—ã«å¤‰æ›
  });
  
  test('converts string price to number', () => {
    const data = {
      symbol: 'AAPL',
      price: '150.00', // æ–‡å­—åˆ—
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    const result = StockDataSchema.parse(data);
    expect(result.price).toBe(150.00);
    expect(typeof result.price).toBe('number');
  });
  
  test('converts datetime string to Date object', () => {
    const data = {
      symbol: 'AAPL',
      price: 150.00,
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    const result = StockDataSchema.parse(data);
    expect(result.lastUpdated).toBeInstanceOf(Date);
    expect(result.lastUpdated.getFullYear()).toBe(2024);
  });
  
  test('handles edge case of invalid string to number conversion', () => {
    const data = {
      symbol: 'AAPL',
      price: 'not-a-number', // âŒ æ•°å€¤ã«å¤‰æ›ã§ããªã„
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    expect(() => StockDataSchema.parse(data)).toThrow();
  });
});
```

---

**ãƒ‘ã‚¿ãƒ¼ãƒ³ 3: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆ**

```typescript
// app/lib/schemas/__tests__/stock.integration.test.ts
import { describe, test, expect, jest } from '@jest/globals';
import { fetchStockData } from '@/lib/api/stockClient';
import { StockDataSchema } from '../stock';

// å®Ÿéš›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚µãƒ³ãƒ—ãƒ«
const mockAPIResponse = {
  '01. symbol': 'AAPL',
  '05. price': '150.00',
  '06. volume': '50000000',
  '09. change': '2.50',
  '10. change percent': '1.69%',
  'lastRefreshed': '2024-01-01 12:00:00',
};

describe('Stock API integration with Zod', () => {
  test('parses real API response format', () => {
    // APIå½¢å¼ã‚’å†…éƒ¨å½¢å¼ã«å¤‰æ›
    const transformedData = {
      symbol: mockAPIResponse['01. symbol'],
      price: parseFloat(mockAPIResponse['05. price']),
      volume: parseInt(mockAPIResponse['06. volume'], 10),
      change: parseFloat(mockAPIResponse['09. change']),
      changePercent: parseFloat(mockAPIResponse['10. change percent'].replace('%', '')),
      lastUpdated: new Date(mockAPIResponse.lastRefreshed).toISOString(),
    };
    
    // Zodã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    expect(() => StockDataSchema.parse(transformedData)).not.toThrow();
  });
  
  test('catches API format changes', () => {
    const unexpectedFormat = {
      ticker: 'AAPL', // âŒ 'symbol' ã§ã¯ãªã 'ticker'
      price: 150.00,
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    // ã‚¹ã‚­ãƒ¼ãƒãŒå¤‰æ›´ã‚’æ¤œå‡º
    expect(() => StockDataSchema.parse(unexpectedFormat)).toThrow();
  });
  
  test('validates multiple API responses in batch', () => {
    const batchData = [
      { symbol: 'AAPL', price: 150, volume: 1000, lastUpdated: '2024-01-01T12:00:00Z' },
      { symbol: 'GOOGL', price: 2800, volume: 2000, lastUpdated: '2024-01-01T12:00:00Z' },
      { symbol: 'MSFT', price: 350, volume: 3000, lastUpdated: '2024-01-01T12:00:00Z' },
    ];
    
    // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    batchData.forEach(data => {
      expect(() => StockDataSchema.parse(data)).not.toThrow();
    });
  });
});
```

---

**ãƒ‘ã‚¿ãƒ¼ãƒ³ 4: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¨ãƒ†ã‚¹ãƒˆ**

```typescript
// app/lib/schemas/stock.ts (ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)
export const StockDataSchema = z.object({
  symbol: z.string({
    required_error: "ã‚·ãƒ³ãƒœãƒ«ã¯å¿…é ˆã§ã™",
    invalid_type_error: "ã‚·ãƒ³ãƒœãƒ«ã¯æ–‡å­—åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™",
  }).min(1, "ã‚·ãƒ³ãƒœãƒ«ã¯1æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
    .max(10, "ã‚·ãƒ³ãƒœãƒ«ã¯10æ–‡å­—ä»¥å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"),
  
  price: z.number({
    required_error: "ä¾¡æ ¼ã¯å¿…é ˆã§ã™",
    invalid_type_error: "ä¾¡æ ¼ã¯æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™",
  }).positive("ä¾¡æ ¼ã¯æ­£ã®æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"),
  
  volume: z.number({
    required_error: "å‡ºæ¥é«˜ã¯å¿…é ˆã§ã™",
    invalid_type_error: "å‡ºæ¥é«˜ã¯æ•°å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™",
  }).int("å‡ºæ¥é«˜ã¯æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
    .nonnegative("å‡ºæ¥é«˜ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"),
});

// app/lib/schemas/__tests__/stock.test.ts (ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ)
describe('StockDataSchema error messages', () => {
  test('provides custom error message for missing symbol', () => {
    const data = {
      price: 150,
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    try {
      StockDataSchema.parse(data);
      fail('Should have thrown an error');
    } catch (error) {
      expect(error.errors[0].message).toBe('ã‚·ãƒ³ãƒœãƒ«ã¯å¿…é ˆã§ã™');
    }
  });
  
  test('provides custom error message for negative price', () => {
    const data = {
      symbol: 'AAPL',
      price: -150, // âŒ è² ã®ä¾¡æ ¼
      volume: 1000,
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    try {
      StockDataSchema.parse(data);
      fail('Should have thrown an error');
    } catch (error) {
      expect(error.errors[0].message).toBe('ä¾¡æ ¼ã¯æ­£ã®æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    }
  });
  
  test('provides custom error message for non-integer volume', () => {
    const data = {
      symbol: 'AAPL',
      price: 150,
      volume: 1000.5, // âŒ å°æ•°
      lastUpdated: '2024-01-01T12:00:00Z',
    };
    
    try {
      StockDataSchema.parse(data);
      fail('Should have thrown an error');
    } catch (error) {
      expect(error.errors[0].message).toBe('å‡ºæ¥é«˜ã¯æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    }
  });
});
```

---

**ãƒ‘ã‚¿ãƒ¼ãƒ³ 5: æœ¬ç•ªç’°å¢ƒã®ã‚¨ãƒ©ãƒ¼ç›£è¦–**

```typescript
// app/lib/api/stockClient.ts (æœ¬ç•ªç’°å¢ƒç”¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
import { StockDataSchema, type StockData } from '@/lib/schemas/stock';
import * as Sentry from '@sentry/nextjs'; // ã‚¨ãƒ©ãƒ¼è¿½è·¡ãƒ„ãƒ¼ãƒ«

export async function fetchStockData(symbol: string): Promise<StockData> {
  const response = await fetch(`/api/stocks?symbol=${encodeURIComponent(symbol)}`);
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  
  const json = await response.json();
  
  try {
    return StockDataSchema.parse(json);
  } catch (error) {
    if (error instanceof z.ZodError) {
      // æœ¬ç•ªç’°å¢ƒã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²
      const validationError = {
        symbol,
        errors: error.errors,
        receivedData: json,
        timestamp: new Date().toISOString(),
      };
      
      // ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
      Sentry.captureException(error, {
        extra: validationError,
        tags: { type: 'zod_validation_error' },
      });
      
      // é–‹ç™ºç’°å¢ƒã§ã¯è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
      if (process.env.NODE_ENV === 'development') {
        console.error('âŒ Zod Validation Error:');
        console.error('Symbol:', symbol);
        console.error('Errors:', error.errors);
        console.error('Received:', JSON.stringify(json, null, 2));
      }
      
      throw new Error(`API response validation failed: ${error.errors[0].message}`);
    }
    throw error;
  }
}
```

**æœ¬ç•ªã‚¨ãƒ©ãƒ¼ç›£è¦–ã®ãƒ†ã‚¹ãƒˆ:**
```typescript
// app/lib/api/__tests__/stockClient.production.test.ts
import { fetchStockData } from '../stockClient';
import * as Sentry from '@sentry/nextjs';

jest.mock('@sentry/nextjs');

describe('Production error monitoring', () => {
  afterEach(() => {
    jest.clearAllMocks();
  });
  
  test('sends Zod validation errors to Sentry', async () => {
    global.fetch = jest.fn().mockResolvedValue({
      ok: true,
      json: async () => ({ price: 'invalid' }), // âŒ ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿
    });
    
    await expect(fetchStockData('AAPL')).rejects.toThrow();
    
    // Sentryã«ã‚¨ãƒ©ãƒ¼ãŒé€ä¿¡ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    expect(Sentry.captureException).toHaveBeenCalled();
    expect(Sentry.captureException).toHaveBeenCalledWith(
      expect.any(Error),
      expect.objectContaining({
        tags: { type: 'zod_validation_error' },
      })
    );
  });
});
```

---

**æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
```bash
# 1. ã™ã¹ã¦ã®ã‚¹ã‚­ãƒ¼ãƒãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
$ npm test -- schemas/

# 2. ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèª
$ npm test -- schemas/ --coverage
# æœŸå¾…: 100% ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆã‚¹ã‚­ãƒ¼ãƒã¯å°ã•ã„ã®ã§å®Œå…¨ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç›®æŒ‡ã™ï¼‰

# 3. å®Ÿéš›ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒ†ã‚¹ãƒˆ
$ curl https://api.example.com/stocks/AAPL > test-response.json
$ node -e "
  const schema = require('./app/lib/schemas/stock').StockDataSchema;
  const data = require('./test-response.json');
  try {
    const result = schema.parse(data);
    console.log('âœ… Validation passed:', result);
  } catch (error) {
    console.error('âŒ Validation failed:', error.errors);
  }
"

# 4. æœ¬ç•ªç’°å¢ƒã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œï¼‰
# Sentry ã¾ãŸã¯ CloudWatch Logs ã§ 'zod_validation_error' ã‚’æ¤œç´¢
```

### Issue 3: `'use client'` ã‚’è¿½åŠ ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã—ãªã„
**ç—‡çŠ¶:**
```
Error: useState only works in Client Components
```

**åŸå› :** 
- ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå°‚ç”¨æ©Ÿèƒ½ã‚’ä½¿ç”¨
- `'use client'` ã®ä½ç½®ãŒé–“é•ã£ã¦ã„ã‚‹
- è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**è¨ºæ–­:**
```typescript
// âŒ Bad: Server component using client hooks
export default function Page() {
  const [state, setState] = useState(0); // Error!
  return <div>{state}</div>;
}

// âŒ Bad: 'use client' ãŒ import ã®å¾Œ
import { useState } from 'react';
'use client'; // Too late!

// âŒ Bad: Server component importing client without boundary
// app/page.tsx (Server Component)
import { Counter } from './Counter'; // Counter uses useState
export default function Page() {
  return <Counter />;
}
```

**Solution:**
```typescript
// âœ… Good: Separate client component
// app/components/Counter.tsx
'use client';

import { useState } from 'react';

export function Counter() {
  const [state, setState] = useState(0);
  return (
    <div>
      <p>Count: {state}</p>
      <button onClick={() => setState(state + 1)}>Increment</button>
    </div>
  );
}

// âœ… Good: Server component imports client component
// app/page.tsx
import { Counter } from '@/components/Counter';

export default function Page() {
  // Server component - no hooks
  const data = await fetchData(); // Server-side data fetching
  
  return (
    <div>
      <h1>Server Component</h1>
      <Counter /> {/* Client component boundary */}
    </div>
  );
}
```

**Architecture Pattern:**
```
app/
â”œâ”€â”€ page.tsx                 (Server Component)
â”‚   â””â”€â”€ imports ClientWrapper
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ClientWrapper.tsx    ('use client' - boundary)
â”‚   â”‚   â””â”€â”€ imports Counter
â”‚   â””â”€â”€ Counter.tsx          (Client Component)
```

**Verification:**
```bash
# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç¢ºèª
grep -r "'use client'" app/ --include="*.tsx"

# useState/useEffect ãŒ Server Component ã«ãªã„ã‹ç¢ºèª
grep -r "useState\|useEffect" app/page.tsx app/layout.tsx
```

---

### Issue 4: ãƒãƒ¼ã‚¸å¾Œã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç«¶åˆ
**ç—‡çŠ¶:**
```bash
$ npm install
npm ERR! Found: react@19.0.0
npm ERR! Could not resolve dependency:
npm ERR! peer react@"^18.0.0" from @some/package@1.0.0
```

**åŸå› :** 
- è¤‡æ•°ã®ãƒ–ãƒ©ãƒ³ãƒã§ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- peer dependency ã®ä¸ä¸€è‡´
- npm vs pnpm vs yarn ã®æ··åœ¨

**è¨ºæ–­:**
```bash
# ç«¶åˆã—ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç‰¹å®š
npm list react
npm list react-dom

# ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®é‡è¤‡ã‚’ç¢ºèª
ls -la | grep -E "package-lock|pnpm-lock|yarn.lock"
```

**Solution:**
```bash
# 1. ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
rm -rf node_modules package-lock.json pnpm-lock.yaml yarn.lock

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨™æº–ï¼ˆnpmï¼‰ã§å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# 3. ç‰¹å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°
npm install react@latest react-dom@latest

# 4. peer dependency ã®è­¦å‘Šã‚’è§£æ±º
npm install --legacy-peer-deps  # ä¸€æ™‚çš„ãªå›é¿ç­–

# 5. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å›ºå®š
npm install react@19.0.0 --save-exact

# 6. package.json ã®æ•´åˆæ€§ç¢ºèª
cat package.json | jq '.dependencies'

# 7. ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
git add package-lock.json
git commit -m "chore: resolve package version conflicts"
```

**Prevention:**
```json
// package.json ã§ç¯„å›²ã‚’åˆ¶é™
{
  "engines": {
    "node": ">=18.0.0 <20.0.0",
    "npm": ">=9.0.0"
  },
  "packageManager": "npm@9.8.1"
}
```

**Verification:**
```bash
# ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
npm list --depth=0

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒãªã„ã‹ç¢ºèª
npm audit

# é‡è¤‡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒãªã„ã‹ç¢ºèª
npm dedupe
npm list --all | grep -E "deduped"
```

---

### Issue 5: ãƒ†ã‚¹ãƒˆã§ async/await ãŒæ­£ã—ãå‹•ä½œã—ãªã„
**ç—‡çŠ¶:**
```typescript
test('fetches data', async () => {
  const data = await fetchData();
  expect(data).toBeDefined(); // Passes but data is undefined
});
```

**åŸå› :**
- Promise ãŒ reject ã•ã‚Œã¦ã„ã‚‹ãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œã¦ã„ãªã„
- ãƒ¢ãƒƒã‚¯ãŒåŒæœŸçš„ã«è¿”ã—ã¦ã„ã‚‹
- waitFor ã‚’ä½¿ã£ã¦ã„ãªã„

**Solution:**
```typescript
// âœ… Good: Proper async testing
test('fetches data correctly', async () => {
  // 1. ãƒ¢ãƒƒã‚¯ãŒ Promise ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
  jest.spyOn(api, 'fetchData').mockResolvedValue({ id: 1, name: 'Test' });
  
  // 2. await ã§çµæœã‚’å¾…ã¤
  const data = await fetchData();
  
  // 3. æ¤œè¨¼
  expect(data).toEqual({ id: 1, name: 'Test' });
});

// âœ… Good: Testing React async updates
test('displays fetched data', async () => {
  render(<DataComponent />);
  
  // findBy* ã¯è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
  const element = await screen.findByText('Test Data');
  expect(element).toBeInTheDocument();
  
  // ã¾ãŸã¯ waitFor ã‚’ä½¿ç”¨
  await waitFor(() => {
    expect(screen.getByText('Test Data')).toBeInTheDocument();
  });
});

// âœ… Good: Testing error cases
test('handles fetch error', async () => {
  jest.spyOn(api, 'fetchData').mockRejectedValue(new Error('Network error'));
  
  await expect(fetchData()).rejects.toThrow('Network error');
});
```

---

### Issue 6: E2E ãƒ†ã‚¹ãƒˆãŒ CI ã§å¤±æ•—ã™ã‚‹ãŒãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯æˆåŠŸ
**ç—‡çŠ¶:**
```
CI: âœ— Login test - Timeout waiting for element
Local: âœ“ Login test
```

**åŸå› :**
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒçŸ­ã™ãã‚‹
- CI ç’°å¢ƒã® CPU/ãƒ¡ãƒ¢ãƒªãŒé…ã„
- ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ã®æç”»ã®é•ã„
- ç’°å¢ƒå¤‰æ•°ã®ä¸ä¸€è‡´

**Solution:**
```typescript
// playwright.config.ts
export default defineConfig({
  timeout: 30000, // ãƒ­ãƒ¼ã‚«ãƒ«: 10s, CI: 30s
  expect: {
    timeout: 10000,
  },
  retries: process.env.CI ? 2 : 0, // CI ã§ 2 å›ãƒªãƒˆãƒ©ã‚¤
  workers: process.env.CI ? 1 : undefined, // CI ã§ã¯ä¸¦åˆ—å®Ÿè¡Œã‚’åˆ¶é™
  use: {
    baseURL: process.env.CI 
      ? 'http://localhost:3000' 
      : 'http://localhost:3000',
    screenshot: 'only-on-failure',
    trace: 'retain-on-failure',
    video: process.env.CI ? 'on' : 'off',
  },
});
```

**Debugging:**
```bash
# CI ã¨åŒã˜ç’°å¢ƒã§ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
CI=true npm run test:e2e

# ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
npm run test:e2e:headed=false

# ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¨ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æœ‰åŠ¹åŒ–
npm run test:e2e -- --trace on --screenshot on

# CI ãƒ­ã‚°ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
playwright show-trace trace.zip
```

---

### Issue 7: ãƒ“ãƒ«ãƒ‰ã¯æˆåŠŸã™ã‚‹ãŒå®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶:**
```bash
$ npm run build
âœ“ Build successful

$ npm start
Error: Cannot find module '@/lib/utils'
```

**åŸå› :**
- ã‚±ãƒ¼ã‚¹ sensitive ãªå•é¡Œï¼ˆmacOS vs Linuxï¼‰
- ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®è¨­å®šãƒŸã‚¹
- å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å•é¡Œ

**Solution:**
```typescript
// tsconfig.json ã®ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç¢ºèª
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./app/*"]
    }
  }
}

// next.config.js ã§ã‚‚åŒæ§˜ã«è¨­å®š
module.exports = {
  webpack: (config) => {
    config.resolve.alias = {
      ...config.resolve.alias,
      '@': path.resolve(__dirname, 'app'),
    };
    return config;
  },
};
```

**Verification:**
```bash
# ã‚±ãƒ¼ã‚¹sensitiveãªå•é¡Œã‚’æ¤œå‡º
find app/ -name "*.ts" -o -name "*.tsx" | while read file; do
  grep -i "from.*utils" "$file" && echo "Check case: $file"
done

# ãƒ“ãƒ«ãƒ‰å¾Œã®å‡ºåŠ›ã‚’ç¢ºèª
npm run build
ls -la .next/server/app/

# ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
NODE_ENV=production npm start
```

## ğŸ“š References

- **TanStack Query**: https://tanstack.com/query/latest
- **Zod**: https://zod.dev
- **React 19 Guide**: https://react.dev/blog/2024/04/25/react-19
- **Next.js App Router**: https://nextjs.org/docs/app
- **Testing Library**: https://testing-library.com/docs/react-testing-library/intro

## ğŸ¯ Success Criteria (æˆåŠŸåŸºæº–)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®‰å®šåŒ–ãŒ**æˆåŠŸã—ãŸã¨åˆ¤æ–­ã™ã‚‹å®šé‡çš„ãƒ»å®šæ€§çš„åŸºæº–**ã€‚

### âœ… Zero Errors (ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­)

**å®šé‡åŸºæº–:**
```bash
# 1. TypeScript
npx tsc --noEmit
# Expected: "Found 0 errors. Watching for file changes."

# 2. ESLint
npm run lint
# Expected: "âœ“ No ESLint errors or warnings"

# 3. Tests
npm test
# Expected: "Tests: X passed, 0 failed, 0 skipped"
# Expected: "Snapshots: X passed"
```

**åˆæ ¼æ¡ä»¶:**
- TypeScript ã‚¨ãƒ©ãƒ¼: **0**
- ESLint ã‚¨ãƒ©ãƒ¼: **0**
- ESLint è­¦å‘Š: **0** ï¼ˆæ–°è¦è¿½åŠ ãªã—ï¼‰
- ãƒ†ã‚¹ãƒˆå¤±æ•—: **0**
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¸ä¸€è‡´: **0**

---

### âœ… No Regressions (æ©Ÿèƒ½ãƒ‡ã‚°ãƒ¬ãƒ¼ãƒ‰ãªã—)

**å®šæ€§åŸºæº–:**
ä»¥ä¸‹ã®ã™ã¹ã¦ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨:

**ã‚³ã‚¢æ©Ÿèƒ½:**
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰
- [ ] æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨è¡¨ç¤º
- [ ] ãƒãƒ£ãƒ¼ãƒˆã®æç”»ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°å«ã‚€ï¼‰
- [ ] äºˆæ¸¬æ©Ÿèƒ½ï¼ˆML ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè¡Œï¼‰
- [ ] ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
- [ ] ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†

**UI/UX:**
- [ ] ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ãŒæ­£å¸¸
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:**
```bash
# Lighthouse ã‚¹ã‚³ã‚¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
npm run lighthouse

# Expected:
# Performance: â‰¥ 90
# Accessibility: â‰¥ 90
# Best Practices: â‰¥ 90
# SEO: â‰¥ 90
```

**æ¤œè¨¼æ–¹æ³•:**
```bash
# 1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
npm run dev

# 2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸»è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
# - ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ æ ªä¾¡æ¤œç´¢ â†’ ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º â†’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

# 3. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
# - ãƒ–ãƒ©ã‚¦ã‚¶ DevTools ã® Console ã‚¿ãƒ–
# - Network ã‚¿ãƒ–ã§ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãªã„ã‹ç¢ºèª

# 4. E2E ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
npm run test:e2e
```

---

### âœ… Improved Quality (å“è³ªå‘ä¸Š)

**å®šé‡åŸºæº–:**

1. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ â‰¥ 80%**
```bash
npm test -- --coverage
# Expected:
# Statements   : 82.5% ( X/Y )
# Branches     : 80.1% ( X/Y )
# Functions    : 83.2% ( X/Y )
# Lines        : 82.8% ( X/Y )
```

2. **ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚³ã‚¢**
```bash
# Cyclomatic Complexityï¼ˆå¾ªç’°çš„è¤‡é›‘åº¦ï¼‰
npx eslint app/ --ext .ts,.tsx --format json | \
  jq '[.[] | .messages[] | select(.ruleId == "complexity")] | length'
# Expected: 0 (è¤‡é›‘åº¦ 10 ä»¥ä¸Šã®é–¢æ•°ãªã—)

# é‡è¤‡ã‚³ãƒ¼ãƒ‰
npx jscpd app/ --threshold 5
# Expected: "No duplications found"
```

3. **Bundle Sizeï¼ˆãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºï¼‰**
```bash
npm run build
ls -lh .next/static/chunks/pages/*.js | awk '{print $5}'
# Expected: 
# - First Load JS: â‰¤ 200 KB
# - å€‹åˆ¥ãƒšãƒ¼ã‚¸: â‰¤ 50 KB
```

**ãƒãƒ¼ã‚¸å‰å¾Œã®æ¯”è¼ƒ:**
```bash
# Before merge
Total coverage: 78.5%
Bundle size: 187 KB
Lint warnings: 23

# After merge
Total coverage: 82.3% (+3.8%) âœ…
Bundle size: 192 KB (+5 KB) âœ…
Lint warnings: 0 (-23) âœ…
```

**åˆæ ¼æ¡ä»¶:**
- ã‚«ãƒãƒ¬ãƒƒã‚¸: ç¶­æŒã¾ãŸã¯å‘ä¸Š
- ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º: +10% ä»¥å†…
- Lint è­¦å‘Š: æ¸›å°‘ã¾ãŸã¯åŒã˜

---

### âœ… Documentation Updated (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°)

**å¿…é ˆæ›´æ–°é …ç›®:**

1. **ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´**
```bash
# .env.example ãŒæœ€æ–°ã‹ç¢ºèª
git diff main -- .env.example

# ã™ã¹ã¦ã®ç’°å¢ƒå¤‰æ•°ãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
grep "^[A-Z_]*=" .env.example | wc -l
grep -r "process.env." app/ --include="*.ts" | \
  sed 's/.*process\.env\.\([A-Z_]*\).*/\1/' | sort -u | wc -l
# Expected: ä¸¡æ–¹ã®æ•°ãŒä¸€è‡´
```

2. **API ã®å¤‰æ›´**
```bash
# ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚Œã° CHANGELOG.md ã«è¨˜éŒ²
git diff main -- app/api/

# If changes exist:
# - Update docs/API.md
# - Add entry to CHANGELOG.md
# - Update OpenAPI schema (if applicable)
```

3. **README.md ã®æ›´æ–°**
```bash
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ãŒå¤‰ã‚ã£ãŸå ´åˆ
git diff main -- README.md

# æ–°ã—ã„æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆ
# - README.md ã® Features ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
# - ä½¿ç”¨ä¾‹ã‚’è¿½åŠ 
```

**ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**
- [ ] `.env.example` ãŒæœ€æ–°
- [ ] `CHANGELOG.md` ã«å¤‰æ›´ã‚’è¨˜éŒ²
- [ ] `README.md` ãŒæœ€æ–°ã®æ‰‹é †ã‚’åæ˜ 
- [ ] `docs/API.md` ãŒæœ€æ–°ï¼ˆAPI å¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
- [ ] è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
- [ ] ãƒ‘ãƒ–ãƒªãƒƒã‚¯ API ã« JSDoc ã‚’è¿½åŠ 

---

### âœ… CI Passing (CI ãƒã‚§ãƒƒã‚¯æˆåŠŸ)

**GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:**

ã™ã¹ã¦ã®ã‚¸ãƒ§ãƒ–ãŒç·‘ï¼ˆâœ…ï¼‰ã§ã‚ã‚‹ã“ã¨:

```yaml
# .github/workflows/ci.yml ã®å„ã‚¹ãƒ†ãƒƒãƒ—
âœ… Install dependencies
âœ… Type check (TypeScript)
âœ… Lint (ESLint)
âœ… Unit tests (Jest)
âœ… E2E tests (Playwright)
âœ… Build (Next.js)
âœ… Security audit (npm audit)
```

**æ¤œè¨¼æ–¹æ³•:**
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ CI ã¨åŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
npm ci
npx tsc --noEmit
npm run lint
npm test -- --coverage
npm run test:e2e
npm run build
npm audit --production
```

**CI ãƒ­ã‚°ã®ç¢ºèª:**
```bash
# GitHub CLI ã‚’ä½¿ç”¨
gh run list --branch feature/my-branch
gh run view <run-id> --log

# ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
gh run view <run-id> --json conclusion -q '.jobs[].conclusion'
# Expected: ã™ã¹ã¦ "success"
```

---

### ğŸ“Š Success Report Template (æˆåŠŸãƒ¬ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)

å®‰å®šåŒ–å®Œäº†æ™‚ã«ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ:

```markdown
# Project Stabilization Success Report

## Date: 2024-01-15
## Branch: feature/project-stabilization
## Author: @username

---

## âœ… Quantitative Results

### Errors
- TypeScript: 0 errors (was: 15)
- ESLint: 0 errors, 0 warnings (was: 23 warnings)
- Tests: 247 passed, 0 failed (was: 198 passed, 49 failed)

### Quality Metrics
- Test Coverage: 82.5% (was: 67.3%, +15.2%)
- Build Time: 45s (was: 52s, -13%)
- Bundle Size: 192 KB (was: 187 KB, +2.7%)

### CI/CD
- All checks: âœ… Passing
- Deployment: âœ… Successful
- Performance: âœ… No regressions

---

## âœ… Qualitative Results

### Features Verified
- [x] User authentication
- [x] Stock data fetching
- [x] Chart rendering
- [x] ML predictions
- [x] Backtesting
- [x] Portfolio management

### Improvements
1. Migrated 12 components to TanStack Query
2. Added Zod validation to 8 API routes
3. Resolved 15 TypeScript errors
4. Fixed 49 failing tests
5. Updated 3 outdated dependencies

---

## ğŸ“ Documentation

### Updated Files
- [x] `.env.example` - Added new environment variables
- [x] `CHANGELOG.md` - Documented breaking changes
- [x] `README.md` - Updated setup instructions
- [x] `docs/ARCHITECTURE.md` - Added TanStack Query patterns

---

## ğŸš€ Next Steps

1. Monitor production metrics for 24 hours
2. Gather user feedback
3. Plan next modernization phase (Zustand â†’ TanStack Query mutations)

---

## ğŸ”— Related PRs

- #988: Data Quality Panel Refactor
- #1000: Core Service Stabilization
- #1012: Project Stabilizer Skill Enhancement

---

**Conclusion:** Project stabilization completed successfully. All quality gates passed. Ready for production deployment.
```

---

### æˆåŠŸå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Post-Success Actions)

ã™ã¹ã¦ã®åŸºæº–ã‚’æº€ãŸã—ãŸã‚‰:

1. **ãƒãƒ¼ã‚¸ã—ã¦ main ã«ãƒ‡ãƒ—ãƒ­ã‚¤**
```bash
git checkout main
git merge --no-ff feature/stabilization
git push origin main
```

2. **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã‚’ä½œæˆ**
```bash
git tag -a v1.2.0 -m "Release v1.2.0: Project Stabilization Complete"
git push origin v1.2.0
```

3. **ãƒãƒ¼ãƒ ã«é€šçŸ¥**
```markdown
## ğŸ‰ Project Stabilization Complete!

**Summary:**
- âœ… 0 TypeScript errors
- âœ… 0 ESLint warnings
- âœ… 82.5% test coverage
- âœ… All CI checks passing

**Key Improvements:**
- Migrated 12 components to TanStack Query
- Added runtime validation with Zod
- Fixed 49 failing tests
- Improved build time by 13%

**Documentation:**
All docs updated and ready for team review.

cc: @team
```

4. **æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨ˆç”»**
- ãƒãƒ¼ã‚¸å¾Œã®ç›£è¦–æœŸé–“ã‚’è¨­å®šï¼ˆ24-48æ™‚é–“ï¼‰
- æ¬¡ã®ãƒ¢ãƒ€ãƒ³åŒ–å¯¾è±¡ã‚’ç‰¹å®š
- æŠ€è¡“çš„è² å‚µã®å„ªå…ˆé †ä½ä»˜ã‘
