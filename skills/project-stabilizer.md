---
name: project-stabilizer
description: Post-merge recovery and test stabilization specialist. Resolves inconsistencies after large merges and migrates to modern tech stack (TanStack Query, Zod, React 19).
version: 1.1.0
priority: high
auto_activate: true
---

# Project Stabilizer (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®‰å®šåŒ–ãƒã‚¹ã‚¿ãƒ¼)

å¤§è¦æ¨¡ãªãƒãƒ¼ã‚¸ã‚„æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®åˆ·æ–°å¾Œã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¥å…¨æ€§ã‚’è¿…é€Ÿã«å›å¾©ã—ã€æœ€é«˜æ°´æº–ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°å“è³ªã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®å°‚é–€ã‚¹ã‚­ãƒ«ã€‚

Post-merge recovery and modernization specialist. Rapidly restores project health after large merges or tech stack updates, maintaining the highest engineering quality standards.

## ğŸ¯ ç›®çš„
- ãƒãƒ¼ã‚¸å¾Œã®ãƒ†ã‚¹ãƒˆå¤±æ•—ã‚„å‹ã‚¨ãƒ©ãƒ¼ã®è¿…é€Ÿãªè§£æ¶ˆã€‚
- ãƒ¬ã‚¬ã‚·ãƒ¼ãªçŠ¶æ…‹ç®¡ç†ã‹ã‚‰ãƒ¢ãƒ€ãƒ³ãªéåŒæœŸçŠ¶æ…‹ç®¡ç†ï¼ˆTanStack Queryï¼‰ã¸ã®ç§»è¡Œã€‚
- React 19 ãŠã‚ˆã³ Next.js App Router ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã®å¾¹åº•ã€‚
- å®Ÿè¡Œæ™‚ã®å‹å®‰å…¨æ€§ï¼ˆZodï¼‰ã¨ç’°å¢ƒå¤‰æ•°ã®ä¿è­·ã€‚

## ğŸ›  å°‚é–€çŸ¥è­˜ (Expertise)

### 1. ãƒãƒ¼ã‚¸å¾Œã®ä¸æ•´åˆè§£æ±º (Post-Merge Recovery)
- **ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªDBã®çµ±åˆ**: è¤‡æ•°ã®APIãƒ«ãƒ¼ãƒˆã§ç‹¬ç«‹ã—ã¦ã„ãŸã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹ã‚’ `AuthStore` ç­‰ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã¾ãŸã¯å…±æœ‰ã‚¹ãƒˆã‚¢ã«çµ±åˆã—ã€ãƒ†ã‚¹ãƒˆã®æ•´åˆæ€§ã‚’ä¿ã¤ã€‚
- **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æœ€é©åŒ–**: äºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã®é–¾å€¤åˆ¤å®šãŒå³ã—ã„å ´åˆã€ç¾å®Ÿçš„ãªã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆVå­—å›å¾©ç­‰ï¼‰ã‚’ã‚·ã‚°ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«èª¿æ•´ã™ã‚‹ã€‚
- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®çµ±ä¸€**: `pnpm` ã¨ `npm` ã®æ··åœ¨ã‚’æ¤œçŸ¥ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¨™æº–ï¼ˆç¾åœ¨ã¯ `npm`ï¼‰ã«ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¼·åˆ¶çš„ã«ä¸€æœ¬åŒ–ã™ã‚‹ã€‚

### 2. ãƒ¢ãƒ€ãƒ³ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ (Modern Data Fetching)
- **useEffect ã‹ã‚‰ useQuery ã¸ã®ç§»è¡Œ**: æ‰‹å‹•ã® `fetch` + `useState` ã‚’ `TanStack Query` ã«ç½®ãæ›ãˆã€ç«¶åˆçŠ¶æ…‹ã€äºŒé‡ç™ºç«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚’ä¸€å…ƒåŒ–ã™ã‚‹ã€‚
- **Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¯¾ã—ã€TypeScript ã®å‹å®šç¾©ã ã‘ã§ãªãå®Ÿè¡Œæ™‚ã®ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼ã‚’è¡Œã„ã€ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãªã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’é˜²ãã€‚

### 3. React 19 æœ€é©åŒ–
- **Side Effect ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: Effect å†…ã§ã®åŒæœŸçš„ãª `setState`ï¼ˆCascading Rendersï¼‰ã‚’æ’é™¤ã—ã€`useTransition` ã‚„ `useMemo`ã€ã¾ãŸã¯ `useQuery` ã®çŠ¶æ…‹ç§»è¡Œã‚’æ´»ç”¨ã™ã‚‹ã€‚
- **Ref ã‚¢ã‚¯ã‚»ã‚¹ã®é©æ­£åŒ–**: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã® `ref.current` ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ã—ã€Effect ã¾ãŸã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å†…ã§ã®ã¿å‡¦ç†ã™ã‚‹ã€‚

### 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é€²åŒ– (DDD)
- **ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ†é›¢**: `app/lib` ã®è‚¥å¤§åŒ–ã‚’é˜²ããŸã‚ã€`app/features/[domain]` æ§‹é€ ã‚’å°å…¥ã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚¹ãƒˆã‚¢ã€ãƒ•ãƒƒã‚¯ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ã€‚

## ğŸ“ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (Workflow)

### Step 1: è¨ºæ–­ (Diagnosis)
`npm test` ã¨ `npm run lint` ã‚’å®Ÿè¡Œã—ã€ãƒãƒ¼ã‚¸å¾Œã®ã€ŒçœŸã®å¤±æ•—æ•°ã€ã‚’æŠŠæ¡ã™ã‚‹ã€‚

**Example:**
```bash
cd trading-platform
npm test -- --passWithNoTests
npm run lint
npx tsc --noEmit
```

**Expected Output:**
- List of failing tests
- TypeScript errors count
- ESLint warnings/errors

### Step 2: åŸºç›¤ä¿®å¾© (Base Fix)
èªè¨¼ã‚„ç’°å¢ƒå¤‰æ•°ãªã©ã€ã‚·ã‚¹ãƒ†ãƒ ã®æ ¹å¹¹ã«é–¢ã‚ã‚‹ä¸æ•´åˆã‚’ `AuthStore` ã‚„ `env.ts` ã®å°å…¥ã«ã‚ˆã‚Šæœ€å„ªå…ˆã§ä¿®æ­£ã™ã‚‹ã€‚

**Example:**
```typescript
// Before: Scattered authentication state
// app/api/auth/route.ts - independent state
// app/components/Login.tsx - local state

// After: Centralized AuthStore
// app/lib/auth/AuthStore.ts
export class AuthStore {
  private static instance: AuthStore;
  private users = new Map<string, User>();
  
  static getInstance(): AuthStore {
    if (!AuthStore.instance) {
      AuthStore.instance = new AuthStore();
    }
    return AuthStore.instance;
  }
}
```

### Step 3: UI/ãƒ­ã‚¸ãƒƒã‚¯ã®å®‰å®šåŒ–
å£Šã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’ã€æœ€æ–°ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆRTLç­‰ï¼‰ã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦ä¿®æ­£ã™ã‚‹ã€‚

**Example:**
```typescript
// Before: Using old testing patterns
import { render } from '@testing-library/react';

test('renders component', () => {
  const { getByText } = render(<MyComponent />);
  expect(getByText('Hello')).toBeInTheDocument();
});

// After: React 19 compatible patterns
import { render, screen } from '@testing-library/react';
import { expect, test } from '@jest/globals';

test('renders component with modern patterns', async () => {
  render(<MyComponent />);
  const element = await screen.findByText('Hello');
  expect(element).toBeDefined();
});
```

### Step 4: ãƒ¢ãƒ€ãƒ³åŒ– (Modernization)
ä¿®æ­£ã—ãŸç®‡æ‰€ã‚’é †æ¬¡ TanStack Query ã‚„ Zod ã‚’ç”¨ã„ãŸãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚³ãƒ¼ãƒ‰ã«æ˜‡è¯ã•ã›ã‚‹ã€‚

**Example:**
```typescript
// Before: Manual fetch with useEffect
const [data, setData] = useState(null);
const [loading, setLoading] = useState(true);

useEffect(() => {
  fetch('/api/data')
    .then(res => res.json())
    .then(setData)
    .finally(() => setLoading(false));
}, []);

// After: TanStack Query with Zod validation
import { useQuery } from '@tanstack/react-query';
import { z } from 'zod';

const DataSchema = z.object({
  id: z.string(),
  value: z.number(),
});

export function useData() {
  return useQuery({
    queryKey: ['data'],
    queryFn: async () => {
      const res = await fetch('/api/data');
      const json = await res.json();
      return DataSchema.parse(json);
    },
  });
}
```

### Step 5: ä¸€æ‹¬çµ±åˆ (Orchestration)
è¤‡æ•°ã®PRã‚„ç«¶åˆãƒ–ãƒ©ãƒ³ãƒã‚’ã€ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãªãŒã‚‰é †æ¬¡ `main` ã¸çµ±åˆã—ã€æœ€çµ‚çš„ãªå¥å…¨æ€§ã‚’å…¨ä»¶ãƒ†ã‚¹ãƒˆã§è¨¼æ˜ã™ã‚‹ã€‚

**Workflow:**
```bash
# 1. Merge base branches first
git checkout main
git pull origin main

# 2. Integrate feature branches in dependency order
git merge --no-ff feature/auth-store
npm test && npm run lint

git merge --no-ff feature/data-fetching
npm test && npm run lint

# 3. Final verification
npm run build
npm run test:e2e
```

## âš ï¸ ç¦æ­¢äº‹é …
- `any` å‹ã®æ”¾ç½®ã€‚
- è­¦å‘Šï¼ˆWarningï¼‰ã‚’ç„¡è¦–ã—ãŸãƒãƒ¼ã‚¸ã€‚
- ã‚µãƒ¼ãƒãƒ¼/ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¢ƒç•Œã‚’æ„è­˜ã—ãªã„ `'use client'` ã®æ¿«ç”¨ã€‚

## âœ… Verification Checklist (æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®‰å®šåŒ–ä½œæ¥­ã‚’å®Œäº†ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### åŸºæœ¬æ¤œè¨¼
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ (`npm test`)
- [ ] TypeScript ã‚¨ãƒ©ãƒ¼ãŒã‚¼ãƒ­ (`npx tsc --noEmit`)
- [ ] ESLint ã‚¨ãƒ©ãƒ¼ãŒã‚¼ãƒ­ (`npm run lint`)
- [ ] ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ (`npm run build`)

### ãƒãƒ¼ã‚¸å¾Œã®å“è³ª
- [ ] ãƒãƒ¼ã‚¸å‰ã¨æ¯”è¼ƒã—ã¦æ©Ÿèƒ½ã®ãƒ‡ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒãªã„
- [ ] æ–°ã—ã„è­¦å‘ŠãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç¶­æŒã¾ãŸã¯æ”¹å–„ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ï¼ˆnpm ã®ã¿ï¼‰

### ãƒ¢ãƒ€ãƒ³åŒ–ã®ç¢ºèª
- [ ] æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã¯ TanStack Query ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- [ ] API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- [ ] React 19 ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æº–æ‹ ã—ã¦ã„ã‚‹
- [ ] `'use client'` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒé©åˆ‡ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] å¤§ããªå¤‰æ›´ã«ã¯é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹
- [ ] ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚Œã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ãŒ `.env.example` ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹

## ğŸ”§ Common Troubleshooting (ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–)

### Issue: ãƒ†ã‚¹ãƒˆãŒç„¡é™ãƒ«ãƒ¼ãƒ—ã™ã‚‹
**Cause:** useEffect ã®ä¾å­˜é…åˆ—ãŒä¸é©åˆ‡ã€ã¾ãŸã¯ TanStack Query ã®è¨­å®šãƒŸã‚¹

**Solution:**
```typescript
// Bad: Missing dependencies
useEffect(() => {
  fetchData(userId);
}, []); // userId changes not detected

// Good: Proper dependencies or use TanStack Query
const { data } = useQuery({
  queryKey: ['user', userId],
  queryFn: () => fetchUser(userId),
});
```

### Issue: Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒæœ¬ç•ªã§ç™ºç”Ÿ
**Cause:** é–‹ç™ºç’°å¢ƒã¨APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸ä¸€è‡´

**Solution:**
```typescript
// Add detailed error logging
const DataSchema = z.object({
  id: z.string(),
  value: z.number(),
}).strict(); // Reject unknown keys

try {
  return DataSchema.parse(json);
} catch (error) {
  if (error instanceof z.ZodError) {
    console.error('Validation failed:', error.errors);
    console.error('Received data:', json);
  }
  throw error;
}
```

### Issue: `'use client'` ã‚’è¿½åŠ ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã—ãªã„
**Cause:** ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå°‚ç”¨æ©Ÿèƒ½ã‚’ä½¿ç”¨

**Solution:**
```typescript
// Bad: Server component using client hooks
export default function Page() {
  const [state, setState] = useState(0); // Error!
  return <div>{state}</div>;
}

// Good: Separate client component
'use client';
export function Counter() {
  const [state, setState] = useState(0);
  return <div>{state}</div>;
}

// Server component imports client component
export default function Page() {
  return <Counter />;
}
```

### Issue: ãƒãƒ¼ã‚¸å¾Œã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç«¶åˆ
**Cause:** è¤‡æ•°ã®ãƒ–ãƒ©ãƒ³ãƒã§ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**Solution:**
```bash
# Remove conflicting lock files
rm -rf node_modules package-lock.json

# Use project standard (npm)
npm install

# Verify versions
npm list <package-name>

# Commit updated lock file
git add package-lock.json
git commit -m "chore: resolve package version conflicts"
```

## ğŸ“š References

- **TanStack Query**: https://tanstack.com/query/latest
- **Zod**: https://zod.dev
- **React 19 Guide**: https://react.dev/blog/2024/04/25/react-19
- **Next.js App Router**: https://nextjs.org/docs/app
- **Testing Library**: https://testing-library.com/docs/react-testing-library/intro

## ğŸ¯ Success Criteria (æˆåŠŸåŸºæº–)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®‰å®šåŒ–ãŒæˆåŠŸã—ãŸã¨åˆ¤æ–­ã™ã‚‹åŸºæº–ï¼š

1. **Zero Errors**: TypeScript ã‚¨ãƒ©ãƒ¼ã€ESLint ã‚¨ãƒ©ãƒ¼ã€ãƒ†ã‚¹ãƒˆå¤±æ•—ãŒã™ã¹ã¦ã‚¼ãƒ­
2. **No Regressions**: æ—¢å­˜ã®æ©Ÿèƒ½ãŒã™ã¹ã¦æ­£å¸¸ã«å‹•ä½œã™ã‚‹
3. **Improved Quality**: ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã¨ã‚³ãƒ¼ãƒ‰å“è³ªãŒå‘ä¸Šã¾ãŸã¯ç¶­æŒã•ã‚Œã¦ã„ã‚‹
4. **Documentation Updated**: é‡è¦ãªå¤‰æ›´ãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åæ˜ ã•ã‚Œã¦ã„ã‚‹
5. **CI Passing**: ã™ã¹ã¦ã® CI ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹ã™ã‚‹

æˆåŠŸã—ãŸã‚‰ã€å¤‰æ›´ã‚’ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã—ã€æ¬¡ã®ãƒ¢ãƒ€ãƒ³åŒ–ä½œæ¥­ã«é€²ã¿ã¾ã™ã€‚
