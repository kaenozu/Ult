# ソースコードレビューレポート

**担当エンジニア:** Jules
**日付:** 2024-05-23
**対象:** `trading-platform` (Next.js App) および `backend` スクリプト

プロジェクト全体の詳細なソースコードレビューを実施しました。以下に、重要度別に発見事項と改善提案をまとめます。

## 📊 概要
プロジェクトは Next.js 16 (App Router) を採用し、TypeScript の Strict モードが有効化され、セキュリティヘッダーも適切に設定されるなど、基盤は非常に堅牢です。一方で、特定の計算処理におけるパフォーマンス上のボトルネックや、状態管理における競合状態（Race Condition）のリスク、一部のダミー実装が見受けられました。

---

## 🛑 Critical (優先対応事項)

### 1. バックテストのパフォーマンス (`app/lib/backtest.ts`)
`runBacktest` 関数内で、過去の全期間にわたるループ処理が行われていますが、そのループ内で毎回 `analyzeStock` → `optimizeParameters` が呼び出されています。
- **問題:** `optimizeParameters` はパラメータ（RSI/SMA期間）のグリッドサーチを行う重い処理です。これを1日進むごとに再実行しているため、計算量が $O(N \cdot M \cdot P)$ となり、データ量が増えると指数関数的に遅くなります。
- **推奨:** パラメータ最適化はバックテスト期間全体で1回（または定期的に）行うか、計算結果をメモ化する必要があります。

### 2. 状態更新の非アトミック性 (`app/components/OrderPanel.tsx`)
注文実行時に `setCash(portfolio.cash - totalCost)` と `addPosition(...)` が別々に呼び出されています。
- **問題:** `portfolio.cash` を読み取ってからセットするまでの間に、別の処理（例：ポジション決済による現金増加）がバックグラウンドで走った場合、その変更を上書きしてしまうリスク（競合状態）があります。
- **推奨:** `tradingStore` 内に `executeOrder` のようなアクションを作成し、現金とポジションの更新を単一のアトミックな処理として実装してください。

### 3. 未実装/ダミーのRSIチャート (`app/page.tsx`)
メインダッシュボードの RSI サブチャートが、ハードコードされた SVG パス (`d="M0,50 C50,40..."`) で描画されています。
- **問題:** 実際のデータに基づかないグラフが表示されており、ユーザーに誤解を与える可能性があります。
- **推奨:** `StockChart` コンポーネントと同様に、実際のデータに基づいて描画するように修正してください。

---

## ⚠️ Major (重要な改善点)

### 1. `StockChart` の市場指数正規化ロジック (`app/components/StockChart.tsx`)
`normalizedIndexData` の計算において、チャートの全データポイントに対して `indexData.find` を実行しています。
- **問題:** 計算量が $O(N \cdot M)$ となり、データ数が多い場合にレンダリングをブロックする可能性があります。
- **推奨:** `indexData` を日付をキーとする Map オブジェクトに変換するか、インデックス同期済みの配列を事前に生成することで、$O(1)$ の参照に改善できます。

### 2. バックエンドの単純なトレンド判定 (`backend/src/market_correlation/analyzer.py`)
`detect_trend` 関数が、始値と終値の単純比較のみでトレンドを判定しています。
- **問題:** 期間中の価格変動（ボラティリティ）や中間的なトレンド転換が無視されます。
- **推奨:** 移動平均線（SMA/EMA）の傾きや、線形回帰を用いたより堅牢なトレンド判定ロジックへの変更を推奨します。

### 3. ストア内のビジネスロジック肥大化 (`app/store/tradingStore.ts`)
`processAITrades` アクション内に、利益計算、損切り判定、日本語の「反省コメント」生成ロジックが含まれています。
- **問題:** ストアがUIの状態管理だけでなく、ドメインロジックを持ちすぎています。また、日本語テキストがハードコードされているため、国際化（i18n）の妨げになります。
- **推奨:** これらのロジックを `app/lib/trading-logic.ts` などの純粋な関数として切り出し、ストアは状態の更新のみに専念させるべきです。

---

## ℹ️ Minor (軽微な修正・提案)

- **APIのデータ補完 (`app/api/market/route.ts`):** Yahoo Finance からのデータで `open` が `null` の場合に `0` を代入していますが、これはチャート上でスパイク（急落）として表示される可能性があります。前日の終値で補完する等の処理が望ましいです。
- **WebSocketの再接続 (`app/hooks/useWebSocket.ts`):** `isConnected` フラグの切り替えに依存しており、フラグが頻繁に変わると接続ループが発生する可能性があります。デバウンス処理の導入を検討してください。
- **RSI/SMAの再計算:** `StockChart` 内でインジケーター計算を行っていますが、これらは `analysis.ts` や `useStockData` の段階で計算済みのものを再利用できるとより効率的です。

---

## ✅ Good Practices (評価点)

- **セキュリティ:** `next.config.ts` で HSTS や X-Frame-Options などのセキュリティヘッダーが適切に設定されています。APIルートでも入力値のバリデーション（正規表現、長さ制限）が徹底されています。
- **型安全性:** `tsconfig.json` で `strict: true`、ESLint で `@typescript-eslint/no-explicit-any: "error"` が設定されており、非常に高い型安全性が保たれています。
- **UI/UX:** `AbortController` を使用したフェッチ中断処理や、`React.memo` によるレンダリング最適化など、モダンな React のベストプラクティスが随所に見られます。
- **アーキテクチャ:** コンポーネント構成が整理されており、責務の分離（コンポーネント vs フック）が概ね良好です。

以上
