---
name: git-safe-merge
description: 安全なプルリクエストのマージとコンフリクト解消のためのワークフロー。win32環境の制限事項、ブランチ保護、インクリメンタルな検証手順を遵守し、ビルドとテストの整合性を維持します。
---

# Git Safe Merge

## 概要
複数のプルリクエストを安全にマージし、コンフリクトを解消しながらコードベースの健全性（ビルドとテストの整合性）を維持するための高度なワークフローを提供します。

## 1. 動作環境の遵守 (OS-Aware Execution)
`win32` 環境（PowerShell）で実行する場合、以下のルールを厳守してください：
- **`&&` を絶対に使用しない**: コマンドを連結せず、1行ずつ個別に実行してください。
- **Gitコマンドの個別実行**: `git add .`, `git commit -m "..."`, `git push` 等は常に分離して実行します。

## 2. インクリメンタル・マージ・ループ
大量のPRを一括でマージするのではなく、以下のサイクルを繰り返します：
1. **マージ実行**: `gh pr merge <number> --squash` または `git merge` を実行。
2. **コンフリクト解消**: 発生した場合は `read_file` で内容を確認し、論理的整合性を保って解消。
3. **ビルド検証**: **1つのPRごとに** `npx tsc --noEmit` を実行し、型エラーがないか確認。
4. **関連テスト実行**: 変更されたモジュールに関連する最小限のテストを実行。
5. **完了と次へ**: 問題がなければ次のPRに進む。

## 3. ブランチ保護とPRワークフロー
- **直接プッシュの禁止**: `main` ブランチ等、保護されたブランチへの直接プッシュは行いません。
- **クリーンアップ・ブランチ**: マージ後に型修正やリファクタリングが必要になった場合は、必ず `fix/post-merge-cleanup` のようなブランチを作成し、`gh pr create` を通じてマージしてください。

## 4. 置換ツールの精密操作
`replace` ツールを使用する際の失敗を回避します：
- **事前確認**: 置換前に必ず `search_file_content` を実行し、対象の正確な出現回数を把握します。
- **パラメータ指定**: `expected_replacements` には、推測ではなく実測値を指定してください。

## 5. 大規模変更後の優先順位
リファクタリング（例：ストア分割、型定義の変更）が伴うマージでは、以下の順序で整合性を復旧させます：
1. **型不整合の解消**: `tsc` エラーを最優先で修正し、ビルドが通る状態を確保。
2. **不要ファイルの削除**: 削除されたモジュールを参照している古いテスト等をクリーンアップ。
3. **論理テストの復旧**: ビルドが通った後、失敗しているテストケースを個別に分析・修正。