---
name: project-stabilizer
description: 大規模マージ後の不整合解決、テスト安定化、およびモダンな技術スタック（TanStack Query, Zod, React 19）への移行を専門とするスキル。
---

# Project Stabilizer (プロジェクト安定化マスター)

大規模なマージや技術スタックの刷新後に、プロジェクトの健全性を迅速に回復し、最高水準のエンジニアリング品質を維持するための専門スキル。

## 🎯 目的
- マージ後のテスト失敗や型エラーの迅速な解消。
- レガシーな状態管理からモダンな非同期状態管理（TanStack Query）への移行。
- React 19 および Next.js App Router に最適化されたコンポーネント設計の徹底。
- 実行時の型安全性（Zod）と環境変数の保護。

## 🛠 専門知識 (Expertise)

### 1. マージ後の不整合解決 (Post-Merge Recovery)
- **インメモリDBの統合**: 複数のAPIルートで独立していたインメモリ状態を `AuthStore` 等のシングルトンまたは共有ストアに統合し、テストの整合性を保つ。
- **テストデータの最適化**: 予測ロジック等の閾値判定が厳しい場合、現実的なエッジケース（V字回復等）をシミュレートしたテストデータに調整する。
- **パッケージマネージャーの統一**: `pnpm` と `npm` の混在を検知し、プロジェクト標準（現在は `npm`）にロックファイルを強制的に一本化する。

### 2. モダン・データフェッチ (Modern Data Fetching)
- **useEffect から useQuery への移行**: 手動の `fetch` + `useState` を `TanStack Query` に置き換え、競合状態、二重発火、キャッシュ管理を一元化する。
- **Zod バリデーション**: APIレスポンスに対し、TypeScript の型定義だけでなく実行時のスキーマ検証を行い、不正なデータによるサイレントなクラッシュを防ぐ。

### 3. React 19 最適化
- **Side Effect のクリーンアップ**: Effect 内での同期的な `setState`（Cascading Renders）を排除し、`setTimeout(0)` や `useMemo`、または `useQuery` の状態移行を活用する。
- **Ref アクセスの適正化**: レンダリング中の `ref.current` へのアクセスを禁止し、Effect またはイベントハンドラ内でのみ処理する。

### 4. アーキテクチャの進化 (DDD)
- **ドメイン分離**: `app/lib` の肥大化を防ぐため、`app/features/[domain]` 構造を導入し、サービス、ストア、フックをドメインごとにカプセル化する。

## 📝 ワークフロー (Workflow)

1.  **診断 (Diagnosis)**: `npm test` と `npm run lint` を実行し、マージ後の「真の失敗数」を把握する。
2.  **基盤修復 (Base Fix)**: 認証や環境変数など、システムの根幹に関わる不整合を `AuthStore` や `env.ts` の導入により最優先で修正する。
3.  **UI/ロジックの安定化**: 壊れたコンポーネントのテストを、最新 theater ライブラリのパスに合わせて修正する。
4.  **モダン化 (Modernization)**: 修正した箇所を順次 TanStack Query や Zod を用いたベストプラクティスコードに昇華させる。
5.  **一括統合 (Orchestration)**: 複数のPRや競合ブランチを、依存関係を考慮しながら順次 `main` へ統合し、最終的な健全性を全件テストで証明する。

## ⚠️ 禁止事項
- `any` 型の放置。
- 警告（Warning）を無視したマージ。
- サーバー/クライアント境界を意識しない `'use client'` の濫用。
