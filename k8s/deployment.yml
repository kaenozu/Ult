apiVersion: apps/v1
kind: Deployment
metadata:
  name: agstock-api-gateway
  labels:
    app: agstock
    component: api-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: agstock
      component: api-gateway
  template:
    metadata:
      labels:
        app: agstock
        component: api-gateway
    spec:
      containers:
        - name: api-gateway
          image: agstock/api-gateway:latest
          ports:
            - containerPort: 8000
          env:
            - name: BACKEND_SERVICES
              value: 'trading-service:8001,portfolio-service:8002,market-data-service:8003'
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: agstock-secrets
                  key: redis-url
          resources:
            requests:
              memory: '256Mi'
              cpu: '250m'
            limits:
              memory: '512Mi'
              cpu: '500m'
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1001
            capabilities:
              drop:
                - ALL
      securityContext:
        fsGroup: 1001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agstock-trading-service
  labels:
    app: agstock
    component: trading-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: agstock
      component: trading-service
  template:
    metadata:
      labels:
        app: agstock
        component: trading-service
    spec:
      containers:
        - name: trading-service
          image: agstock/trading-service:latest
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: agstock-secrets
                  key: database-url
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: agstock-secrets
                  key: redis-url
            - name: KAFKA_BROKERS
              value: 'kafka-cluster-kafka-bootstrap:9092'
            - name: AI_SERVICE_URL
              value: 'http://agstock-ai-service:8000'
          volumeMounts:
            - name: logs-volume
              mountPath: /app/logs
          resources:
            requests:
              memory: '512Mi'
              cpu: '500m'
            limits:
              memory: '1Gi'
              cpu: '1000m'
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1001
      volumes:
        - name: logs-volume
          persistentVolumeClaim:
            claimName: agstock-logs-pvc
      securityContext:
        fsGroup: 1001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agstock-ai-service
  labels:
    app: agstock
    component: ai-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agstock
      component: ai-service
  template:
    metadata:
      labels:
        app: agstock
        component: ai-service
    spec:
      containers:
        - name: ai-service
          image: agstock/ai-service:latest
          ports:
            - containerPort: 8000
          env:
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: agstock-secrets
                  key: redis-url
            - name: MODEL_PATH
              value: '/app/models'
            - name: CUDA_VISIBLE_DEVICES
              value: '0'
          volumeMounts:
            - name: models-volume
              mountPath: /app/models
          resources:
            requests:
              memory: '2Gi'
              cpu: '1000m'
              nvidia.com/gpu: 1
            limits:
              memory: '4Gi'
              cpu: '2000m'
              nvidia.com/gpu: 1
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 120
            periodSeconds: 60
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 30
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1001
      volumes:
        - name: models-volume
          persistentVolumeClaim:
            claimName: agstock-models-pvc
      tolerations:
        - key: 'nvidia.com/gpu'
          operator: 'Exists'
          effect: 'NoSchedule'
      nodeSelector:
        accelerator: nvidia-tesla-k80
      securityContext:
        fsGroup: 1001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agstock-frontend
  labels:
    app: agstock
    component: frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: agstock
      component: frontend
  template:
    metadata:
      labels:
        app: agstock
        component: frontend
    spec:
      containers:
        - name: frontend
          image: agstock/frontend:latest
          ports:
            - containerPort: 3000
          env:
            - name: NEXT_PUBLIC_API_URL
              value: 'http://agstock-api-gateway:8000'
            - name: NEXT_PUBLIC_WS_URL
              value: 'ws://agstock-api-gateway:8000'
          resources:
            requests:
              memory: '256Mi'
              cpu: '250m'
            limits:
              memory: '512Mi'
              cpu: '500m'
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 101
      securityContext:
        fsGroup: 101
---
apiVersion: v1
kind: Service
metadata:
  name: agstock-api-gateway
  labels:
    app: agstock
    component: api-gateway
spec:
  selector:
    app: agstock
    component: api-gateway
  ports:
    - name: http
      port: 80
      targetPort: 8000
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: agstock-frontend
  labels:
    app: agstock
    component: frontend
spec:
  selector:
    app: agstock
    component: frontend
  ports:
    - name: http
      port: 80
      targetPort: 3000
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  name: agstock-trading-service
  labels:
    app: agstock
    component: trading-service
spec:
  selector:
    app: agstock
    component: trading-service
  ports:
    - name: http
      port: 8000
      targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: agstock-ai-service
  labels:
    app: agstock
    component: ai-service
spec:
  selector:
    app: agstock
    component: ai-service
  ports:
    - name: http
      port: 8000
      targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: agstock-config
  labels:
    app: agstock
data:
  LOG_LEVEL: 'INFO'
  METRICS_ENABLED: 'true'
  CACHE_TTL: '3600'
  MAX_CONNECTIONS: '100'
---
apiVersion: v1
kind: Secret
metadata:
  name: agstock-secrets
  labels:
    app: agstock
type: Opaque
data:
  database-url: cG9zdGdyZXM6Ly91c2VyOnBhc3NAcG9zdGdyZXM6NTQzMi9hZ3N0b2NrX2Ri # base64 encoded
  redis-url: cmVkaXM6Ly9yZWRpczpkZXZlbG9wQGFnc3RvY2stcmVkaXM6NjM3OSA # base64 encoded
  jwt-secret: c3VwZXJzZWNyZXRqd3RrZXl0aGF0aXMyNWNoYXJz # base64 encoded
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: agstock-logs-pvc
  labels:
    app: agstock
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: agstock-models-pvc
  labels:
    app: agstock
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: agstock-ingress
  labels:
    app: agstock
  annotations:
    kubernetes.io/ingress.class: 'nginx'
    nginx.ingress.kubernetes.io/ssl-redirect: 'true'
    nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'
    cert-manager.io/cluster-issuer: 'letsencrypt-prod'
spec:
  tls:
    - hosts:
        - agstock.example.com
      secretName: agstock-tls
  rules:
    - host: agstock.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: agstock-frontend
                port:
                  number: 80
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: agstock-api-gateway
                port:
                  number: 80
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: agstock-pdb
  labels:
    app: agstock
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: agstock
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: agstock-service-account
  labels:
    app: agstock
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: agstock-role
  labels:
    app: agstock
rules:
  - apiGroups: ['']
    resources: ['pods', 'services', 'configmaps', 'secrets']
    verbs: ['get', 'list', 'watch']
  - apiGroups: ['apps']
    resources: ['deployments', 'replicasets']
    verbs: ['get', 'list', 'watch', 'update', 'patch']
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: agstock-role-binding
  labels:
    app: agstock
subjects:
  - kind: ServiceAccount
    name: agstock-service-account
roleRef:
  kind: Role
  name: agstock-role
  apiGroup: rbac.authorization.k8s.io
