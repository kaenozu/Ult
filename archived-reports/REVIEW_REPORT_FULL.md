# ソースコードレビューレポート

**担当エンジニア:** Jules
**日付:** 2024-05-24
**対象:** `trading-platform` (Next.js App) および `backend` スクリプト

プロジェクト全体のソースコードレビューを実施しました。以前の報告内容の再検証に加え、新たな観点からも調査を行いました。以下に調査結果と改善案を報告します。

## 📊 概要
プロジェクトは Next.js (App Router) と Python バックエンドで構成されています。
TypeScript の型安全性や API の入力バリデーションなど、堅牢な基盤が構築されていますが、一部の**重要な計算ロジックにおけるパフォーマンス問題**や**競合状態（Race Condition）**が確認されました。これらはアプリケーションのスケーラビリティと信頼性に影響を与える可能性があります。

---

## 🛑 Critical (優先対応事項)

### 1. バックテスト計算の計算量爆発 (`app/lib/AccuracyService.ts` / `AnalysisService.ts`)
- **場所:** `AccuracyService.runBacktest` 内のループ処理
- **問題:** バックテストのループ（日数分）の中で、毎回 `analyzeStock` を呼び出しています。この `analyzeStock` はさらに `optimizeParameters` を呼び出し、パラメータ（RSI/SMA期間）の全探索を行っています。
- **計算量:** $O(Days \times Params \times History)$
  - データ期間が長くなると、計算時間が指数関数的ではなくとも多項式的に増大し、ブラウザをフリーズさせる恐れがあります。
- **推奨:**
  - `optimizeParameters` の結果をメモ化する（期間中にパラメータが頻繁に変わる必要はない場合）。
  - または、バックテスト実行前に一度だけパラメータ最適化を行う戦略に変更する。
  - ループ内での配列アロケーション（`.slice`）を減らす。

### 2. 注文処理における競合状態 (`app/components/OrderPanel.tsx`)
- **場所:** `OrderPanel.tsx` の `handleOrder` 関数
- **問題:** `setCash(portfolio.cash - totalCost)` と `addPosition(...)` が独立して呼び出されています。
  - `portfolio.cash` を読み取ってから `setCash` するまでの間に、ストアの状態が更新された場合（例：WebSocket更新や別タブでの操作）、その更新が失われる可能性があります（Stale State）。
  - また、連続クリックなどのUI操作により、資金が二重に減算されたり、整合性が取れなくなるリスクがあります。
- **推奨:**
  - `tradingStore` に `executeOrder(orderParams)` のようなアトミックなアクションを追加し、残高確認とポジション追加、現金減算を単一の同期処理（またはトランザクション）内で行うようにしてください。

### 3. チャート描画のパフォーマンス (`app/components/StockChart/hooks/useChartData.ts`)
- **場所:** `normalizedIndexData` の計算
- **問題:** `extendedData.labels.map` の中で `indexData.find` を使用しています。
  - これにより $O(N \times M)$ の計算量が発生しています（N=銘柄データ数, M=指数データ数）。両者が数千件になると、レンダリング毎に数百万回の比較が発生し、UIがカクつく原因となります。
- **推奨:**
  - `indexData` を `Map<DateString, Price>` に変換し、$O(1)$ で参照できるようにしてください。

---

## ⚠️ Major (重要な改善点)

### 1. Yahoo Finance API のデータ欠損処理 (`app/api/market/route.ts`)
- **場所:** `market/history` エンドポイント
- **問題:** `open: q.open || 0` のように、データが欠損している（`null`）場合に `0` を代入しています。
  - これにより、チャート上で価格が0円に急落する「スパイク」が表示され、移動平均線やボリンジャーバンドの計算が大きく狂う原因となります。
- **推奨:**
  - 前日の終値（`close`）で埋めるか、そのデータポイント自体を除外する処理に変更してください。

### 2. 未実装のRSIチャート (`app/page.tsx`)
- **場所:** `Workstation` コンポーネント内のRSIサブチャート
- **問題:** `<path d="M0,50 C50,40..." />` のように、ハードコードされたSVGパスが使用されており、実際の計算結果が反映されていません。
- **推奨:**
  - `StockChart` と同様に、実際のRSIデータに基づいてパスを生成するコンポーネントを実装してください。

### 3. バックエンドのトレンド判定が単純すぎる (`backend/src/market_correlation/analyzer.py`)
- **場所:** `detect_trend` 関数
- **問題:** 期間の最初と最後だけを比較してトレンドを判定しています。途中の変動やボラティリティが考慮されていません。
- **推奨:**
  - 線形回帰（Linear Regression）の傾きや、移動平均線の方向性を用いた判定ロジックへの変更を推奨します。

---

## ℹ️ Minor (軽微な修正・提案)

- **UI:** `OrderPanel` のボタンなどは `aria-label` 等が設定されておりアクセシビリティへの配慮が見られますが、キーボード操作時のフォーカス順序などをさらに改善できる余地があります。
- **テスト:** `BacktestResult` などの型定義が重複している箇所（`types` と `lib/backtest.ts`）があり、整理が推奨されます。

## ✅ Good Practices (評価点)

- **APIセキュリティ:** シンボルのバリデーション（正規表現、長さ制限）が適切に実装されており、DoS攻撃への対策がなされています。
- **構成:** コンポーネント、フック、ストアが適切にディレクトリ分けされており、可読性が高いです。
- **型安全性:** TypeScript の Strict モードが有効活用されており、`any` の使用も抑制されています。

以上
