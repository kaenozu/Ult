# Position Sizing Calculator - Implementation Summary

## 概要

ULTトレーディングプラットフォームに、適切な資金管理機能（ポジションサイジング計算機）を実装しました。

## 実装内容

### 1. ロジック実装 (PredictiveAnalyticsEngine.ts)

#### calculatePositionSize メソッド
口座資金とリスク許容度に基づいて、適切なポジションサイズを計算します。

**入力パラメータ:**
- `accountEquity`: 口座資金（円）
- `riskPerTrade`: 1取引あたりのリスク率（%）
- `entryPrice`: エントリー価格
- `stopLossPrice`: 損切り価格（ATRベース）
- `confidence`: シグナル信頼度（オプション）

**出力:**
- `recommendedShares`: 推奨購入株数
- `maxLossAmount`: 予想最大損失額
- `riskAmount`: リスク金額
- `positionValue`: ポジション価値
- `riskPercent`: 実際のリスク率
- `stopLossDistance`: 損切り距離
- `stopLossPercent`: 損切りパーセンテージ
- `reasoning`: 計算根拠の詳細説明

**計算ロジック:**
```
リスク金額 = 口座資金 × リスク率
推奨株数 = リスク金額 ÷ 損切り距離
```

**特徴:**
- 信頼度による調整（信頼度70%未満で株数を縮小）
- 最小単位チェック（100株未満で警告）
- ポートフォリオ集中リスクチェック（20%超で警告）
- ゼロ除算の安全処理

### 2. 状態管理 (riskManagementStore.ts)

Zustandを使用した資金管理設定のストア

**設定項目:**
- 口座資金（デフォルト: 100万円）
- 1取引あたりのリスク率（デフォルト: 2%）
- 最大ポジション比率（デフォルト: 20%）
- 最小購入株数（デフォルト: 100株）
- ATR倍率（デフォルト: 2.0）
- 信頼度調整の有効/無効
- 機能の有効/無効切り替え

**永続化:**
- LocalStorageを使用した設定の永続化
- バージョン管理対応

### 3. UI実装

#### AccountSettingsPanel コンポーネント
資金管理設定を入力するパネル

**機能:**
- 口座資金の入力
- リスク率の調整（スライダー + 数値入力）
- 最大ポジション比率の調整
- ATR倍率の設定
- 信頼度調整のON/OFF切り替え
- 設定の保存・リセット
- リアルタイムの計算プレビュー

**配置:**
- RightSidebarの「資金設定」タブ

#### PositionSizingDisplay コンポーネント
ポジションサイズ計算結果を表示

**表示内容:**
- 推奨購入株数（大きく表示）
- ポジション価値
- 予想最大損失（リスク率付き）
- 損切り距離（パーセンテージ + 金額）
- 警告メッセージ（必要に応じて）
- 計算根拠の詳細（折りたたみ可能）
- 現在の口座設定情報

**配置:**
- SignalCardコンポーネント内（目標価格・損切りライン の後）

### 4. 統合

**SignalPanel への統合:**
- シグナル表示時に自動的にポジションサイズを計算
- リスク管理設定が有効な場合のみ表示
- ATRベースの損切り価格と連動

**RightSidebar への統合:**
- 4つのタブ構成
  1. シグナル（従来の分析画面 + ポジションサイズ表示）
  2. アラート
  3. 注文
  4. 資金設定（新規追加）

## テスト

### 単体テスト (PositionSizing.test.ts)
12個のテストケースで網羅的にテスト

1. ✅ 基本的なポジションサイズ計算
2. ✅ 信頼度による調整（70%未満）
3. ✅ 高信頼度での調整なし（70%以上）
4. ✅ 小さい損切り距離の処理
5. ✅ 大きい損切り距離の処理
6. ✅ 異なるリスク率での計算
7. ✅ 計算根拠の出力
8. ✅ 少額株数での警告
9. ✅ 高いポジション比率での警告
10. ✅ ゼロ損切り距離のエッジケース
11. ✅ ポジション価値の正確性
12. ✅ リスク率の精度維持

**結果: 全テスト合格 (12/12)**

## 使用方法

### 1. 資金設定の入力

1. RightSidebarの「資金設定」タブを開く
2. 口座資金を入力（例: 100万円）
3. リスク率を設定（推奨: 1-2%）
4. その他の設定を調整（必要に応じて）
5. 「保存」ボタンをクリック

### 2. ポジションサイズの確認

1. 銘柄を選択してシグナルを表示
2. SignalCard内に自動的にポジションサイズが表示される
3. 推奨株数、最大損失、リスク率を確認
4. 警告がある場合は内容を確認
5. 「計算の詳細を表示」で根拠を確認可能

## 計算例

**設定:**
- 口座資金: 1,000,000円
- リスク率: 2%
- エントリー価格: 1,500円
- 損切り価格: 1,450円

**計算:**
```
損切り距離 = 1,500 - 1,450 = 50円
リスク金額 = 1,000,000 × 0.02 = 20,000円
推奨株数 = 20,000 ÷ 50 = 400株
ポジション価値 = 400 × 1,500 = 600,000円
予想最大損失 = 400 × 50 = 20,000円
実際のリスク率 = 20,000 ÷ 1,000,000 = 2.0%
```

**結果:**
- 推奨購入株数: 400株
- 予想最大損失: 20,000円（2.0%）
- ポジション価値: 600,000円（資金の60%）
- ポジション比率: ✅ 健全（20%以下推奨）

## セキュリティ & 品質

- ✅ TypeScript型安全性
- ✅ ゼロ除算の安全処理
- ✅ 入力値の妥当性チェック
- ✅ LocalStorageへの安全な永続化
- ✅ 包括的な単体テスト
- ✅ エラーハンドリング完備

## 技術スタック

- **State Management**: Zustand with persist middleware
- **UI Framework**: React 19 + TypeScript 5
- **Styling**: Tailwind CSS
- **Icons**: Lucide React
- **Testing**: Jest
- **Code Quality**: ESLint + TypeScript strict mode

## ファイル構成

```
trading-platform/
├── app/
│   ├── components/
│   │   ├── AccountSettingsPanel.tsx        # 資金設定パネル
│   │   ├── PositionSizingDisplay.tsx       # ポジションサイズ表示
│   │   ├── SignalCard.tsx                  # シグナルカード（統合）
│   │   └── RightSidebar.tsx                # サイドバー（統合）
│   ├── lib/
│   │   └── aiAnalytics/
│   │       ├── PredictiveAnalyticsEngine.ts # 計算ロジック
│   │       └── __tests__/
│   │           └── PositionSizing.test.ts  # 単体テスト
│   └── store/
│       └── riskManagementStore.ts          # 状態管理
```

## まとめ

- ✅ 口座資金とリスク許容度に基づく正確なポジションサイズ計算
- ✅ ATRベースの損切りラインとの連動
- ✅ 使いやすいUI（設定パネル + 結果表示）
- ✅ 包括的なテストカバレッジ
- ✅ TypeScript型安全性とエラーハンドリング
- ✅ 推奨ベストプラクティスの遵守（2%リスク、20%ポジション上限）

これにより、ユーザーは適切な資金管理を行い、破産リスクを抑えた安全な取引が可能になります。
