# ブレスト会議議事録：バグ取りと安定化 (Bug Fixing & Stability)

## 🎯 テーマ
**「AI Advisor」と「Auto-Rebalance」の実装に伴う技術的負債の解消と、予測不可能なシナリオに対する堅牢性の確保。**

## 🗣️ 対話の記録 (Dialogue Transcript)

### Q1: 新機能（Advisor, Rebalance）における技術的リスクは？
- **A1 (Qwen - Technical):**
    - **非同期処理の競合 (Race Conditions):** 自動リバランス中にユーザーが手動で注文を出した場合、ポートフォリオの状態が不整合になる可能性がある。排他制御（Locking mechanism）がバックエンドに不足している。
    - **データ鮮度の乖離 (Stale Data):** 「Regime Detector」が判断する市場レジームが、実際の価格データより数秒〜数分遅延した場合、AIが「暴落中に買い推奨」をする致命的なミスが発生する。
    - **APIレート制限の枯渇:** リバランス計算時に全保有銘柄の最新価格を一斉に取得するため、APIコール数が急増し、レート制限に引っかかるリスクが高い。

### Q2: システムを破壊するための「カオス」なテストシナリオは？
- **A2 (Big Pickle - Creative):**
    - **"The Flash Crash" (瞬間暴落):** モックデータで全銘柄を1秒間で-99%暴落させる。AI Advisorが「パニック」を起こさずに適切な損切り指示を出せるか、それとも例外で落ちるか？
    - **"The Zombie Network" (ゾンビ回線):** リバランス注文の送信中にネットワークを強制切断し、5秒後に復帰させる。注文が重複するか、あるいは消失してポートフォリオが中途半端な状態（片肺飛行）になるかを見る。
    - **"The Billionaire's Typo" (誤発注):** 1株買うつもりが「1億株」の注文リクエストが飛んできた場合、バックエンドのバリデーションが機能するか、それともAPIが破産を宣言するか。

## ⚔️ 議論 (Debate)

- **Qwenの主張:**
    - 「まずは排他制御だ。RedisまたはDBのトランザクションロックを実装しないと、リバランス機能は時限爆弾になる。また、レート制限に対するExponential Backoff（指数バックオフ）の実装も急務だ。」
- **Big Pickleの主張:**
    - 「守りに入りすぎるな！ 一番怖いのはシステムが落ちることじゃない、ユーザーに『何が起きたか分からない』と思わせることだ。エラー時のUI（Error Boundary）をリッチにして、"Network disconnected. Retrying..." とかっこよく表示すれば、バグも演出になる。」
- **Antigravity (Facilitator) の考察:**
    - 両者の指摘は妥当。バックエンドの堅牢性（Qwen）と、フロントエンドの回復力（Pickle）の両輪が必要。
    - 特に「リバランス中の競合」はデータ破損（資産消失に見える現象）に繋がるため、最優先度が高い。

## ⚖️ 最終決定 (Final Decision)

以下の3つの是正措置（Correction Plan）を実行する。

1.  **Project: Iron Lock (排他制御)**
    - リバランス実行中は `PortfolioManager` にロックをかけ、他の注文を受け付けないようにする。
2.  **Project: Chaos Drill (カオステスト)**
    - Big Pickleの提案した「ネットワーク遮断」と「異常値入力」を再現するテストスクリプトを作成し、予期せぬクラッシュがないか検証する。
3.  **Project: Visual Fail-safe (視覚的フェイルセーフ)**
    - エラー発生時に単にログを吐くのではなく、UI上に「System Integrity Alert」として状況を明示し、ユーザーが手動でリセットできるボタンを配置する。
