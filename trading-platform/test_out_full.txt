npm warn Expanding --ci to --cidr. This will stop working in the next major version of npm.

> trading-platform@0.1.0 test
> jest DataAggregator.test.ts

FAIL app/lib/api/__tests__/DataAggregator.test.ts
  ● DataAggregator › キャッシュ機能 › fetchWithCacheでデータをキャッシュできる

    TypeError: aggregator.fetchWithCache is not a function

      36 |       };
      37 |
    > 38 |       const result1 = await aggregator.fetchWithCache('AAPL', fetcher);
         |                                        ^
      39 |       const result2 = await aggregator.fetchWithCache('AAPL', fetcher);
      40 |
      41 |       expect(result1).toEqual(mockData);

      at Object.fetchWithCache (app/lib/api/__tests__/DataAggregator.test.ts:38:40)

  ● DataAggregator › キャッシュ機能 › TTLを指定してキャッシュできる

    TypeError: aggregator.fetchWithCache is not a function

      51 |       fetchMock.mockResolvedValueOnce(mockData);
      52 |
    > 53 |       const result = await aggregator.fetchWithCache('AAPL', () => Promise.resolve(mockData), 1000);
         |                                       ^
      54 |       expect(result).toEqual(mockData);
      55 |     });
      56 |

      at Object.fetchWithCache (app/lib/api/__tests__/DataAggregator.test.ts:53:39)

  ● DataAggregator › キャッシュ機能 › invalidateAllでキャッシュをクリアできる

    TypeError: aggregator.invalidateAll is not a function

      56 |
      57 |     it('invalidateAllでキャッシュをクリアできる', () => {
    > 58 |       aggregator.invalidateAll();
         |                  ^
      59 |       const stats = aggregator.getStats();
      60 |       expect(stats.cacheSize).toBe(0);
      61 |     });

      at Object.invalidateAll (app/lib/api/__tests__/DataAggregator.test.ts:58:18)

  ● DataAggregator › バッチ処理 › fetchBatchで複数のキーをバッチ取得できる

    TypeError: aggregator.fetchBatch is not a function

      69 |       ]);
      70 |
    > 71 |       const result = await aggregator.fetchBatch(
         |                                       ^
      72 |         ['AAPL', 'GOOGL'],
      73 |         (keys) => {
      74 |           const data = new Map();

      at Object.fetchBatch (app/lib/api/__tests__/DataAggregator.test.ts:71:39)

  ● DataAggregator › バッチ処理 › 空のキー配列で空のMapを返す

    TypeError: aggregator.fetchBatch is not a function

      86 |
      87 |     it('空のキー配列で空のMapを返す', async () => {
    > 88 |       const result = await aggregator.fetchBatch([], () => Promise.resolve(new Map()));
         |                                       ^
      89 |       expect(result.size).toBe(0);
      90 |     });
      91 |   });

      at Object.fetchBatch (app/lib/api/__tests__/DataAggregator.test.ts:88:39)

  ● DataAggregator › リクエスト重複排除 › 同じリクエストを重複して送信しない

    TypeError: aggregator.fetchWithCache is not a function

      104 |
      105 |       const [result1, result2] = await Promise.all([
    > 106 |         aggregator.fetchWithCache('AAPL', fetcher),
          |                    ^
      107 |         aggregator.fetchWithCache('AAPL', fetcher),
      108 |       ]);
      109 |

      at Object.fetchWithCache (app/lib/api/__tests__/DataAggregator.test.ts:106:20)

  ● DataAggregator › エラーハンドリング › ネットワークエラーを適切に処理する

    TypeError: aggregator.fetchWithCache is not a function

      117 |     it('ネットワークエラーを適切に処理する', async () => {
      118 |       await expect(
    > 119 |         aggregator.fetchWithCache('AAPL', () => Promise.reject(new Error('Network error')))
          |                    ^
      120 |       ).rejects.toThrow('Network error');
      121 |     });
      122 |

      at Object.fetchWithCache (app/lib/api/__tests__/DataAggregator.test.ts:119:20)

  ● DataAggregator › エラーハンドリング › APIエラーを適切に処理する

    TypeError: aggregator.fetchWithCache is not a function

      123 |     it('APIエラーを適切に処理する', async () => {
      124 |       await expect(
    > 125 |         aggregator.fetchWithCache('AAPL', () => Promise.reject(new Error('Internal Server Error')))
          |                    ^
      126 |       ).rejects.toThrow();
      127 |     });
      128 |   });

      at Object.fetchWithCache (app/lib/api/__tests__/DataAggregator.test.ts:125:20)

  ● DataAggregator › レート制限 › 統計情報を取得できる

    TypeError: aggregator.fetchWithCache is not a function

      134 |       ];
      135 |
    > 136 |       await aggregator.fetchWithCache('AAPL', () => Promise.resolve(mockData));
          |                        ^
      137 |       const stats = aggregator.getStats();
      138 |
      139 |       expect(stats.totalRequests).toBe(1);

      at Object.fetchWithCache (app/lib/api/__tests__/DataAggregator.test.ts:136:24)

  ● DataAggregator › 優先度キュー › fetchWithPriorityで優先度を指定できる

    TypeError: aggregator.fetchWithPriority is not a function

      149 |       ];
      150 |
    > 151 |       const result = await aggregator.fetchWithPriority(['AAPL'], 'high', () => Promise.resolve(mockData));
          |                                       ^
      152 |       expect(result).toBeInstanceOf(Map);
      153 |       expect((result as Map<string, OHLCV>).get('AAPL')).toEqual(mockData[0]);
      154 |     });

      at Object.fetchWithPriority (app/lib/api/__tests__/DataAggregator.test.ts:151:39)

  ● DataAggregator › 統計情報 › 初期状態で統計がゼロである

    TypeError: aggregator.getStats is not a function

      157 |   describe('統計情報', () => {
      158 |     it('初期状態で統計がゼロである', () => {
    > 159 |       const stats = aggregator.getStats();
          |                                ^
      160 |       expect(stats.cacheHits).toBe(0);
      161 |       expect(stats.cacheMisses).toBe(0);
      162 |       expect(stats.totalRequests).toBe(0);

      at Object.getStats (app/lib/api/__tests__/DataAggregator.test.ts:159:32)

PASS app/domains/market-data/integration/__tests__/MultiSourceDataAggregator.test.ts (5.717 s)
  ● Console

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source C (priority: 3)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source C (priority: 3)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Unregistered source: A

      at MultiSourceDataAggregator.log [as unregisterSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:93:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source C (priority: 3)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

FAIL app/infrastructure/api/__tests__/DataAggregator.test.ts (11.676 s)
  ● Console

    console.warn
      [2026-02-14T13:51:03.841Z] [WARN]  [Aggregator] Failed to update data for AAPL, using stale data.

      84 |     const formatted = this.formatMessage('warn', message, context);
      85 |     if (this.config.enableConsole) {
    > 86 |       console.warn(formatted, data ?? '');
         |               ^
      87 |     }
      88 |     this.addLog({ timestamp: new Date(), level: 'warn', message, context, data });
      89 |   }

      at Logger.warn (app/core/logger.ts:86:15)
      at warn (app/infrastructure/api/data-aggregator.ts:226:24)

    console.warn
      [2026-02-14T13:51:07.393Z] [WARN]  [Aggregator] Failed to update data for AAPL, using stale data.

      84 |     const formatted = this.formatMessage('warn', message, context);
      85 |     if (this.config.enableConsole) {
    > 86 |       console.warn(formatted, data ?? '');
         |               ^
      87 |     }
      88 |     this.addLog({ timestamp: new Date(), level: 'warn', message, context, data });
      89 |   }

      at Logger.warn (app/core/logger.ts:86:15)
      at warn (app/infrastructure/api/data-aggregator.ts:226:24)
      at MarketDataClient.fetchOHLCV (app/infrastructure/api/data-aggregator.ts:250:20)
      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:488:20)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:132:7)

    console.warn
      [2026-02-14T13:51:10.926Z] [WARN]  [Aggregator] Failed to update data for AAPL, using stale data.

      84 |     const formatted = this.formatMessage('warn', message, context);
      85 |     if (this.config.enableConsole) {
    > 86 |       console.warn(formatted, data ?? '');
         |               ^
      87 |     }
      88 |     this.addLog({ timestamp: new Date(), level: 'warn', message, context, data });
      89 |   }

      at Logger.warn (app/core/logger.ts:86:15)
      at warn (app/infrastructure/api/data-aggregator.ts:226:24)
      at MarketDataClient.fetchOHLCV (app/infrastructure/api/data-aggregator.ts:250:20)
      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:488:20)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:142:7)

  ● DataAggregator › バッチ処理 › バッチサイズ制限を尊重する

    No data available

      488 |     const result = await this.fetchOHLCV(symbol);
      489 |     if (result.success && result.data) return result.data;
    > 490 |     throw new Error(result.error || 'Fetch failed');
          |           ^
      491 |   }
      492 |
      493 |   /**

      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:490:11)
          at async Promise.all (index 0)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:97:23)

  ● DataAggregator › リクエスト重複排除 › 同じリクエストを重複して送信しない

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 37

      122 |       expect(result1).toEqual(mockData);
      123 |       expect(result2).toEqual(mockData);
    > 124 |       expect(fetchMock).toHaveBeenCalledTimes(1);
          |                         ^
      125 |     });
      126 |   });
      127 |

      at Object.toHaveBeenCalledTimes (app/infrastructure/api/__tests__/DataAggregator.test.ts:124:25)

  ● DataAggregator › エラーハンドリング › ネットワークエラーを適切に処理する

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: [{"close": 102, "date": "2024-01-01", "high": 105, "low": 95, "open": 100, "symbol": "AAPL", "volume": 1000}]

      130 |       fetchMock.mockRejectedValueOnce(new Error('Network error'));
      131 |
    > 132 |       await expect(aggregator.fetchData('AAPL')).rejects.toThrow('Network error');
          |                   ^
      133 |     });
      134 |
      135 |     it('APIエラーを適切に処理する', async () => {

      at expect (node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:132:19)

  ● DataAggregator › エラーハンドリング › APIエラーを適切に処理する

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: [{"close": 102, "date": "2024-01-01", "high": 105, "low": 95, "open": 100, "symbol": "AAPL", "volume": 1000}]

      140 |       });
      141 |
    > 142 |       await expect(aggregator.fetchData('AAPL')).rejects.toThrow();
          |                   ^
      143 |     });
      144 |   });
      145 |

      at expect (node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:142:19)

  ● DataAggregator › 優先度キュー › 優先度の高いリクエストを先に処理する

    No data available

      488 |     const result = await this.fetchOHLCV(symbol);
      489 |     if (result.success && result.data) return result.data;
    > 490 |     throw new Error(result.error || 'Fetch failed');
          |           ^
      491 |   }
      492 |
      493 |   /**

      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:490:11)
          at async Promise.all (index 0)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:178:23)

Test Suites: 2 failed, 1 passed, 3 total
Tests:       16 failed, 29 passed, 45 total
Snapshots:   0 total
Time:        13.15 s
Ran all test suites matching /DataAggregator.test.ts/i.
