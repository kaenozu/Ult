# ソースコードレビュー報告書

**日付:** 2024年5月22日
**対象:** trading-platform (Next.js Frontend) および関連スクリプト

## 1. 概要
プロジェクト全体として、モダンな技術スタック（Next.js 14+, Tailwind CSS v4, Zustand）が採用されており、型安全性（TypeScript Strict Mode）やセキュリティ設定（HTTPヘッダー、入力検証）への意識が高いコードベースです。
一方で、バックテストやデータ分析ロジックにおいて、計算量が指数関数的に増加する実装が含まれており、データ量が増加した際のパフォーマンスに懸念があります。

## 2. クリティカルな課題 (Critical Issues)

### 2.1 バックテストの計算量爆発 (`app/lib/backtest.ts`)
- **問題:** `runBacktest` 関数内でループごとに `analyzeStock` を呼び出しており、さらにその中で `optimizeParameters`（パラメータ探索のループ）が実行されています。
- **影響:** 計算量が **O(N * M)** （N=日数, M=パラメータ組み合わせ数）となり、期間が長い場合やパラメータ範囲を広げた場合にブラウザのメインスレッドを長時間ブロック（フリーズ）させる原因になります。
- **推奨:** パラメータ最適化はバックテスト期間全体で1回行うか、計算結果をキャッシュ（メモ化）する仕組みが必要です。またはWeb Workerへのオフロードを検討してください。

### 2.2 メインスレッドでの重いデータ取得 (`app/components/SignalPanel.tsx`)
- **問題:** コンポーネントのマウント時に `calculateFullPerformance` が実行され、APIから過去2年分の全データを取得しています。
- **影響:** ユーザーがタブを切り替えるたびに大量のデータフェッチと計算が発生し、UIのレスポンス低下やAPIのレート制限に抵触する可能性があります。
- **推奨:** データ取得を React Query などでキャッシュするか、サーバーサイドで計算済みの統計情報のみを返すエンドポイントを作成してください。

## 3. メジャーな改善点 (Major Improvements)

### 3.1 データ取得の直列実行 (`app/hooks/useStockData.ts`)
- **現状:** `fetchOHLCV` (個別), `fetchOHLCV` (指数), `fetchSignal` が `await` で順次実行されています。
- **改善:** `Promise.all` を使用して並列実行することで、データ読み込み時間を短縮できます。

### 3.2 状態管理とロジックの分離 (`app/store/tradingStore.ts`)
- **現状:** `processAITrades` アクション内に、利確・損切りの判定やスリッページ計算、自己反省コメント生成などの複雑なドメインロジックが含まれています。
- **改善:** これらのロジックは `app/lib/trade-logic.ts` などの純粋関数として切り出し、Storeは状態の更新のみに責務を限定すべきです。テストも容易になります。

### 3.3 モバイルメニューのアクセシビリティ (`app/page.tsx`)
- **現状:** モバイル用サイドバー開閉ボタンが `<svg>` のみで構成されており、スクリーンリーダー用のラベル (`aria-label`) が不足しています。
- **改善:** `<button aria-label="メニューを開く">` のように明示的なラベルを付与してください。

## 4. マイナーな改善点・確認事項 (Minor Issues)

- **チャートのアクセシビリティ (`StockChart.tsx`):** Canvas要素には中身がないため、スクリーンリーダー利用者には情報が伝わりません。データの要約テーブルを非表示で配置するか、`aria-label` / `role="img"` で概要を説明することを推奨します。
- **テストツールのパス依存 (`skills/frontend-tester.js`):** `path.join(__dirname, '..', 'trading-platform')` というハードコードされたパスがあり、フォルダ構成の変更に弱くなっています。設定ファイルや引数で渡せるようにすると柔軟性が向上します。
- **APIの期間計算 (`api/market/route.ts`):** 履歴データ取得時、開始日が指定されない場合のデフォルトが「現在から5年前」と固定されています。定数として定義するか、クライアント側から柔軟に制御できる設計が望ましいです。

## 5. セキュリティ評価
- ✅ **入力検証:** APIルート (`market/route.ts`) でシンボルに対して厳格な正規表現チェックが行われており良好です。
- ✅ **ヘッダー設定:** `next.config.ts` に HSTS や X-Frame-Options などのセキュリティヘッダーが適切に設定されています。
- ✅ **依存関係:** `eslint` の設定で `no-explicit-any` がエラー設定されており、型安全性が保たれています。

## 6. 次のステップへの提案
1. `backtest.ts` のアルゴリズム最適化（最優先）
2. `useStockData.ts` の `Promise.all` 化
3. アクセシビリティ修正（aria-label追加）
