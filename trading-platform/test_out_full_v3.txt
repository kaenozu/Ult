npm warn Expanding --ci to --cidr. This will stop working in the next major version of npm.

> trading-platform@0.1.0 test
> jest DataAggregator.test.ts

FAIL app/lib/api/__tests__/DataAggregator.test.ts
  ● DataAggregator › 優先度キュー › fetchWithPriorityで優先度を指定できる

    expect(received).toEqual(expected) // deep equality

    Expected: {"close": 102, "date": "2024-01-01", "high": 105, "low": 95, "open": 100, "symbol": "AAPL", "volume": 1000}
    Received: [{"close": 102, "date": "2024-01-01", "high": 105, "low": 95, "open": 100, "symbol": "AAPL", "volume": 1000}]

      151 |       const result = await aggregator.fetchWithPriority(['AAPL'], 'high', () => Promise.resolve(mockData));
      152 |       expect(result).toBeInstanceOf(Map);
    > 153 |       expect((result as Map<string, OHLCV>).get('AAPL')).toEqual(mockData[0]);
          |                                                          ^
      154 |     });
      155 |   });
      156 |

      at Object.toEqual (app/lib/api/__tests__/DataAggregator.test.ts:153:58)

PASS app/domains/market-data/integration/__tests__/MultiSourceDataAggregator.test.ts (5.723 s)
  ● Console

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source C (priority: 3)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source C (priority: 3)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Unregistered source: A

      at MultiSourceDataAggregator.log [as unregisterSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:93:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source C (priority: 3)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source B (priority: 2)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

    console.log
      [Aggregator] Registered source: Source A (priority: 1)

      at MultiSourceDataAggregator.log [as registerSource] (app/domains/market-data/integration/MultiSourceDataAggregator.ts:85:13)

FAIL app/infrastructure/api/__tests__/DataAggregator.test.ts (11.673 s)
  ● Console

    console.warn
      [2026-02-14T13:53:03.879Z] [WARN]  [Aggregator] Failed to update data for AAPL, using stale data.

      84 |     const formatted = this.formatMessage('warn', message, context);
      85 |     if (this.config.enableConsole) {
    > 86 |       console.warn(formatted, data ?? '');
         |               ^
      87 |     }
      88 |     this.addLog({ timestamp: new Date(), level: 'warn', message, context, data });
      89 |   }

      at Logger.warn (app/core/logger.ts:86:15)
      at warn (app/infrastructure/api/data-aggregator.ts:234:24)

    console.warn
      [2026-02-14T13:53:07.421Z] [WARN]  [Aggregator] Failed to update data for AAPL, using stale data.

      84 |     const formatted = this.formatMessage('warn', message, context);
      85 |     if (this.config.enableConsole) {
    > 86 |       console.warn(formatted, data ?? '');
         |               ^
      87 |     }
      88 |     this.addLog({ timestamp: new Date(), level: 'warn', message, context, data });
      89 |   }

      at Logger.warn (app/core/logger.ts:86:15)
      at warn (app/infrastructure/api/data-aggregator.ts:234:24)
      at MarketDataClient.fetchOHLCV (app/infrastructure/api/data-aggregator.ts:258:20)
      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:496:20)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:132:7)

    console.warn
      [2026-02-14T13:53:10.955Z] [WARN]  [Aggregator] Failed to update data for AAPL, using stale data.

      84 |     const formatted = this.formatMessage('warn', message, context);
      85 |     if (this.config.enableConsole) {
    > 86 |       console.warn(formatted, data ?? '');
         |               ^
      87 |     }
      88 |     this.addLog({ timestamp: new Date(), level: 'warn', message, context, data });
      89 |   }

      at Logger.warn (app/core/logger.ts:86:15)
      at warn (app/infrastructure/api/data-aggregator.ts:234:24)
      at MarketDataClient.fetchOHLCV (app/infrastructure/api/data-aggregator.ts:258:20)
      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:496:20)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:142:7)

  ● DataAggregator › バッチ処理 › バッチサイズ制限を尊重する

    No data available

      496 |     const result = await this.fetchOHLCV(symbol);
      497 |     if (result.success && result.data) return result.data;
    > 498 |     throw new Error(result.error || 'Fetch failed');
          |           ^
      499 |   }
      500 |
      501 |   /**

      at MarketDataClient.fetchData (app/infrastructure/api/data-aggregator.ts:498:11)
          at async Promise.all (index 0)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:97:23)

  ● DataAggregator › リクエスト重複排除 › 同じリクエストを重複して送信しない

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 37

      122 |       expect(result1).toEqual(mockData);
      123 |       expect(result2).toEqual(mockData);
    > 124 |       expect(fetchMock).toHaveBeenCalledTimes(1);
          |                         ^
      125 |     });
      126 |   });
      127 |

      at Object.toHaveBeenCalledTimes (app/infrastructure/api/__tests__/DataAggregator.test.ts:124:25)

  ● DataAggregator › エラーハンドリング › ネットワークエラーを適切に処理する

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: [{"close": 102, "date": "2024-01-01", "high": 105, "low": 95, "open": 100, "symbol": "AAPL", "volume": 1000}]

      130 |       fetchMock.mockRejectedValueOnce(new Error('Network error'));
      131 |
    > 132 |       await expect(aggregator.fetchData('AAPL')).rejects.toThrow('Network error');
          |                   ^
      133 |     });
      134 |
      135 |     it('APIエラーを適切に処理する', async () => {

      at expect (node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:132:19)

  ● DataAggregator › エラーハンドリング › APIエラーを適切に処理する

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: [{"close": 102, "date": "2024-01-01", "high": 105, "low": 95, "open": 100, "symbol": "AAPL", "volume": 1000}]

      140 |       });
      141 |
    > 142 |       await expect(aggregator.fetchData('AAPL')).rejects.toThrow();
          |                   ^
      143 |     });
      144 |   });
      145 |

      at expect (node_modules/jest-circus/node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (app/infrastructure/api/__tests__/DataAggregator.test.ts:142:19)

Test Suites: 2 failed, 1 passed, 3 total
Tests:       5 failed, 40 passed, 45 total
Snapshots:   0 total
Time:        13.145 s
Ran all test suites matching /DataAggregator.test.ts/i.
