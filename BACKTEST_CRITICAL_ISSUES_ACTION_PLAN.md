# バックテストクリティカル問題 アクションプラン
# Backtest Critical Issues Action Plan

**ドキュメントバージョン**: 1.0  
**作成日**: 2026-02-02  
**最終更新**: 2026-02-02  
**ステータス**: 承認待ち  

---

## 1. エグゼクティブサマリー (Executive Summary)

### 概要

本ドキュメントは、ULT Trading Platformのバックテストシステムで発見された**10個の重要問題**に対する包括的な優先順位付けとアクションプランを定義します。

### 主要指標

| 指標 | 値 |
|------|-----|
| **発見された問題総数** | 10件 |
| **クリティカルバグ** | 4件 |
| **高優先度問題** | 3件 |
| **中優先度問題** | 3件 |
| **推定総工数** | 約6週間 |
| **影響を受けるシステム** | バックテストエンジン全般 |

### ビジネスインパクト

- **バックテスト精度への影響**: 最大50%の誤差が発生する可能性
- **取引システム信頼性**: 誤った戦略が本番環境にデプロイされるリスク
- **規制対応**: 金融規制での時価評価要件未達
- **ユーザー信頼**: 誤った結果に基づく意思決定のリスク

---

## 2. 優先度マトリックス (Priority Matrix)

### 優先度定義

| 優先度 | 定義 | 対応目標 |
|--------|------|----------|
| **P0** | クリティカル - システムの核心的な機能が損なわれる | 即時対応（1週間以内） |
| **P1** | 高 - 主要機能に重大な影響 | 1-3週間以内 |
| **P2** | 中 - 機能は動作するが改善が必要 | 3-6週間以内 |
| **P3** | 低 - 技術的負債、将来の改善対象 | 次のスプリント以降 |

### 詳細優先度テーブル

| Issue ID | タイトル | 重大度 | バックテスト精度への影響 | 信頼性への影響 | 工数 | 優先度 |
|----------|---------|--------|------------------------|---------------|------|--------|
| TRADING-029 | エグジット取引ポジション参照エラー | Critical | 10/10 | 10/10 | 8h | **P0** |
| TRADING-030 | ポジションサイジングゼロ除算 | Critical | 10/10 | 10/10 | 8h | **P0** |
| TRADING-031 | 手数料計算ロジックの不整合 | Critical | 9/10 | 9/10 | 16h | **P0** |
| TRADING-032 | スリッページ計算の不整合 | Critical | 9/10 | 9/10 | 12h | **P0** |
| TRADING-033 | 損益計算の二重計上 | High | 8/10 | 8/10 | 12h | **P1** |
| TRADING-034 | マークトゥマーケット未実装 | High | 7/10 | 7/10 | 16h | **P1** |
| TRADING-035 | 機会コスト計算未実装 | High | 7/10 | 6/10 | 20h | **P1** |
| TRADING-036 | パフォーマンス問題 (O(n²)) | Medium | 5/10 | 6/10 | 24h | **P2** |
| TRADING-037 | 入力検証欠如 | Medium | 6/10 | 7/10 | 12h | **P2** |
| TRADING-038 | アーキテクチャリファクタリング | Medium | 4/10 | 5/10 | 40h | **P2** |

### 重大度スコアリング基準

| スコア | バックテスト精度への影響 | 信頼性への影響 |
|--------|------------------------|---------------|
| 10 | 結果が完全に無効化される | システムがクラッシュまたはデータ損失 |
| 9 | 結果に重大な誤差が含まれる | 信頼できないデータ生成 |
| 8 | 重要なメトリクスが不正確 | 誤った意思決定のリスク |
| 7 | 複数のメトリクスに影響 | ユーザー信頼の低下 |
| 6 | 一部のメトリクスに影響 | エラーを引き起こす可能性 |
| 5 | 軽微な精度低下 | 限定的な信頼性問題 |

---

## 3. クリティカル問題詳細 (P0)

### TRADING-029: エグジット取引ポジション参照エラー

#### 概要

| 項目 | 内容 |
|------|------|
| **Issue ID** | TRADING-029 |
| **重大度** | Critical |
| **優先度** | P0 |
| **推定修正時間** | 8時間 |
| **担当** | バックエンドリードエンジニア |

#### 問題の説明

バックテストサービス（[`backtest-service.ts`](trading-platform/app/lib/backtest-service.ts:309-320)）において、エグジット取引（ポジション解消）の処理で致命的なバグが存在します。`executeTrade` メソッド内で、エグジット取引を判定する際に `newPosition` ではなく `currentPosition` を参照すべき箇所で誤った変数を使用しています。

#### 根本原因

1. エグジット取引の分岐に入る時点で、`newPosition` は `null` で初期化されています
2. 実際に存在すべきポジションは `currentPosition` パラメータに格納されています
3. そのため、エグジット条件 `if (!newPosition)` は常に真となり、エグジット処理が実行されません

#### ビジネスインパクト

- **エグジット取引が一切実行されない**
- ポジションが**永久に保有状態**となり、クローズされない
- バックテスト結果が**完全に無効化**される
- 勝率、リターン、ドローダウンなど**すべてのメトリクスが誤った値**を示す
- ユーザーが誤った戦略判断を下すリスク

#### 技術的インパクト

- ポジション管理ロジックの完全な破壊
- 取引履歴の不整合
- メモリリークの可能性（永続的なポジションオブジェクト）

#### 即時対応が必要な措置

```typescript
// 修正前（問題のあるコード）
} else {
  // エグジット取引
  if (!newPosition) {  // ❌ BUG: newPosition は常に null
    return { success: false, ... };
  }
}

// 修正後
} else {
  // エグジット取引
  if (!currentPosition) {  // ✅ FIX: currentPosition を参照
    return { success: false, ... };
  }
}
```

#### 検証ステップ

1. **単体テスト**: エグジット取引が正しく実行されることを検証
2. **統合テスト**: エントリー→エグジットの一連の流れを検証
3. **リグレッションテスト**: 既存のバックテストシナリオが正しく動作することを確認

---

### TRADING-030: ポジションサイジングゼロ除算

#### 概要

| 項目 | 内容 |
|------|------|
| **Issue ID** | TRADING-030 |
| **重大度** | Critical |
| **優先度** | P0 |
| **推定修正時間** | 8時間 |
| **担当** | バックエンドリードエンジニア |

#### 問題の説明

バックテストサービス（[`backtest-service.ts`](trading-platform/app/lib/backtest-service.ts:251-253)）のポジションサイズ計算において、ゼロ除算が発生する可能性のある致命的なバグが存在します。ストップロス価格がエントリー価格と同じ、または非常に近い場合、`stopLossDistance` がゼロまたは極めて小さな値となります。

#### 根本原因

1. ストップロス未設定時のデフォルト値欠如
2. ストップロス距離の最小値チェック欠如
3. 異常値に対する保護ロジックの欠如

```typescript
// 問題のあるコード
const stopLossDistance = Math.abs(price - trade.signal.stopLoss);
const positionSize = riskAmount / stopLossDistance;  // ❌ ゼロ除算の可能性
```

#### ビジネスインパクト

- **アプリケーションクラッシュ**: ランタイムエラーでバックテスト処理が停止
- **異常なポジションサイズ**: 理論上無限大に近いポジションを取得
- **誤ったリスク評価**: 実際のリスクが設定値を大幅に超える
- **データ整合性の喪失**: バックテスト結果が完全に信頼できないものになる

#### 技術的インパクト

- JavaScriptの `Infinity` 値の伝播
- メモリオーバーフローのリスク
- 後続の計算全てが無効化

#### 即時対応が必要な措置

```typescript
// FIX: ゼロ除算防止と最小距離の保証
const MIN_STOP_LOSS_DISTANCE_PERCENT = 0.005; // 最小0.5%
const minStopLossDistance = price * MIN_STOP_LOSS_DISTANCE_PERCENT;
const effectiveStopLossDistance = Math.max(stopLossDistance, minStopLossDistance);
const positionSize = riskAmount / effectiveStopLossDistance;

// 追加: ポジションサイズの上限チェック
const MAX_POSITION_SIZE_RATIO = 0.5;
const maxPositionSize = (currentCapital * MAX_POSITION_SIZE_RATIO) / price;
const finalPositionSize = Math.min(positionSize, maxPositionSize);
```

#### 検証ステップ

1. **エッジケーステスト**: ストップロス = エントリー価格のシナリオ
2. **異常値テスト**: 極めて小さなストップロス距離
3. **境界値テスト**: 最小距離の境界条件

---

### TRADING-031: 手数料計算ロジックの不整合

#### 概要

| 項目 | 内容 |
|------|------|
| **Issue ID** | TRADING-031 |
| **重大度** | Critical |
| **優先度** | P0 |
| **推定修正時間** | 16時間 |
| **担当** | バックエンドエンジニア + アーキテクト |

#### 問題の説明

取引手数料の計算ロジックが複数のコンポーネント間で一貫していません。同じパラメータ設定でも、使用するエンジンやサービスによって異なる手数料が適用されます。

#### 不整合のある実装

| コンポーネント | 計算方式 | エントリー手数料 | エグジット手数料 |
|--------------|---------|-----------------|-----------------|
| [`BacktestService`](trading-platform/app/lib/backtest-service.ts:265, 334) | 固定額 | `+ commission` | `- commission` |
| [`StrategyCatalog`](trading-platform/app/lib/strategy-catalog.ts:67, 71, 83, 90) | パーセンテージ | `* (1 + commission)` | `* (1 - commission)` |
| [`AdvancedBacktestEngine`](trading-platform/app/lib/backtest/advanced-backtest-engine.ts:386) | パーセンテージ | `(entry + exit) * commission%` | 同上 |
| [`TransactionCostModel`](trading-platform/app/lib/costs/transaction-cost-model.ts) | 階層型 | ブローカー別テーブル | ブローカー別テーブル |
| [`PaperTradingEnvironment`](trading-platform/app/lib/paper-trading/paper-trading-environment.ts:234, 353) | パーセンテージ | `value * commissionRate%` | 同上 |

#### 根本原因

1. 共通の手数料計算インターフェースの欠如
2. 各コンポーネントでの独自実装
3. 手数料モデルの標準化されていない定義

#### ビジネスインパクト

- **結果の信頼性喪失**: 同じ戦略でもエンジンによって異なる結果
- **収益性の誤評価**: 手数料の違いで収益/損失が逆転する可能性
- **戦略選択の誤り**: 誤った手数料計算に基づく最適化
- **コンプライアンスリスク**: 実際の取引コストとの乖離

#### 技術的インパクト

- メンテナンスの困難さ
- テストの複雑化
- 新しい手数料モデル追加時の影響範囲拡大

#### 即時対応が必要な措置

```typescript
// shared/types/commission.ts
export interface CommissionConfig {
  type: 'fixed' | 'percentage' | 'tiered';
  fixedAmount?: number;
  percentageRate?: number;
  tiers?: Array<{ minVolume: number; maxVolume: number; rate: number }>;
  minCommission?: number;
  maxCommission?: number;
}

// shared/utils/CommissionCalculator.ts
export class StandardCommissionCalculator implements CommissionCalculator {
  calculateEntryCommission(orderValue: number, config: CommissionConfig): number {
    return this.calculateCommission(orderValue, config);
  }

  calculateExitCommission(orderValue: number, config: CommissionConfig): number {
    return this.calculateCommission(orderValue, config);
  }

  calculateTotalCommission(entryValue: number, exitValue: number, config: CommissionConfig): number {
    return this.calculateEntryCommission(entryValue, config) +
           this.calculateExitCommission(exitValue, config);
  }
}
```

#### 検証ステップ

1. **単体テスト**: 各手数料タイプの計算精度
2. **統合テスト**: 全コンポーネント間の一貫性
3. **リグレッションテスト**: 既存のバックテスト結果との比較

---

### TRADING-032: スリッページ計算の不整合

#### 概要

| 項目 | 内容 |
|------|------|
| **Issue ID** | TRADING-032 |
| **重大度** | Critical |
| **優先度** | P0 |
| **推定修正時間** | 12時間 |
| **担当** | バックエンドエンジニア |

#### 問題の説明

スリッページ（価格スリップ）の計算ロジックが複数のコンポーネント間で一貫していません。異なるエンジンで異なる方向性（プラス/マイナス）や計算方法が使用されています。

#### 不整合のある実装

| コンポーネント | 買いスリッページ | 売りスリッページ | 計算方法 |
|--------------|-----------------|-----------------|---------|
| [`BacktestService`](trading-platform/app/lib/backtest-service.ts:278-280) | `price * (1 + slippage)` | `price * (1 - slippage)` | 対称的 |
| [`StrategyCatalog`](trading-platform/app/lib/strategy-catalog.ts:67, 90) | `price * (1 + slippage)` | `price * (1 - slippage)` | 対称的 |
| [`AdvancedBacktestEngine`](trading-platform/app/lib/backtest/advanced-backtest-engine.ts:310-320) | `price + slippageAmount` | `price - slippageAmount` | 対称的 |

#### 根本原因

1. スリッページの方向性定義の欠如
2. パーセンテージ vs 固定額の混在
3. ボラティリティ適応型スリッページの欠如

#### ビジネスインパクト

- **実行価格の誤算**: 実際の市場条件と乖離
- **収益性の偏り**: 常に有利または不利な方向に偏った計算
- **戦略の誤評価**: 実際の取引環境との不一致

#### 技術的インパクト

- スリッページモデルの拡張困難
- テストデータ作成の複雑化

#### 即時対応が必要な措置

```typescript
// shared/types/slippage.ts
export interface SlippageConfig {
  type: 'fixed' | 'percentage' | 'volatility_adjusted';
  fixedAmount?: number;
  percentageRate?: number;
  volatilityMultiplier?: number;
  direction: 'adverse' | 'favorable' | 'symmetric';
}

export interface SlippageCalculator {
  calculate(
    basePrice: number,
    direction: 'BUY' | 'SELL',
    volatility: number,
    config: SlippageConfig
  ): number;
}
```

#### 検証ステップ

1. **単体テスト**: 各スリッページタイプの計算
2. **方向性テスト**: 買い/売りの両方向での検証
3. **統合テスト**: 全エンジン間の一貫性

---

## 4. 依存関係グラフ (Dependency Graph)

### 問題間の依存関係

```
┌─────────────────────────────────────────────────────────────────────┐
│                     依存関係グラフ                                   │
└─────────────────────────────────────────────────────────────────────┘

Phase 1: 緊急修正 (Week 1)
═══════════════════════════════════════════════════════════════════════

  ┌──────────────────┐         ┌──────────────────┐
  │   TRADING-030    │         │   TRADING-029    │
  │ ゼロ除算バグ      │────────▶│ エグジットバグ   │
  │     (P0)         │         │     (P0)         │
  └──────────────────┘         └────────┬─────────┘
                                        │
                                        ▼
  ┌──────────────────┐         ┌──────────────────┐
  │   TRADING-031    │────────▶│   TRADING-032    │
  │  手数料不整合     │ 並行    │  スリッページ     │
  │     (P0)         │────────▶│   不整合 (P0)    │
  └──────────────────┘         └──────────────────┘
                                        │
                                        │ 一緒に修正推奨
                                        ▼

Phase 2: 精度改善 (Week 2-3)
═══════════════════════════════════════════════════════════════════════

  ┌──────────────────┐         ┌──────────────────┐
  │   TRADING-033    │         │   TRADING-034    │
  │ 損益二重計上      │─ ─ ─ ─ ─▶│ マークトゥ        │
  │     (P1)         │ 先に     │  マーケット      │
  │                  │ 修正     │     (P1)         │
  └──────────────────┘         └────────┬─────────┘
                                        │
                                        ▼
                              ┌──────────────────┐
                              │   TRADING-035    │
                              │  機会コスト      │
                              │   未実装 (P1)    │
                              └──────────────────┘

Phase 3: パフォーマンス・アーキテクチャ (Week 4-6)
═══════════════════════════════════════════════════════════════════════

  ┌──────────────────┐         ┌──────────────────┐
  │   TRADING-037    │         │   TRADING-036    │
  │  入力検証         │─ ─ ─ ─ ─▶│ パフォーマンス   │
  │     (P2)         │ 先に     │  最適化 (P2)     │
  └──────────────────┘         └────────┬─────────┘
                                        │
                                        ▼
                              ┌──────────────────┐
                              │   TRADING-038    │
                              │  アーキテクチャ  │
                              │   リファクタ     │
                              │     (P2)         │
                              └──────────────────┘
```

### 依存関係の説明

| 依存元 | 依存先 | 理由 |
|--------|--------|------|
| TRADING-030 | TRADING-029 | ゼロ除算修正後にエグジットロジックを修正 |
| TRADING-031 | TRADING-032 | 手数料とスリッページは一緒に標準化すべき |
| TRADING-033 | TRADING-034 | PnL計算を修正してから日次MTMを実装 |
| TRADING-034 | TRADING-035 | MTM基盤がないと機会コストを計算できない |
| TRADING-037 | TRADING-036 | 入力検証を先に実装して無効なデータによるパフォーマンス問題を防止 |
| TRADING-036 | TRADING-038 | パフォーマンス問題を解決してからアーキテクチャをリファクタ |

---

## 5. 実装ロードマップ (Implementation Roadmap)

### Phase 1: 緊急修正 (Week 1)

#### 目標
- クリティカルバグ（P0）の即時修正
- バックテストシステムの基本機能の復旧
- ホットフィックスの本番適用

#### タスク一覧

| Issue | タスク | 担当 | 工数 | ステータス |
|-------|--------|------|------|------------|
| TRADING-029 | エグジット取引バグホットフィックス | バックエンドリード | 8h | 未着手 |
| TRADING-030 | ゼロ除算防止の実装 | バックエンドリード | 8h | 未着手 |
| TRADING-031 | 統一手数料計算モジュール作成 | バックエンドエンジニア | 16h | 未着手 |
| TRADING-032 | 統一スリッページ計算モジュール作成 | バックエンドエンジニア | 12h | 未着手 |

#### Phase 1 の成功基準

- [ ] すべてのP0問題が修正される
- [ ] 既存のバックテストがエラーなく完了する
- [ ] エグジット取引が正しく実行される
- [ ] ゼロ除算エラーが発生しない
- [ ] 手数料/スリッページ計算が全エンジンで一貫している
- [ ] ユニットテストカバレッジ > 80%

### Phase 2: 精度改善 (Week 2-3)

#### 目標
- バックテスト精度の向上
- リスクメトリクスの正確化
- 日次パフォーマンス追跡の実装

#### タスク一覧

| Issue | タスク | 担当 | 工数 | ステータス |
|-------|--------|------|------|------------|
| TRADING-033 | PnL二重計上問題の修正 | バックエンドエンジニア | 12h | 未着手 |
| TRADING-034 | 日次マークトゥマーケット実装 | バックエンドエンジニア | 16h | 未着手 |
| TRADING-035 | 機会コスト計算実装 | バックエンドエンジニア | 20h | 未着手 |

#### Phase 2 の成功基準

- [ ] 損益計算の二重計上が解消される
- [ ] Equity Curve が実際の資産推移を正しく反映
- [ ] 日次リターン計算が可能になる
- [ ] 機会コストが取引コストに含まれる
- [ ] バックテスト精度が期待値の5%以内に収まる

### Phase 3: パフォーマンス・アーキテクチャ (Week 4-6)

#### 目標
- パフォーマンスの最適化
- 入力検証の実装
- コードベースのリファクタリング

#### タスク一覧

| Issue | タスク | 担当 | 工数 | ステータス |
|-------|--------|------|------|------------|
| TRADING-036 | O(n²)複雑性の解消 | バックエンドエンジニア | 24h | 未着手 |
| TRADING-037 | Zodによる入力検証実装 | フロント+バックエンド | 12h | 未着手 |
| TRADING-038 | SRPベースリファクタリング | アーキテクト+エンジニア | 40h | 未着手 |

#### Phase 3 の成功基準

- [ ] 10,000データポイントのバックテストが30秒以内に完了
- [ ] メモリ使用量が50%削減される
- [ ] すべての入力に対して検証が行われる
- [ ] コードカバレッジが80%以上
- [ ] 循環的複雑度が大幅に低下

---

## 6. テスト戦略 (Testing Strategy)

### Phase 1 テスト要件

#### ユニットテスト

| テスト対象 | テストケース数 | 優先度 |
|-----------|---------------|--------|
| エグジット取引ロジック | 10件 | Critical |
| ポジションサイジング | 15件（エッジケース含む） | Critical |
| 手数料計算モジュール | 20件（各タイプ×エッジケース） | Critical |
| スリッページ計算モジュール | 15件 | Critical |

```typescript
// エグジット取引テスト例
describe('Exit Trade Execution', () => {
  it('should correctly exit LONG position', () => {
    const position = createLongPosition(100, 10);
    const result = executeExit(position, 110, 'EXIT_LONG');
    expect(result.success).toBe(true);
    expect(result.newPosition).toBeNull();
    expect(result.profitPercent).toBeCloseTo(10, 2);
  });

  it('should handle exit when currentPosition is null', () => {
    const result = executeExit(null, 100, 'EXIT_LONG');
    expect(result.success).toBe(false);
  });
});
```

#### 統合テスト

| シナリオ | 説明 | データセット |
|---------|------|------------|
| 完全なバックテストフロー | エントリー→ホールド→エグジット | 1銘柄×30日分 |
| 複数ポジション管理 | 同時保有ポジションの追跡 | 3銘柄×60日分 |
| 手数料一貫性 | 全エンジンでの同じ結果 | 5銘柄×30日分 |

#### リグレッションテスト

- 既存の成功バックテスト100件の再実行
- 結果の差分比較（許容誤差：0.1%）
- パフォーマンスベンチマークとの比較

### Phase 2 テスト要件

#### ユニットテスト

| テスト対象 | テストケース数 | 優先度 |
|-----------|---------------|--------|
| PnL計算（確定・未確定の分離） | 12件 | High |
| 日次MTM計算 | 10件 | High |
| 機会コスト計算 | 12件 | High |

#### 統合テスト

| シナリオ | 説明 | 検証ポイント |
|---------|------|-------------|
| 日次資産推移 | 毎日の資産価値記録 | 終日データの整合性 |
| ドローダウン正確性 | 最大ドローダウン計算 | ピークからの下落率 |
| 機会コスト影響 | 高頻度取引でのコスト | スキャルピング戦略 |

### Phase 3 テスト要件

#### パフォーマンステスト

| メトリクス | 目標値 | テスト方法 |
|-----------|--------|-----------|
| 処理時間 | < 30秒（10,000ポイント） | ベンチマークスイート |
| メモリ使用量 | < 500MB | ヒーププロファイリング |
| スループット | > 1,000 candles/秒 | 負荷テスト |

#### 安全性テスト

| テスト対象 | テストケース | 期待結果 |
|-----------|-------------|---------|
| 入力検証 | 負の初期資本 | エラーメッセージ |
| 入力検証 | 無効な日付範囲 | エラーメッセージ |
| 入力検証 | 極端な手数料値 | バリデーションエラー |

### バリデーション基準

#### Phase 1 完了基準

```yaml
exit_position_bug_fixed:
  - エグジット取引が正しく実行される
  - ポジションが正しくクローズされる
  - 損益が正しく計算される

division_by_zero_prevented:
  - stopLoss = entryPrice の場合でもクラッシュしない
  - 最小ストップロス距離が保証される
  - ポジションサイズに上限が設けられる

commission_consistency_achieved:
  - 全エンジンで同じ手数料計算結果
  - エントリー/エグジット両方で一貫性
  - テストカバレッジ > 90%
```

#### Phase 2 完了基準

```yaml
pnl_calculation_fixed:
  - 確定損益と未確定損益が明確に分離
  - 二重計上が発生しない
  - Equity Curve が正確

daily_mtm_implemented:
  - 日次の資産評価が記録される
  - 日次リターン計算が可能
  - 月末レポート生成が可能

opportunity_cost_included:
  - 注文遅延コストが計算される
  - 部分的約定コストが計算される
  - 総取引コストに含まれる
```

#### Phase 3 完了基準

```yaml
performance_optimized:
  - O(n²) ループが O(n) に変更
  - メモリコピーが最小化される
  - ベンチマーク目標達成

input_validation_implemented:
  - すべての入力パラメータが検証される
  - Zodスキーマが定義される
  - エラーメッセージがユーザーフレンドリー

architecture_refactored:
  - SRPが遵守される
  - コンポーネント間の結合が疎になる
  - テスト容易性が向上
```

---

## 7. リスクアセスメント (Risk Assessment)

### 問題未修正時のリスク

#### 致命的リスク

| リスク | 確率 | 影響 | 説明 |
|--------|------|------|------|
| **バックテスト結果の完全無効化** | 高 | 致命的 | TRADING-029により、すべてのエグジット取引が記録されない |
| **システムクラッシュ** | 中 | 致命的 | TRADING-030により、ゼロ除算でランタイムエラー |
| **誤った戦略選択** | 高 | 重大 | 手数料/スリッページの不整合で収益性が誤算 |

#### ビジネスリスク

```
┌────────────────────────────────────────────────────────────────────┐
│                     ビジネスリスクマトリックス                      │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  リスク                           確率      影響      リスクスコア  │
│  ───────────────────────────────────────────────────────────────  │
│  バックテスト精度30-50%低下         高        重大        高        │
│  偽陽性戦略の本番展開               高        致命的      極高      │
│  ユーザー信頼の喪失                 中        重大        高        │
│  規制コンプライアンス違反           低        重大        中        │
│  競合他社との差別化劣化             中        中          中        │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

#### 技術的リスク

| リスク | 説明 | 発生確率 |
|--------|------|---------|
| **データ整合性の喪失** | 誤った計算結果がデータベースに保存される | 高 |
| **メモリリーク** | 永続的なポジションオブジェクトの蓄積 | 中 |
| **スケーラビリティ制限** | O(n²)複雑性で大規模データ処理が不可能 | 確実 |
| **保守性の低下** | 神クラスによる修正の困難さ | 確実 |

#### リスク軽減策

| リスク | 軽減策 | 実装フェーズ |
|--------|--------|-------------|
| 誤った戦略選択 | P0問題の即時修正 | Phase 1 |
| データ整合性損失 | 入力検証の実装 | Phase 3 |
| スケーラビリティ制限 | パフォーマンス最適化 | Phase 3 |
| 保守性低下 | アーキテクチャリファクタ | Phase 3 |

### 対応しない場合の影響

#### 短期的影響（1-3ヶ月）

- ユーザーからのエラーレポート増加
- サポートチームの負荷増大
- バックテスト機能の使用停止

#### 中期的影響（3-6ヶ月）

- プラットフォームの評価低下
- 競合他社との差別化要因喪失
- 有料ユーザーからの解約

#### 長期的影響（6-12ヶ月）

- ブランドイメージの毀損
- 新規ユーザー獲得の困難
- 規制当局からの指摘リスク

---

## 8. 成功指標 (Success Metrics)

### 主要成果指標 (KPI)

#### 品質メトリクス

| メトリクス | 現在値 | 目標値 | 測定方法 |
|-----------|--------|--------|---------|
| **バックテスト精度** | < 50% | > 95% | 既知の結果との比較 |
| **テストカバレッジ** | ~40% | > 80% | コードカバレッジレポート |
| **エラー率** | > 10% | < 0.1% | エラーログ分析 |
| **パフォーマンス** | 分単位 | < 30秒 | ベンチマークスイート |

#### ビジネスメトリクス

| メトリクス | 現在値 | 目標値 | 測定方法 |
|-----------|--------|--------|---------|
| **ユーザー信頼度** | 低 | 高 | NPSスコア調査 |
| **バックテスト完了率** | ~70% | > 99% | 分析ログ |
| **サポートチケット数** | 多い | 80%減 | サポートシステム |

### 成果定義

#### P0問題解決基準

```yaml
trading_029_resolved:
  criteria:
    - エグジット取引が正しく実行されること
    - 100%のテストケースで成功
  measurement: |
    既存バックテストスイート100件の全成功
    新規エグジット特化テスト10件の成功

trading_030_resolved:
  criteria:
    - ゼロ除算エラーが発生しないこと
    - 極端な入力でも正常動作
  measurement: |
    ストップロス距離ゼロのケースで例外なし
    無限大ポジションサイズが生成されない

trading_031_resolved:
  criteria:
    - 全エンジンで同一の手数料計算
    - エントリー/エグジットの一貫性
  measurement: |
    同一パラメータで全エンジンの結果差分 < 0.01%
    ユニットテストカバレッジ > 90%

trading_032_resolved:
  criteria:
    - 全エンジンで同一のスリッページ計算
    - 方向性の一貫性
  measurement: |
    同一パラメータで全エンジンの結果差分 < 0.01%
    買い/売り両方向のテスト完了
```

#### 全体の成功基準

```yaml
overall_success:
  p0_issues: すべて解決
  p1_issues: 80%以上解決
  p2_issues: 計画通り進行
  
  backtest_accuracy: |
    既知のテストケースにおいて、
    期待値との差分が5%以内
    
  performance_targets: |
    10,000データポイント: < 30秒
    50,000データポイント: < 2分
    メモリ使用量: < 500MB
    
  test_coverage: |
    コードカバレッジ: > 80%
    分岐カバレッジ: > 70%
    統合テスト: すべてパス
```

### 測定スケジュール

| フェーズ | 測定タイミング | 測定内容 |
|---------|---------------|---------|
| Phase 1 | 毎日 | P0問題の修正進捗、ユニットテスト成功率 |
| Phase 1終了 | 週末 | 統合テスト、リグレッションテスト |
| Phase 2 | 毎週 | 精度向上の定量化、メトリクス比較 |
| Phase 2終了 | 2週目終了 | 包括的精度テスト、ユーザーテスト |
| Phase 3 | 毎週 | パフォーマンスベンチマーク、カバレッジ |
| Phase 3終了 | 6週目終了 | 最終検証、ドキュメント更新 |

---

## 9. 付録

### Appendix A: 関連Issue一覧

| Issue ID | タイトル | ステータス | リンク |
|----------|---------|-----------|--------|
| TRADING-029 | バックテストのエグジット取引でポジション参照エラー | Open | [リンク](.github/issues/TRADING-029-backtest-exit-position-bug.md) |
| TRADING-030 | ポジションサイズ計算におけるゼロ除算バグ | Open | [リンク](.github/issues/TRADING-030-position-sizing-division-bug.md) |
| TRADING-031 | 手数料計算ロジックのコンポーネント間不整合 | Open | [リンク](.github/issues/TRADING-031-commission-calculation-inconsistency.md) |
| TRADING-032 | スリッページ計算のコンポーネント間不整合 | Open | [リンク](.github/issues/TRADING-032-slippage-calculation-inconsistency.md) |
| TRADING-033 | 損益計算における二重計上の問題 | Open | [リンク](.github/issues/TRADING-033-pnl-double-counting.md) |
| TRADING-034 | デイリーマークトゥマーケット機能の未実装 | Open | [リンク](.github/issues/TRADING-034-mark-to-market-missing.md) |
| TRADING-035 | 機会コスト計算の未実装 | Open | [リンク](.github/issues/TRADING-035-opportunity-cost-missing.md) |
| TRADING-036 | バックテストエンジンのパフォーマンス問題 | Open | [リンク](.github/issues/TRADING-036-backtest-performance-issues.md) |
| TRADING-037 | バックテストパラメータの入力検証欠如 | Open | [リンク](.github/issues/TRADING-037-input-validation-missing.md) |
| TRADING-038 | バックテストサービスの単一責任原則違反 | Open | [リンク](.github/issues/TRADING-038-architectural-refactoring-needed.md) |

### Appendix B: リソース配分

| ロール | Phase 1 | Phase 2 | Phase 3 | 全体 |
|--------|---------|---------|---------|------|
| バックエンドリードエンジニア | 24h | 8h | 4h | 36h |
| バックエンドエンジニア | 12h | 40h | 48h | 100h |
| アーキテクト | 4h | 4h | 16h | 24h |
| QAエンジニア | 8h | 12h | 12h | 32h |
| フロントエンドエンジニア | 0h | 0h | 8h | 8h |
| **合計** | **48h** | **64h** | **88h** | **200h** |

### Appendix C: 用語集

| 用語 | 定義 |
|------|------|
| **バックテスト** | 過去の市場データを使用して取引戦略を検証する手法 |
| **エグジット** | 保有ポジションを解消（クローズ）すること |
| **マークトゥマーケット** | 時価評価。日次の資産価値を評価すること |
| **機会コスト** | 注文から実行までの遅延や部分的約定による追加コスト |
| **スリッページ** | 注文価格と実際の執行価格の差 |
| **PnL** | Profit and Loss（損益） |
| **SRP** | Single Responsibility Principle（単一責任原則） |

---

**ドキュメント管理**

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|---------|--------|
| 1.0 | 2026-02-02 | 初版作成 | 未承認 |

**次回レビュー予定**: 2026-02-09
