# Gitブランチマージガイド

このガイドは、Ultプロジェクトのすべてのリモートブランチを安全にmainブランチにマージするための詳細な手順を提供します。

## 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [マージ戦略](#マージ戦略)
4. [自動マージスクリプトの使用](#自動マージスクリプトの使用)
5. [手動マージ手順](#手動マージ手順)
6. [トラブルシューティング](#トラブルシューティング)
7. [ベストプラクティス](#ベストプラクティス)

## 概要

このプロジェクトには多数の機能ブランチ、修正ブランチ、最適化ブランチが存在します。これらを安全にmainブランチに統合する必要があります。

### ブランチのカテゴリ

- **高優先度修正ブランチ**: バグ修正、ビルドエラーの修正
- **中優先度リファクタリング**: コード品質の改善、型安全性の向上
- **機能ブランチ**: 新機能の実装
- **パフォーマンスブランチ**: パフォーマンス最適化
- **セキュリティブランチ**: セキュリティ強化
- **アクセシビリティブランチ**: アクセシビリティ改善

## 前提条件

### 必要なツール

- Git (最新バージョン)
- Node.js と npm (ビルドとテスト用)
- GitHub CLI (gh) - オプション

### 作業前の確認

```bash
# Gitのバージョン確認
git --version

# Node.jsのバージョン確認
node --version
npm --version

# GitHub CLIのバージョン確認（オプション）
gh --version
```

## マージ戦略

### マージの優先順位

1. **高優先度修正ブランチ** - これらを最初にマージ
   - バグ修正
   - ビルドエラーの修正
   - テストの修正

2. **中優先度リファクタリング** - コード品質の改善
   - 型安全性の向上
   - コードの整理
   - マジックナンバーの削除

3. **機能ブランチ** - 新機能の実装
   - MVP機能
   - AI予測機能
   - トレーディング機能

4. **パフォーマンスブランチ** - パフォーマンス最適化
   - レンダリング最適化
   - メモリリークの修正

5. **セキュリティブランチ** - セキュリティ強化
   - APIキーの保護
   - レート制限

6. **アクセシビリティブランチ** - アクセシビリティ改善
   - ARIA属性の追加
   - モバイル対応

### マージ方法

- **マージコミットを使用**: `--no-ff` フラグを使用してマージコミットを作成
- **コンフリクトの解決**: 手動でコンフリクトを解決
- **ビルドとテスト**: 各マージ後にビルドとテストを実行

## 自動マージスクリプトの使用

### Bashスクリプト (Linux/Mac/WSL)

```bash
# スクリプトに実行権限を付与
chmod +x scripts/merge-all-branches.sh

# スクリプトを実行
./scripts/merge-all-branches.sh

# テストをスキップして実行
SKIP_TESTS=true ./scripts/merge-all-branches.sh
```

### PowerShellスクリプト (Windows)

```powershell
# PowerShellスクリプトを実行
.\scripts\merge-all-branches.ps1

# テストをスキップして実行
$SkipTests = $true; .\scripts\merge-all-branches.ps1
```

### スクリプトの機能

1. **自動ブランチ検出**: リモートブランチの存在を確認
2. **安全なマージ**: `--no-ff` フラグを使用
3. **コンフリクト検出**: コンフリクトが発生した場合に対話的な処理
4. **ビルドとテスト**: 各マージ後に自動でビルドとテストを実行
5. **結果レポート**: マージ結果のサマリーを表示

## 手動マージ手順

自動スクリプトを使用しない場合の手動マージ手順です。

### 1. 準備

```bash
# mainブランチに切り替え
git checkout main

# 最新の状態に更新
git pull origin main

# 作業ディレクトリをクリーンにする
git status
```

### 2. ブランチのマージ

```bash
# ブランチをマージ
git merge --no-ff origin/fix/ci-lint-errors

# コンフリクトがある場合
# コンフリクトファイルを編集して解決
# 解決したファイルをステージング
git add <解決したファイル>

# マージをコミット
git commit -m "マージ: origin/fix/ci-lint-errors をmainにマージ"
```

### 3. ビルドとテスト

```bash
# ビルド
npm run build

# テスト
npm test

# ビルドまたはテストが失敗した場合
git merge --abort
# コンフリクトを解決して再試行
```

### 4. 次のブランチをマージ

```bash
# 次のブランチをマージ
git merge --no-ff origin/fix/build-and-lint-errors

# 同じ手順を繰り返す
```

## トラブルシューティング

### コンフリクトの解決

#### コンフリクトの種類

1. **同じ行の変更**: 2つのブランチが同じ行を異なる方法で変更
2. **ファイルの削除と変更**: 1つのブランチがファイルを削除し、別のブランチが変更
3. **リネームと変更**: ファイルのリネームと変更が競合

#### コンフリクトの解決手順

```bash
# コンフリクトが発生したファイルを確認
git status

# コンフリクトマーカーを含むファイルを編集
# <<<<<<< HEAD
# ローカルの変更
# =======
# リモートの変更
# >>>>>>> branch-name

# 適切な変更を選択または統合

# 解決したファイルをステージング
git add <解決したファイル>

# マージを完了
git commit
```

#### コンフリクト解決のヒント

- **両方の変更を統合**: 可能な場合は両方の変更を統合
- **最新の変更を優先**: 最近の変更を優先する場合がある
- **機能の優先順位**: 重要な機能の変更を優先
- **チームと相談**: 不明な場合はチームメンバーと相談

### ビルドエラー

#### 一般的なビルドエラー

1. **TypeScriptエラー**: 型エラー、未定義の変数
2. **依存関係の問題**: パッケージのバージョン不一致
3. **構文エラー**: コードの構文ミス

#### 解決方法

```bash
# TypeScriptエラーを確認
npm run type-check

# 依存関係を更新
npm install

# キャッシュをクリア
npm run clean
rm -rf node_modules package-lock.json
npm install
```

### テストエラー

#### 一般的なテストエラー

1. **アサーションエラー**: 期待値と実際の値が一致しない
2. **タイムアウトエラー**: テストが時間内に完了しない
3. **環境設定エラー**: テスト環境の設定ミス

#### 解決方法

```bash
# 特定のテストを実行
npm test -- --testNamePattern="テスト名"

# デバッグモードでテストを実行
npm test -- --debug

# カバレッジレポートを確認
npm test -- --coverage
```

### マージの中止

```bash
# マージを中止して元の状態に戻す
git merge --abort

# 直前のコミットを取り消す
git reset --hard HEAD~1

# 特定のコミットを取り消す
git reset --hard <commit-hash>
```

### 履歴の確認

```bash
# マージ履歴を確認
git log --graph --oneline --all

# 特定のブランチの履歴を確認
git log origin/fix/ci-lint-errors --oneline

# ファイルの変更履歴を確認
git log --follow -- <file-path>
```

## ベストプラクティス

### マージ前のチェックリスト

- [ ] mainブランチが最新である
- [ ] 作業ディレクトリがクリーンである
- [ ] マージするブランチが最新である
- [ ] ビルドが成功する
- [ ] テストがパスする

### マージ中のチェックリスト

- [ ] コンフリクトを適切に解決する
- [ ] マージコミットに明確なメッセージを付ける
- [ ] ビルドとテストを実行する
- [ ] 変更を確認する

### マージ後のチェックリスト

- [ ] 変更をリモートにプッシュする
- [ ] CI/CDパイプラインが成功する
- [ ] チームメンバーに通知する
- [ ] ドキュメントを更新する

### コミットメッセージの規約

```
マージ: <ブランチ名> をmainにマージ

- 主要な変更点
- 影響範囲
- 関連するIssue/PR番号
```

例:
```
マージ: origin/fix/ci-lint-errors をmainにマージ

- ESLintエラーを修正
- TypeScript型エラーを解決
- 関連: #123
```

### ブランチの命名規約

- `fix/`: バグ修正
- `feature/`: 新機能
- `refactor/`: リファクタリング
- `perf/`: パフォーマンス最適化
- `security/`: セキュリティ強化
- `test/`: テスト関連

### 定期的なマージ

- **週次マージ**: 毎週金曜日にマージを実施
- **リリース前マージ**: リリース前にすべてのブランチをマージ
- **緊急マージ**: 緊急の修正は即座にマージ

## 付録

### 有用なGitコマンド

```bash
# ブランチの一覧を表示
git branch -a

# リモートブランチの詳細を表示
git show-branch

# マージベースを確認
git merge-base main origin/fix/ci-lint-errors

# 変更の統計を表示
git diff --stat main origin/fix/ci-lint-errors

# コンフリクトファイルを検索
git diff --name-only --diff-filter=U
```

### 参考リソース

- [Git公式ドキュメント](https://git-scm.com/doc)
- [GitHubマージのベストプラクティス](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/merging-a-pull-request)
- [Pro Git書籍](https://git-scm.com/book/ja/v2)

## サポート

問題が発生した場合は、以下のリソースを参照してください:

1. **チームメンバーに相談**: 不明な点はチームメンバーに相談
2. **Issueを作成**: GitHub Issueを作成して問題を報告
3. **ドキュメントを確認**: プロジェクトのドキュメントを確認
4. **ログを確認**: Gitログ、ビルドログ、テストログを確認

---

このガイドは、UltプロジェクトのGitブランチマージプロセスを支援するために作成されました。定期的に更新して、最新の情報を提供します。
